<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assets Bulk Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script defer type="text/javascript" src="https://rum.hlx.page/.rum/@adobe/helix-rum-js@^2/dist/rum-standalone.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    }
                }
            }
        }
    </script>
    <style>
        .loader {
            border-top-color: #5D5CDE;
            animation: spinner 1s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Dark mode support */
        .dark body {
            color-scheme: dark;
        }
        .dark .notification {
            @apply bg-gray-800 text-white;
        }
        .tab-active {
            @apply bg-primary text-white font-bold shadow-md relative;
        }
        .tab-active::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 8px;
            background-color: white;
            border-radius: 50%;
        }
        .tab-inactive {
            @apply bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors;
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">
    <!-- Check for dark mode -->
    <script>
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>

    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <h1 class="text-3xl font-bold text-center mb-8">Assets Bulk Tool</h1>
        
        <!-- Authentication Section -->
        <div class="mb-8 bg-white dark:bg-gray-800 rounded-lg shadow-md">
            <div class="p-4 flex justify-between items-center cursor-pointer" id="authHeader" aria-expanded="true" aria-controls="authPanel">
                <h2 class="text-xl font-semibold">Authentication</h2>
                <div class="auth-toggle-icon transition-transform duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
            </div>
            
            <div id="authPanel" class="px-6 pb-6 overflow-hidden transition-all duration-300 max-h-0 opacity-0">
                <div class="mb-4">
                    <div class="flex flex-col md:flex-row gap-4 mb-4">
                        <div class="flex-1">
                            <label for="aemHost" class="block text-sm font-medium mb-1">AEM Host</label>
                            <input type="text" id="aemHost" placeholder="http://localhost:4502" 
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base
                                focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent
                                dark:bg-gray-700 dark:text-white" />
                        </div>
                        <div class="flex-1">
                            <label for="username" class="block text-sm font-medium mb-1">Username</label>
                            <input type="text" id="username" placeholder="admin" 
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base
                                focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent
                                dark:bg-gray-700 dark:text-white" />
                        </div>
                        <div class="flex-1">
                            <label for="password" class="block text-sm font-medium mb-1">Password</label>
                            <input type="password" id="password" placeholder="********" 
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base
                                focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent
                                dark:bg-gray-700 dark:text-white" />
                        </div>
                    </div>
                    
                    <div class="flex flex-col md:flex-row items-center gap-4">
                        <button id="basicAuthBtn" class="px-4 py-2 bg-primary dark:bg-primary text-white rounded-md hover:bg-opacity-90 transition-colors">
                            Login with Basic Auth
                        </button>
                        <span class="text-sm text-gray-500 dark:text-gray-400">or</span>
                        <button id="imsAuthBtn" class="px-4 py-2 bg-[#FA0F00] text-white rounded-md hover:bg-opacity-90 transition-colors">
                            Login with Adobe IMS
                        </button>
                    </div>
                    
                    <div class="mt-6 border-t border-gray-200 dark:border-gray-700 pt-4">
                        <h3 class="text-sm font-semibold mb-2">Manual Token Entry (For Testing)</h3>
                        <div id="imsTokenSection">
                            <label for="imsToken" class="block text-sm font-medium mb-1">IMS Access Token</label>
                            <textarea id="imsToken" rows="2" placeholder="Paste your IMS token here for testing or if automatic detection fails"
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base
                                focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent
                                dark:bg-gray-700 dark:text-white"></textarea>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                Note: Bearer token authentication will be used automatically if a token is provided here.
                            </p>
                            <button id="testTokenBtn" class="mt-2 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-sm rounded-md hover:bg-opacity-90 transition-colors">
                                Validate Token
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="authStatus" class="hidden mt-4 p-3 rounded-md border">
                    <!-- Will be populated dynamically with authentication status -->
                </div>
            </div>
        </div>
        
        <!-- Tab Navigation -->
        <div class="mb-1">
            <h2 class="text-base font-medium text-gray-600 dark:text-gray-400 mb-2">Current Mode: <span id="currentTabLabel" class="font-bold text-primary">Asset Renamer</span></h2>
        </div>
        <div class="mb-6 flex space-x-1 rounded-lg bg-gray-100 dark:bg-gray-800 p-1 overflow-hidden">
            <button class="tab-button py-2 px-4 rounded-md tab-active" data-tab="rename" data-label="Asset Renamer">Asset Renamer</button>
            <button class="tab-button py-2 px-4 rounded-md tab-inactive" data-tab="metadata" data-label="Metadata Updater">Metadata Updater</button>
            <button class="tab-button py-2 px-4 rounded-md tab-inactive" data-tab="delete" data-label="Bulk Delete">Bulk Delete</button>
            <button class="tab-button py-2 px-4 rounded-md tab-inactive" data-tab="search" data-label="Bulk Search">Bulk Search</button>
        </div>
        
        <!-- File Input Section -->
        <div class="mb-8 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">Excel File Import</h2>
            
            <div class="mb-4">
                <label for="fileInput" class="block text-sm font-medium mb-1">Upload Excel File</label>
                <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" 
                    class="w-full text-base
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-md file:border-0
                    file:text-sm file:font-semibold
                    file:bg-primary file:text-white
                    hover:file:bg-opacity-90" />
            </div>
            
            <div id="fileProcessingStatus" class="my-3 py-2 px-3 bg-blue-50 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 rounded hidden">
                Processing file...
            </div>
            
            <div class="flex flex-col md:flex-row gap-4">
                <div id="sheetSelection" class="hidden flex-1">
                    <label for="sheetSelect" class="block text-sm font-medium mb-1">Select Sheet</label>
                    <select id="sheetSelect" 
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base
                        focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent
                        dark:bg-gray-700 dark:text-white">
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
                
                <div id="assetPathColumnSelection" class="hidden flex-1">
                    <label for="assetPathColumnSelect" class="block text-sm font-medium mb-1">Select Asset Path Column</label>
                    <select id="assetPathColumnSelect" 
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base
                        focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent
                        dark:bg-gray-700 dark:text-white">
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
            </div>
            
            <div id="excelPreview" class="mt-4 hidden">
                <h3 class="text-md font-medium mb-2">Excel File Preview</h3>
                <div class="overflow-x-auto max-h-[200px] border border-gray-300 dark:border-gray-600 rounded">
                    <table class="min-w-full divide-y divide-gray-300 dark:divide-gray-600">
                        <thead id="previewTableHead" class="bg-gray-100 dark:bg-gray-700">
                            <!-- Will be populated dynamically -->
                        </thead>
                        <tbody id="previewTableBody" class="divide-y divide-gray-200 dark:divide-gray-700 bg-white dark:bg-gray-800">
                            <!-- Will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Rename Configuration Section -->
        <div id="renameConfigSection" class="tab-content mb-8 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md hidden">
            <h2 class="text-xl font-semibold mb-4">Renaming Configuration</h2>
            
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Characters to Process</label>
                <div class="flex flex-wrap gap-3">
                    <label class="inline-flex items-center">
                        <input type="checkbox" checked class="char-checkbox form-checkbox h-5 w-5 text-primary" data-char="_">
                        <span class="ml-2">Underscore (_)</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="checkbox" class="char-checkbox form-checkbox h-5 w-5 text-primary" data-char=" ">
                        <span class="ml-2">Space ( )</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="checkbox" class="char-checkbox form-checkbox h-5 w-5 text-primary" data-char="-">
                        <span class="ml-2">Hyphen (-)</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="checkbox" class="char-checkbox form-checkbox h-5 w-5 text-primary" data-char=".">
                        <span class="ml-2">Period (.)</span>
                    </label>
                </div>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Action</label>
                <div class="flex gap-4">
                    <label class="inline-flex items-center">
                        <input type="radio" name="action" value="replace" checked 
                            class="form-radio h-5 w-5 text-primary">
                        <span class="ml-2">Replace with:</span>
                    </label>
                    <input type="text" id="replaceWith" value="-" placeholder="Replacement character" 
                        class="w-24 px-3 py-1 border border-gray-300 dark:border-gray-600 rounded-md text-base
                        focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent
                        dark:bg-gray-700 dark:text-white" />
                        
                    <label class="inline-flex items-center">
                        <input type="radio" name="action" value="remove" 
                            class="form-radio h-5 w-5 text-primary">
                        <span class="ml-2">Remove completely</span>
                    </label>
                </div>
            </div>
            
            <div class="mb-4">
                <button id="renamePreviewBtn" 
                    class="px-4 py-2 bg-primary text-white rounded-md hover:bg-opacity-90 transition-colors">
                    Preview Changes (Dry Run)
                </button>
            </div>
        </div>
        
        <!-- Metadata Configuration Section -->
        <div id="metadataConfigSection" class="tab-content mb-8 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md hidden">
            <h2 class="text-xl font-semibold mb-4">Metadata Configuration</h2>
            
            <div id="metadataMappingContainer" class="mb-6">
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-sm font-medium">Metadata Property Mappings</label>
                    <button id="addMappingBtn" class="text-primary hover:underline flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                        Add Property
                    </button>
                </div>
                
                <div id="mappingsContainer" class="space-y-3">
                    <!-- Initial mapping row -->
                    <div class="mapping-row flex flex-col md:flex-row gap-3 items-start md:items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-md">
                        <div class="flex-1">
                            <label class="block text-sm mb-1 text-gray-600 dark:text-gray-300">Property Name</label>
                            <input type="text" placeholder="dc:title" class="property-name w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-800 dark:text-white" value="dc:title" />
                        </div>
                        <div class="flex-1">
                            <label class="block text-sm mb-1 text-gray-600 dark:text-gray-300">Value Column</label>
                            <select class="value-column w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-800 dark:text-white">
                                <option value="">Select column</option>
                                <!-- Options will be populated dynamically -->
                            </select>
                        </div>
                        <div class="flex items-end justify-end h-full pt-6 md:pt-0">
                            <button class="remove-mapping p-1 text-red-500 hover:text-red-700 rounded-full hover:bg-red-100 dark:hover:bg-red-900">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                    <p>Common properties: dc:title, dc:description, jcr:lastModified, cq:tags</p>
                </div>
            </div>
            
            <div class="mb-4">
                <button id="metadataPreviewBtn" 
                    class="px-4 py-2 bg-primary text-white rounded-md hover:bg-opacity-90 transition-colors">
                    Preview Changes (Dry Run)
                </button>
            </div>
        </div>
        
        <!-- Delete Configuration Section -->
        <div id="deleteConfigSection" class="tab-content mb-8 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md hidden">
            <h2 class="text-xl font-semibold mb-4">Bulk Delete Configuration</h2>
            
            <div class="mb-6">
                <div class="p-3 bg-yellow-50 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-200 rounded-md border border-yellow-200 dark:border-yellow-700">
                    <div class="flex items-start">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mt-0.5 mr-2 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                        <div>
                            <p class="font-medium">Warning: Delete operations cannot be undone</p>
                            <p class="mt-1 text-sm">Assets will be permanently deleted and cannot be recovered unless you have a backup.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mb-4">
                <button id="deletePreviewBtn" 
                    class="px-4 py-2 bg-primary text-white rounded-md hover:bg-opacity-90 transition-colors">
                    Preview Deletions (Dry Run)
                </button>
            </div>
        </div>
        
        <!-- Rename Preview Section -->
        <div id="renamePreviewSection" class="tab-content mb-8 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md hidden">
            <h2 class="text-xl font-semibold mb-4">Rename Preview</h2>
            
            <div class="mb-6 overflow-auto max-h-[400px]">
                <table class="min-w-full divide-y divide-gray-300 dark:divide-gray-600">
                    <thead class="bg-gray-100 dark:bg-gray-700">
                        <tr>
                            <th scope="col" class="py-3 px-4 text-left text-sm font-semibold sticky top-0 bg-gray-100 dark:bg-gray-700">
                                Original Path
                            </th>
                            <th scope="col" class="py-3 px-4 text-left text-sm font-semibold sticky top-0 bg-gray-100 dark:bg-gray-700">
                                New Path
                            </th>
                        </tr>
                    </thead>
                    <tbody id="renamePreviewTableBody" class="divide-y divide-gray-200 dark:divide-gray-700">
                        <!-- Preview rows will be added here -->
                    </tbody>
                </table>
            </div>
            
            <div class="flex gap-4">
                <button id="executeRenameBtn" 
                    class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-opacity-90 transition-colors">
                    Execute Renames
                </button>
                <div id="renameAuthRequiredNote" class="text-sm text-gray-500 dark:text-gray-400 mt-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="inline-block h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Note: Authentication is required before executing renames
                </div>
                <button id="cancelRenameBtn" 
                    class="px-4 py-2 bg-gray-500 dark:bg-gray-600 text-white rounded-md hover:bg-opacity-90 transition-colors">
                    Cancel
                </button>
            </div>
        </div>
        
        <!-- Metadata Preview Section -->
        <div id="metadataPreviewSection" class="tab-content mb-8 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md hidden">
            <h2 class="text-xl font-semibold mb-4">Metadata Update Preview</h2>
            
            <div class="mb-6 overflow-auto max-h-[400px]">
                <table class="min-w-full divide-y divide-gray-300 dark:divide-gray-600">
                    <thead class="bg-gray-100 dark:bg-gray-700">
                        <tr>
                            <th scope="col" class="py-3 px-4 text-left text-sm font-semibold sticky top-0 bg-gray-100 dark:bg-gray-700">
                                Asset Path
                            </th>
                            <th scope="col" class="py-3 px-4 text-left text-sm font-semibold sticky top-0 bg-gray-100 dark:bg-gray-700">
                                Metadata Updates
                            </th>
                        </tr>
                    </thead>
                    <tbody id="metadataPreviewTableBody" class="divide-y divide-gray-200 dark:divide-gray-700">
                        <!-- Preview rows will be added here -->
                    </tbody>
                </table>
            </div>
            
            <div class="flex gap-4">
                <button id="executeMetadataBtn" 
                    class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-opacity-90 transition-colors">
                    Execute Metadata Updates
                </button>
                <div id="metadataAuthRequiredNote" class="text-sm text-gray-500 dark:text-gray-400 mt-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="inline-block h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Note: Authentication is required before executing metadata updates
                </div>
                <button id="cancelMetadataBtn" 
                    class="px-4 py-2 bg-gray-500 dark:bg-gray-600 text-white rounded-md hover:bg-opacity-90 transition-colors">
                    Cancel
                </button>
            </div>
        </div>
        
        <!-- Search Configuration Section -->
        <div id="searchConfigSection" class="tab-content mb-8 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md hidden">
            <h2 class="text-xl font-semibold mb-4">Bulk Search Configuration</h2>
            
            <div class="mb-4">
                <label for="searchBasePath" class="block text-sm font-medium mb-1">Search Base Path (Optional)</label>
                <input type="text" id="searchBasePath" placeholder="/content/dam/your-project" 
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base
                    focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent
                    dark:bg-gray-700 dark:text-white" />
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                    Limit search to a specific path in the DAM. Leave empty to search everywhere.
                </p>
            </div>
            
            <div class="mb-4">
                <label for="searchResultsLimit" class="block text-sm font-medium mb-1">Results Limit</label>
                <input type="number" id="searchResultsLimit" min="1" max="1000" value="100"
                    class="w-full max-w-xs px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base
                    focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent
                    dark:bg-gray-700 dark:text-white" />
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                    Maximum number of results to return per SKU. (1-1000)
                </p>
            </div>
            
            <div class="mb-6">
                <label for="searchMetadataProperty" class="block text-sm font-medium mb-1">Metadata Property to Search</label>
                <div class="flex gap-2">
                    <select id="searchMetadataProperty" 
                        class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base
                        focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent
                        dark:bg-gray-700 dark:text-white">
                        <option value="jcr:content/metadata/dc:description">dc:description (Description)</option>
                        <option value="jcr:content/metadata/dc:title">dc:title (Title)</option>
                        <option value="jcr:content/metadata/dc:subject">dc:subject (Keywords)</option>
                        <option value="jcr:content/metadata/sku">sku (SKU Field)</option>
                        <option value="jcr:content/metadata/productId">productId (Product ID)</option>
                        <option value="jcr:content/metadata/partNumber">partNumber (Part Number)</option>
                        <option value="custom">Custom Property...</option>
                    </select>
                    <button type="button" id="addSearchPropertyBtn" class="px-3 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-md hover:bg-opacity-90 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                <input type="text" id="customSearchProperty" placeholder="e.g. jcr:content/metadata/customField" 
                    class="mt-2 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base
                    focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent
                    dark:bg-gray-700 dark:text-white hidden" />
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                    Specify which metadata property to search for your SKU/search terms.
                </p>
            </div>
            
            <div id="searchPropertiesList" class="mb-4 space-y-2 hidden">
                <label class="block text-sm font-medium mb-2">Search Properties</label>
                <div id="searchPropertiesContainer" class="space-y-2">
                    <!-- Search properties will be added here -->
                </div>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Additional Search Options</label>
                <div class="flex flex-wrap gap-3">
                    <label class="inline-flex items-center">
                        <input type="checkbox" id="searchInFilename" class="form-checkbox h-5 w-5 text-primary">
                        <span class="ml-2">Also search in filename</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="checkbox" id="searchInTags" class="form-checkbox h-5 w-5 text-primary">
                        <span class="ml-2">Also search in tags (cq:tags)</span>
                    </label>
                </div>
            </div>
            
            <div class="mb-4">
                <button id="searchPreviewBtn" 
                    class="px-4 py-2 bg-primary text-white rounded-md hover:bg-opacity-90 transition-colors">
                    Search for Assets
                </button>
            </div>
        </div>
        
        <!-- Search Results Section -->
        <div id="searchResultsSection" class="tab-content mb-8 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Search Results</h2>
                <div class="flex gap-2">
                    <div class="relative">
                        <input type="text" id="searchResultsFilter" placeholder="Filter results..." 
                            class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base
                            focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent
                            dark:bg-gray-700 dark:text-white pl-9" />
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-2 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                    <button id="downloadSelectedBtn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-opacity-90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        Download Selected
                    </button>
                </div>
            </div>
            
            <!-- Additional Filters -->
            <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="assetTypeFilter" class="block text-sm font-medium mb-1">Asset Type</label>
                    <select id="assetTypeFilter" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base
                        focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent
                        dark:bg-gray-700 dark:text-white">
                        <option value="">All Asset Types</option>
                        <option value="Product Imagery">Product Imagery</option>
                        <option value="Application Imagery">Application Imagery</option>
                        <option value="Line Art">Line Art</option>
                        <option value="Logos">Logos</option>
                        <option value="Video">Video</option>
                        <option value="CAD">CAD</option>
                        <option value="Social Media">Social Media</option>
                        <option value="PDF/Literature">PDF/Literature</option>
                        <option value="Documents">Documents</option>
                        <option value="Web Imagery">Web Imagery</option>
                        <option value="Event Imagery">Event Imagery</option>
                        <option value="Partnership Imagery">Partnership Imagery</option>
                    </select>
                </div>
                
                <div>
                    <label for="productShotFilter" class="block text-sm font-medium mb-1">Product Shot</label>
                    <select id="productShotFilter" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base
                        focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent
                        dark:bg-gray-700 dark:text-white">
                        <option value="">All Product Shots</option>
                        <option value="Product Silo">Product Silo</option>
                        <option value="Application Detail">Application Detail</option>
                        <option value="Product Silo Detail">Product Silo Detail</option>
                        <option value="Application">Application</option>
                        <option value="Web Banner">Web Banner</option>
                        <option value="Web Silo Backgrounds">Web Silo Backgrounds</option>
                    </select>
                </div>
                
                <div class="flex items-end">
                    <button id="clearFiltersBtn" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-md hover:bg-opacity-90 transition-colors">
                        Clear Filters
                    </button>
                </div>
            </div>
            
            <div class="mb-4 bg-blue-50 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 p-4 rounded flex items-start">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mt-0.5 mr-2 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <div>
                    <p><span id="selectedCount">0</span> of <span id="totalResultsCount">0</span> assets selected</p>
                    <p class="text-sm mt-1">Tip: Use the checkbox in the header to select all visible results</p>
                </div>
            </div>
            
            <div class="mb-6">
                <div class="flex items-center px-4 py-2 bg-gray-100 dark:bg-gray-700 rounded-t border-b border-gray-300 dark:border-gray-600">
                    <div class="w-7">
                        <input type="checkbox" id="selectAllCheckbox" class="form-checkbox h-5 w-5 text-primary rounded">
                    </div>
                    <div class="w-28">SKU</div>
                    <div class="flex-1">Asset</div>
                </div>
                
                <div id="searchResultsContainer" class="border border-gray-300 dark:border-gray-600 rounded-b max-h-[600px] overflow-y-auto">
                    <!-- Results will be populated here -->
                    <div class="py-20 text-center text-gray-500 dark:text-gray-400">
                        Search results will appear here
                    </div>
                </div>
            </div>
            
            <div class="flex gap-4">
                <button id="cancelSearchBtn" 
                    class="px-4 py-2 bg-gray-500 dark:bg-gray-600 text-white rounded-md hover:bg-opacity-90 transition-colors">
                    Back to Search
                </button>
            </div>
        </div>
        
        <!-- Delete Preview Section -->
        <div id="deletePreviewSection" class="tab-content mb-8 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md hidden">
            <h2 class="text-xl font-semibold mb-4">Delete Preview</h2>
            
            <div class="mb-6 overflow-auto max-h-[400px]">
                <table class="min-w-full divide-y divide-gray-300 dark:divide-gray-600">
                    <thead class="bg-gray-100 dark:bg-gray-700">
                        <tr>
                            <th scope="col" class="py-3 px-4 text-left text-sm font-semibold sticky top-0 bg-gray-100 dark:bg-gray-700">
                                Asset Path
                            </th>
                            <th scope="col" class="py-3 px-4 text-left text-sm font-semibold sticky top-0 bg-gray-100 dark:bg-gray-700">
                                Action
                            </th>
                        </tr>
                    </thead>
                    <tbody id="deletePreviewTableBody" class="divide-y divide-gray-200 dark:divide-gray-700">
                        <!-- Preview rows will be added here -->
                    </tbody>
                </table>
            </div>
            
            <div class="mb-4 p-3 bg-yellow-50 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-200 rounded-md border border-yellow-200 dark:border-yellow-700">
                <div class="flex items-start">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mt-0.5 mr-2 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    <div>
                        <p class="font-medium">Warning: Delete operations cannot be undone</p>
                        <p class="mt-1">Please verify all assets before proceeding. This action will permanently delete the assets and cannot be recovered.</p>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-4">
                <button id="executeDeleteBtn" 
                    class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-opacity-90 transition-colors">
                    Execute Deletions
                </button>
                <div id="deleteAuthRequiredNote" class="text-sm text-gray-500 dark:text-gray-400 mt-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="inline-block h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Note: Authentication is required before executing deletions
                </div>
                <button id="cancelDeleteBtn" 
                    class="px-4 py-2 bg-gray-500 dark:bg-gray-600 text-white rounded-md hover:bg-opacity-90 transition-colors">
                    Cancel
                </button>
            </div>
        </div>
        
        <!-- Results Section -->
        <div id="resultsSection" class="mb-8 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md hidden">
            <h2 class="text-xl font-semibold mb-4">Execution Results</h2>
            
            <div class="mb-4 flex items-center gap-2">
                <div class="w-6 h-6 rounded-full bg-green-500 flex items-center justify-center text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                </div>
                <span id="successCount">0</span> <span class="text-sm text-gray-500 dark:text-gray-400">operations completed successfully</span>
            </div>
            
            <div class="mb-4 flex items-center gap-2">
                <div class="w-6 h-6 rounded-full bg-red-500 flex items-center justify-center text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </div>
                <span id="failureCount">0</span> <span class="text-sm text-gray-500 dark:text-gray-400">operations failed</span>
            </div>
            
            <div class="overflow-auto max-h-[300px]">
                <div id="resultsLog" class="p-4 bg-gray-100 dark:bg-gray-700 rounded-md font-mono text-sm">
                    <!-- Results log entries will be added here -->
                </div>
            </div>
            
            <div class="mt-4">
                <button id="resetBtn" 
                    class="px-4 py-2 bg-primary text-white rounded-md hover:bg-opacity-90 transition-colors">
                    Start New Operation
                </button>
            </div>
        </div>
    </div>
    
    <!-- IMS Authentication Configuration -->
    <script>
        // IMS Configuration with AEM CS Assets Selector client ID
        const imsConfig = {
            clientId: 'aemcs-poe-assetselector', // AEM CS Assets Selector client ID
            redirectUri: window.location.origin + window.location.pathname,
            scope: 'openid,AdobeID,read_organizations',
            responseType: 'token'
        };
        
        // Function to initiate IMS login flow
        function loginWithIMS() {
            // Create and show the auth loading indicator
            const authLoadingIndicator = document.createElement('div');
            authLoadingIndicator.id = 'authLoadingIndicator';
            authLoadingIndicator.className = 'fixed inset-0 bg-white/50 dark:bg-gray-900/50 flex flex-col justify-center items-center z-50';
            authLoadingIndicator.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg flex flex-col items-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-4 border-primary/30 border-t-4 border-t-primary mb-4"></div>
                    <p class="text-lg font-medium">Preparing Adobe Authentication...</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Please wait while we connect to Adobe's authentication service</p>
                </div>
            `;
            document.body.appendChild(authLoadingIndicator);
            
            // Save current app state to restore after authentication
            const currentState = {
                aemHost: document.getElementById('aemHost').value
            };
            
            // Store current state in memory so we can retrieve it later
            window.imsState = currentState;
            
            // Create the authorization URL
            const authUrl = `https://ims-na1.adobelogin.com/ims/authorize/v2?` +
                `client_id=${encodeURIComponent(imsConfig.clientId)}` +
                `&redirect_uri=${encodeURIComponent(imsConfig.redirectUri)}` +
                `&scope=${encodeURIComponent(imsConfig.scope)}` +
                `&response_type=${imsConfig.responseType}`;
            
            // Delay opening the window to give the user time to see the loading indicator
            setTimeout(() => {
                // Store the auth window reference globally to close it later
                window.authWindow = window.open(authUrl, 'adobeImsLogin', 
                    'width=800,height=600,location=yes,resizable=yes,scrollbars=yes,status=yes');
                
                if (!window.authWindow) {
                    // Remove the loading indicator
                    if (document.body.contains(authLoadingIndicator)) {
                        document.body.removeChild(authLoadingIndicator);
                    }
                    showNotification('Popup blocked. Please allow popups for this site and try again.', 'error');
                    return;
                }
                
                // Update the loading indicator message after opening the window
                const loadingText = authLoadingIndicator.querySelector('p.text-lg');
                const loadingSubtext = authLoadingIndicator.querySelector('p.text-sm');
                if (loadingText && loadingSubtext) {
                    loadingText.textContent = 'Adobe Authentication Window Opened';
                    loadingSubtext.textContent = 'Please complete the sign in process in the popup window';
                }
                
                // Remove loading indicator after a longer delay to ensure user notices it
                setTimeout(() => {
                    if (document.body.contains(authLoadingIndicator)) {
                        document.body.removeChild(authLoadingIndicator);
                    }
                    // Show a helper notification to guide users
                    showNotification('Adobe login window opened. Please complete authentication in the popup.', 'info', 10000);
                }, 1500);
                
                // Handle message events from the popup
                window.addEventListener('message', receiveImsToken, false);
                
                // Function to monitor for popup closure with a longer interval
                const checkClosed = setInterval(() => {
                    if (window.authWindow && window.authWindow.closed) {
                        clearInterval(checkClosed);
                        window.removeEventListener('message', receiveImsToken);
                        
                        // Show loading when checking for token
                        const tokenCheckIndicator = document.createElement('div');
                        tokenCheckIndicator.className = 'fixed inset-0 bg-white/50 dark:bg-gray-900/50 flex flex-col justify-center items-center z-50';
                        tokenCheckIndicator.innerHTML = `
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg flex flex-col items-center">
                                <div class="animate-spin rounded-full h-12 w-12 border-4 border-primary/30 border-t-4 border-t-primary mb-4"></div>
                                <p class="text-lg font-medium">Processing Authentication</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Retrieving your access token...</p>
                            </div>
                        `;
                        document.body.appendChild(tokenCheckIndicator);
                        
                        // Add a longer delay before checking for the token to give more time for processing
                        setTimeout(() => {
                            // Check if we have a token in the URL hash (in case the popup redirected to our main window)
                            const hasToken = handleImsRedirect();
                            
                            // Remove the token check indicator
                            if (document.body.contains(tokenCheckIndicator)) {
                                document.body.removeChild(tokenCheckIndicator);
                            }
                            
                            // If we don't have a token yet, prompt the user to enter it manually
                            const imsTokenField = document.getElementById('imsToken');
                            if (!hasToken && !imsTokenField.value) {
                                // Show manual token entry helper
                                showManualTokenHelper();
                            }
                        }, 2000); // Wait 2 seconds before checking for token
                    }
                }, 1000); // Check every second if the popup is closed
            }, 800); // Wait 800ms before opening the authentication window
        }
        
        // Function to receive IMS token from the popup window
        function receiveImsToken(event) {
            // Validate the origin of the message
            if (event.origin === 'https://ims-na1.adobelogin.com' || 
                event.origin === window.location.origin) {
                
                try {
                    // Parse the message data
                    const data = typeof event.data === 'string' 
                        ? JSON.parse(event.data) 
                        : event.data;
                    
                    // Check if this is an IMS token message
                    if (data && data.type === 'access_token' && data.token) {
                        // Store the token
                        document.getElementById('imsToken').value = data.token;
                        
                        // Close the auth window if it's still open
                        if (window.authWindow && !window.authWindow.closed) {
                            window.authWindow.close();
                        }
                        
                        // Update UI to show authenticated state
                        updateAuthStatusUI(true, 'IMS');
                        
                        // Remove event listener
                        window.removeEventListener('message', receiveImsToken);
                        
                        // Show success notification
                        showNotification('Successfully authenticated with Adobe IMS', 'success');
                    }
                } catch (err) {
                    console.error('Error processing IMS message:', err);
                }
            }
        }
        
        // Function to handle IMS redirect with token in URL hash
        function handleImsRedirect() {
            if (window.location.hash.includes('access_token=')) {
                try {
                    // Parse the hash parameters
                    const hashParams = new URLSearchParams(
                        window.location.hash.substring(1) // Remove the # character
                    );
                    
                    // Get the access token
                    const accessToken = hashParams.get('access_token');
                    
                    if (accessToken) {
                        // Store the token
                        document.getElementById('imsToken').value = accessToken;
                        
                        // Update UI to show authenticated state
                        updateAuthStatusUI(true, 'IMS');
                        
                        // Show success notification
                        showNotification('Successfully authenticated with Adobe IMS', 'success');
                        
                        // Clean the URL hash
                        window.history.replaceState(
                            null, 
                            document.title, 
                            window.location.pathname + window.location.search
                        );
                        
                        return true;
                    }
                } catch (err) {
                    console.error('Error processing IMS redirect:', err);
                }
            }
            return false;
        }
        
        // Function to show manual token entry helper
        function showManualTokenHelper() {
            // Show the token input section
            const tokenSection = document.getElementById('imsTokenSection');
            tokenSection.classList.remove('hidden');
            
            // Notification to guide the user
            showNotification('Please enter your IMS access token manually if it was not automatically detected', 'info', 10000);
        }
    </script>
    
    <!-- Main App Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Handle IMS redirect on page load
            handleImsRedirect();
            
            // Setup collapsible authentication panel
            setupCollapsiblePanel();
            
            // Setup tabs
            setupTabs();
            
            // State management
            let workbook = null;
            let selectedSheet = null;
            let sheetData = null;
            let assetPaths = [];
            let renamedPaths = [];
            let metadataUpdates = [];
            let currentTab = 'rename'; // Default tab
            
            // DOM elements
            const fileInput = document.getElementById('fileInput');
            const fileProcessingStatus = document.getElementById('fileProcessingStatus');
            const sheetSelect = document.getElementById('sheetSelect');
            const assetPathColumnSelect = document.getElementById('assetPathColumnSelect');
            const sheetSelection = document.getElementById('sheetSelection');
            const assetPathColumnSelection = document.getElementById('assetPathColumnSelection');
            const renameConfigSection = document.getElementById('renameConfigSection');
            const metadataConfigSection = document.getElementById('metadataConfigSection');
            const renamePreviewSection = document.getElementById('renamePreviewSection');
            const metadataPreviewSection = document.getElementById('metadataPreviewSection');
            const resultsSection = document.getElementById('resultsSection');
            const excelPreview = document.getElementById('excelPreview');
            const previewTableHead = document.getElementById('previewTableHead');
            const previewTableBody = document.getElementById('previewTableBody');
            const renamePreviewTableBody = document.getElementById('renamePreviewTableBody');
            const metadataPreviewTableBody = document.getElementById('metadataPreviewTableBody');
            const resultsLog = document.getElementById('resultsLog');
            const basicAuthBtn = document.getElementById('basicAuthBtn');
            const imsAuthBtn = document.getElementById('imsAuthBtn');
            const imsTokenSection = document.getElementById('imsTokenSection');
            const authStatus = document.getElementById('authStatus');
            const addMappingBtn = document.getElementById('addMappingBtn');
            
            // Authentication state
            let isAuthenticated = false;
            let authMethod = null;
            
            // Button event listeners
            basicAuthBtn.addEventListener('click', authenticateBasic);
            imsAuthBtn.addEventListener('click', loginWithIMS);
            fileInput.addEventListener('change', handleFileUpload);
            document.getElementById('renamePreviewBtn').addEventListener('click', previewRenames);
            document.getElementById('metadataPreviewBtn').addEventListener('click', previewMetadataUpdates);
            document.getElementById('deletePreviewBtn').addEventListener('click', previewDeletes);
            document.getElementById('searchPreviewBtn').addEventListener('click', performSearch);
            document.getElementById('executeRenameBtn').addEventListener('click', executeRenames);
            document.getElementById('executeMetadataBtn').addEventListener('click', executeMetadataUpdates);
            document.getElementById('executeDeleteBtn').addEventListener('click', executeDeletes);
            document.getElementById('cancelRenameBtn').addEventListener('click', cancelOperation);
            document.getElementById('cancelMetadataBtn').addEventListener('click', cancelOperation);
            document.getElementById('cancelDeleteBtn').addEventListener('click', cancelOperation);
            document.getElementById('cancelSearchBtn').addEventListener('click', cancelOperation);
            document.getElementById('downloadSelectedBtn').addEventListener('click', downloadSelectedAssets);
            document.getElementById('searchResultsFilter').addEventListener('input', filterSearchResults);
            document.getElementById('selectAllCheckbox').addEventListener('change', toggleSelectAllAssets);
            document.getElementById('resetBtn').addEventListener('click', resetApp);
            addMappingBtn.addEventListener('click', addMetadataMapping);
            
            // Initialize event listeners for removing metadata mappings
            document.addEventListener('click', function(e) {
                if (e.target.closest('.remove-mapping')) {
                    const mappingRow = e.target.closest('.mapping-row');
                    if (mappingRow && document.querySelectorAll('.mapping-row').length > 1) {
                        mappingRow.remove();
                    } else {
                        showNotification('Cannot remove the last mapping row', 'warning');
                    }
                }
            });
            
            // Initialize direct event listeners for select elements
            sheetSelect.addEventListener('change', function() {
                processSheetSelection(this.value);
            });
            
            assetPathColumnSelect.addEventListener('change', function() {
                // When asset path column is selected, show the appropriate config section based on the active tab
                if (currentTab === 'rename') {
                    renameConfigSection.classList.remove('hidden');
                } else if (currentTab === 'metadata') {
                    metadataConfigSection.classList.remove('hidden');
                    populateMetadataColumnOptions();
                } else if (currentTab === 'delete') {
                    document.getElementById('deleteConfigSection').classList.remove('hidden');
                }
            });
            
            // Document imsToken field update listener
            document.getElementById('imsToken').addEventListener('input', function() {
                if (this.value.trim()) {
                    updateAuthStatusUI(true, 'IMS');
                }
            });
            
            // Add event listeners for search property configuration
            document.getElementById('searchMetadataProperty').addEventListener('change', function() {
                const customPropertyField = document.getElementById('customSearchProperty');
                if (this.value === 'custom') {
                    customPropertyField.classList.remove('hidden');
                    customPropertyField.focus();
                } else {
                    customPropertyField.classList.add('hidden');
                }
            });
            
            // Add test token button functionality
            document.getElementById('testTokenBtn').addEventListener('click', function() {
                const token = document.getElementById('imsToken').value.trim();
                if (!token) {
                    showNotification('Please enter an IMS token to validate', 'warning');
                    return;
                }
                
                // Show validation in progress
                const btn = this;
                const originalText = btn.textContent;
                btn.disabled = true;
                btn.innerHTML = `
                    <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-current inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Validating...
                `;
                
                // Here you would normally make an API call to validate the token
                // For demo purposes, we'll simulate a success after a brief delay
                setTimeout(() => {
                    updateAuthStatusUI(true, 'IMS');
                    showNotification('Token validated successfully', 'success');
                    
                    // Restore button state
                    btn.disabled = false;
                    btn.textContent = originalText;
                }, 1500);
            });
            
            // Setup tab functionality
            function setupTabs() {
                const tabButtons = document.querySelectorAll('.tab-button');
                const currentTabLabel = document.getElementById('currentTabLabel');
                
                tabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        // Update currentTab value
                        currentTab = button.getAttribute('data-tab');
                        
                        // Update the current tab label
                        const tabLabel = button.getAttribute('data-label');
                        currentTabLabel.textContent = tabLabel;
                        
                        // Update active tab button
                        tabButtons.forEach(btn => {
                            if (btn === button) {
                                btn.classList.remove('tab-inactive');
                                btn.classList.add('tab-active');
                            } else {
                                btn.classList.remove('tab-active');
                                btn.classList.add('tab-inactive');
                            }
                        });
                        
                        // Hide all tab content
                        document.querySelectorAll('.tab-content').forEach(content => {
                            content.classList.add('hidden');
                        });
                        
                        // Show appropriate config section if we have file data
                        if (workbook && assetPathColumnSelect.value) {
                            if (currentTab === 'rename') {
                                renameConfigSection.classList.remove('hidden');
                            } else if (currentTab === 'metadata') {
                                metadataConfigSection.classList.remove('hidden');
                                populateMetadataColumnOptions();
                            } else if (currentTab === 'delete') {
                                document.getElementById('deleteConfigSection').classList.remove('hidden');
                            } else if (currentTab === 'search') {
                                document.getElementById('searchConfigSection').classList.remove('hidden');
                            }
                        }
                    });
                });
            }
            
            // Add a new metadata mapping row
            function addMetadataMapping() {
                const mappingsContainer = document.getElementById('mappingsContainer');
                const newRow = document.createElement('div');
                newRow.className = 'mapping-row flex flex-col md:flex-row gap-3 items-start md:items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-md';
                
                newRow.innerHTML = `
                    <div class="flex-1">
                        <label class="block text-sm mb-1 text-gray-600 dark:text-gray-300">Property Name</label>
                        <input type="text" placeholder="dc:description" class="property-name w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-800 dark:text-white" />
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm mb-1 text-gray-600 dark:text-gray-300">Value Column</label>
                        <select class="value-column w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-800 dark:text-white">
                            <option value="">Select column</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div class="flex items-end justify-end h-full pt-6 md:pt-0">
                        <button class="remove-mapping p-1 text-red-500 hover:text-red-700 rounded-full hover:bg-red-100 dark:hover:bg-red-900">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                `;
                
                mappingsContainer.appendChild(newRow);
                
                // Populate the column options in the new row
                populateMetadataColumnOptions();
            }
            
            // Populate column options for metadata mappings
            function populateMetadataColumnOptions() {
                if (!sheetData || !sheetData[0]) return;
                
                const headers = sheetData[0];
                const assetPathColumnIndex = parseInt(assetPathColumnSelect.value);
                
                // Get all value-column selects
                const valueColumns = document.querySelectorAll('.value-column');
                
                valueColumns.forEach(select => {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Select column</option>';
                    
                    headers.forEach((header, index) => {
                        // Skip the asset path column
                        if (index !== assetPathColumnIndex) {
                            const option = document.createElement('option');
                            option.value = index;
                            option.textContent = header || `Column ${index + 1}`;
                            select.appendChild(option);
                        }
                    });
                    
                    // Restore selected value if possible
                    if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) {
                        select.value = currentValue;
                    }
                });
            }
            
            // Handle Basic Authentication
            function authenticateBasic() {
                const aemHost = document.getElementById('aemHost').value.trim();
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();
                
                if (!aemHost || !username || !password) {
                    showNotification('Please provide AEM host, username, and password', 'error');
                    return;
                }
                
                // In a real app, you would validate the credentials with AEM
                // Here we'll just simulate a successful login
                setTimeout(() => {
                    updateAuthStatusUI(true, 'Basic');
                    showNotification('Successfully authenticated with Basic Auth', 'success');
                }, 1000);
            }
            
            // Preview delete operations
            function previewDeletes() {
                if (!sheetData || sheetData.length <= 1) {
                    showNotification('No data to process', 'error');
                    return;
                }
                
                try {
                    // Get selected column index
                    const columnIndex = parseInt(assetPathColumnSelect.value);
                    
                    // Skip header row
                    const dataRows = sheetData.slice(1);
                    
                    // Get asset paths from selected column
                    const deleteAssetPaths = dataRows.map(row => {
                        return row[columnIndex] || '';
                    }).filter(path => path.trim() !== '');
                    
                    if (deleteAssetPaths.length === 0) {
                        showNotification('No asset paths found in the selected column', 'warning');
                        return;
                    }
                    
                    // Store paths for later use
                    assetPaths = deleteAssetPaths;
                    
                    // Populate the delete preview table
                    populateDeletePreviewTable(deleteAssetPaths);
                    
                    // Show the delete preview section
                    document.getElementById('deletePreviewSection').classList.remove('hidden');
                    document.getElementById('deleteConfigSection').classList.add('hidden');
                    
                } catch (error) {
                    showNotification('Error generating delete preview: ' + error.message, 'error');
                }
            }
            
            // Populate the delete preview table
            function populateDeletePreviewTable(paths) {
                const tableBody = document.getElementById('deletePreviewTableBody');
                tableBody.innerHTML = '';
                
                if (paths.length === 0) {
                    const row = document.createElement('tr');
                    const cell = document.createElement('td');
                    cell.colSpan = 2;
                    cell.className = 'py-4 text-center text-sm text-gray-500 dark:text-gray-400';
                    cell.textContent = 'No assets found to delete';
                    row.appendChild(cell);
                    tableBody.appendChild(row);
                    return;
                }
                
                paths.forEach(path => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 dark:hover:bg-gray-800';
                    
                    // Asset path cell
                    const pathCell = document.createElement('td');
                    pathCell.className = 'py-3 px-4 text-sm';
                    pathCell.textContent = path;
                    row.appendChild(pathCell);
                    
                    // Action cell
                    const actionCell = document.createElement('td');
                    actionCell.className = 'py-3 px-4 text-sm text-red-600 dark:text-red-400 font-medium';
                    actionCell.textContent = 'DELETE';
                    row.appendChild(actionCell);
                    
                    tableBody.appendChild(row);
                });
            }
            
            // Execute delete operations
            async function executeDeletes() {
                // Check if authenticated before proceeding
                if (!isAuthenticated) {
                    showNotification('Please authenticate before executing deletions', 'error');
                    return;
                }
                
                // Show results section
                resultsSection.classList.remove('hidden');
                document.getElementById('deletePreviewSection').classList.add('hidden');
                
                // Get AEM host
                const aemHost = document.getElementById('aemHost').value.trim();
                if (!aemHost) {
                    showNotification('Please provide an AEM host URL', 'error');
                    addToLog('Error: AEM host URL is required', 'error');
                    return;
                }
                
                // Initialize counters
                let successCount = 0;
                let failureCount = 0;
                
                // Log header
                addToLog('Starting asset deletion operation...', 'header');
                
                // Get authentication headers
                const headers = getAuthHeaders();
                
                // Process each asset
                for (const path of assetPaths) {
                    try {
                        // Log start of operation
                        addToLog(`Deleting asset: ${path}`, 'info');
                        
                        // Prepare API path - asset path is without '/content/dam'
                        const apiPath = buildApiPath(path);
                        
                        // Create the full URL - with CORS proxy
                        const targetUrl = new URL(apiPath, aemHost).toString();
                        const corsProxyUrl = 'https://cors-proxy.philipp-koch.workers.dev/corsproxy/?apiurl=' + encodeURIComponent(targetUrl);
                        
                        // Log the actual request details
                        addToLog(`Sending DELETE request via CORS proxy`, 'info');
                        addToLog(`URL: ${targetUrl}`, 'info');
                        
                        // Make the actual API call through the CORS proxy
                        const response = await fetch(corsProxyUrl, {
                            method: 'DELETE',
                            headers: headers,
                        });
                        
                        // Process the response
                        if (response.ok) {
                            addToLog(`Successfully deleted: ${path}`, 'success');
                            successCount++;
                        } else {
                            const errorText = await response.text().catch(() => 'Unknown error');
                            addToLog(`Failed to delete: ${path}. Status: ${response.status}. Error: ${errorText}`, 'error');
                            failureCount++;
                        }
                    } catch (error) {
                        addToLog(`Error deleting ${path}: ${error.message}`, 'error');
                        failureCount++;
                    }
                    
                    // Small delay between operations to avoid overwhelming the server
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // Update counters in UI
                document.getElementById('successCount').textContent = successCount;
                document.getElementById('failureCount').textContent = failureCount;
                
                // Log completion
                addToLog(`Operation completed. ${successCount} successful, ${failureCount} failed.`, 'header');
            }
            
            // Update authentication status UI
            function updateAuthStatusUI(isSuccessful, method) {
                authStatus.classList.remove('hidden');
                
                if (isSuccessful) {
                    isAuthenticated = true;
                    authMethod = method;
                    
                    authStatus.className = 'mt-4 p-3 rounded-md border border-green-200 bg-green-50 text-green-800 dark:bg-green-900/30 dark:border-green-800 dark:text-green-400';
                    authStatus.innerHTML = `
                        <div class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span>Authenticated with ${method} Authentication</span>
                        </div>
                    `;
                } else {
                    isAuthenticated = false;
                    authMethod = null;
                    
                    authStatus.className = 'mt-4 p-3 rounded-md border border-red-200 bg-red-50 text-red-800 dark:bg-red-900/30 dark:border-red-800 dark:text-red-400';
                    authStatus.innerHTML = `
                        <div class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                            <span>Authentication Failed</span>
                        </div>
                    `;
                }
            }
            
            // Handle Excel file upload
            function handleFileUpload(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                // Show file processing status
                fileProcessingStatus.classList.remove('hidden');
                
                // Hide other sections
                sheetSelection.classList.add('hidden');
                assetPathColumnSelection.classList.add('hidden');
                renameConfigSection.classList.add('hidden');
                metadataConfigSection.classList.add('hidden');
                renamePreviewSection.classList.add('hidden');
                metadataPreviewSection.classList.add('hidden');
                resultsSection.classList.add('hidden');
                excelPreview.classList.add('hidden');
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        workbook = XLSX.read(data, { type: 'array' });
                        
                        // Populate sheet selection dropdown
                        populateSheetOptions();
                        
                        // Hide processing status
                        fileProcessingStatus.classList.add('hidden');
                        
                        // Show sheet selection
                        sheetSelection.classList.remove('hidden');
                        
                        // Auto-select first sheet if available
                        if (workbook.SheetNames.length > 0) {
                            sheetSelect.value = workbook.SheetNames[0];
                            processSheetSelection(workbook.SheetNames[0]);
                        }
                    } catch (error) {
                        fileProcessingStatus.classList.add('hidden');
                        showNotification('Error reading Excel file: ' + error.message, 'error');
                    }
                };
                
                reader.onerror = function(e) {
                    fileProcessingStatus.classList.add('hidden');
                    showNotification('Error reading the file', 'error');
                };
                
                reader.readAsArrayBuffer(file);
            }
            
            // Populate sheet options
            function populateSheetOptions() {
                sheetSelect.innerHTML = '';
                
                workbook.SheetNames.forEach(sheetName => {
                    const option = document.createElement('option');
                    option.value = sheetName;
                    option.textContent = sheetName;
                    sheetSelect.appendChild(option);
                });
            }
            
            // Process sheet selection
            function processSheetSelection(sheetName) {
                try {
                    // Get the selected sheet
                    selectedSheet = workbook.Sheets[sheetName];
                    
                    // Convert to JSON with headers
                    sheetData = XLSX.utils.sheet_to_json(selectedSheet, { header: 1 });
                    
                    if (sheetData.length === 0) {
                        showNotification('Selected sheet is empty', 'warning');
                        return;
                    }
                    
                    // Get headers (first row)
                    const headers = sheetData[0] || [];
                    
                    if (headers.length === 0) {
                        showNotification('No columns found in the selected sheet', 'error');
                        return;
                    }
                    
                    // Populate asset path column selection
                    populateAssetPathColumnOptions(headers);
                    
                    // Show Excel preview
                    generateExcelPreview(sheetData);
                    
                    // Show column selection
                    assetPathColumnSelection.classList.remove('hidden');
                    excelPreview.classList.remove('hidden');
                    
                    // Auto-select first column
                    if (assetPathColumnSelect.options.length > 0) {
                        assetPathColumnSelect.selectedIndex = 0;
                        
                        // Adjust label for the column selection based on the current tab
                        if (currentTab === 'search') {
                            document.querySelector('label[for="assetPathColumnSelect"]').textContent = 'Select SKU Column';
                        } else {
                            document.querySelector('label[for="assetPathColumnSelect"]').textContent = 'Select Asset Path Column';
                        }
                        
                        // Show appropriate config section based on active tab
                        if (currentTab === 'rename') {
                            renameConfigSection.classList.remove('hidden');
                        } else if (currentTab === 'metadata') {
                            metadataConfigSection.classList.remove('hidden');
                            populateMetadataColumnOptions();
                        } else if (currentTab === 'delete') {
                            document.getElementById('deleteConfigSection').classList.remove('hidden');
                        } else if (currentTab === 'search') {
                            document.getElementById('searchConfigSection').classList.remove('hidden');
                        }
                    }
                } catch (error) {
                    showNotification('Error processing the selected sheet: ' + error.message, 'error');
                }
            }
            
            // Populate asset path column options
            function populateAssetPathColumnOptions(headers) {
                assetPathColumnSelect.innerHTML = '';
                
                headers.forEach((header, index) => {
                    const displayName = header || `Column ${index + 1}`;
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = displayName;
                    assetPathColumnSelect.appendChild(option);
                });
            }
            
            // Generate Excel preview table
            function generateExcelPreview(data) {
                if (!data || data.length === 0) return;
                
                const maxRows = 5; // Show first 5 rows including header
                const rowsToShow = Math.min(data.length, maxRows);
                
                // Generate header row
                const headerRow = document.createElement('tr');
                
                if (data[0]) {
                    data[0].forEach((cell, index) => {
                        const th = document.createElement('th');
                        th.className = 'py-2 px-4 text-left text-sm font-semibold';
                        th.textContent = cell || `Column ${index + 1}`;
                        headerRow.appendChild(th);
                    });
                }
                
                previewTableHead.innerHTML = '';
                previewTableHead.appendChild(headerRow);
                
                // Generate data rows
                previewTableBody.innerHTML = '';
                
                for (let i = 1; i < rowsToShow; i++) {
                    if (data[i]) {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700';
                        
                        data[i].forEach(cell => {
                            const td = document.createElement('td');
                            td.className = 'py-2 px-4 text-sm';
                            td.textContent = cell !== null && cell !== undefined ? cell : '';
                            row.appendChild(td);
                        });
                        
                        previewTableBody.appendChild(row);
                    }
                }
                
                // Add a "more rows" indicator if there's more data
                if (data.length > maxRows) {
                    const moreRow = document.createElement('tr');
                    const moreCell = document.createElement('td');
                    moreCell.colSpan = data[0] ? data[0].length : 1;
                    moreCell.className = 'py-2 px-4 text-sm text-center text-gray-500 italic';
                    moreCell.textContent = `... ${data.length - maxRows} more rows`;
                    moreRow.appendChild(moreCell);
                    previewTableBody.appendChild(moreRow);
                }
            }
            
            // Preview rename changes
            function previewRenames() {
                if (!sheetData || sheetData.length <= 1) {
                    showNotification('No data to process', 'error');
                    return;
                }
                
                try {
                    // Get selected column index
                    const columnIndex = parseInt(assetPathColumnSelect.value);
                    
                    // Skip header row
                    const dataRows = sheetData.slice(1);
                    
                    // Get asset paths from selected column
                    assetPaths = dataRows.map(row => {
                        return row[columnIndex] || '';
                    }).filter(path => path.trim() !== '');
                    
                    if (assetPaths.length === 0) {
                        showNotification('No asset paths found in the selected column', 'warning');
                        return;
                    }
                    
                    // Get characters to process
                    const charsToProcess = Array.from(document.querySelectorAll('.char-checkbox:checked'))
                        .map(checkbox => checkbox.getAttribute('data-char'));
                    
                    // Get action and replacement
                    const action = document.querySelector('input[name="action"]:checked').value;
                    const replacement = action === 'replace' ? document.getElementById('replaceWith').value : '';
                    
                    // Generate renamed paths
                    renamedPaths = assetPaths.map(path => {
                        // Extract path components
                        const lastSlashIndex = path.lastIndexOf('/');
                        const directory = path.substring(0, lastSlashIndex + 1);
                        const filename = path.substring(lastSlashIndex + 1);
                        
                        // Process filename
                        let newFilename = filename;
                        charsToProcess.forEach(char => {
                            const escapedChar = char === '.' ? '\\.' : char;
                            const regex = new RegExp(escapedChar, 'g');
                            newFilename = newFilename.replace(regex, replacement);
                        });
                        
                        return directory + newFilename;
                    });
                    
                    // Populate preview table
                    populateRenamePreviewTable(assetPaths, renamedPaths);
                    
                    // Show preview section
                    renamePreviewSection.classList.remove('hidden');
                } catch (error) {
                    showNotification('Error generating preview: ' + error.message, 'error');
                }
            }
            
            // Preview metadata updates
            function previewMetadataUpdates() {
                if (!sheetData || sheetData.length <= 1) {
                    showNotification('No data to process', 'error');
                    return;
                }
                
                try {
                    // Get selected asset path column index
                    const assetPathColumnIndex = parseInt(assetPathColumnSelect.value);
                    
                    // Get metadata mappings
                    const mappings = [];
                    document.querySelectorAll('.mapping-row').forEach(row => {
                        const propertyName = row.querySelector('.property-name').value.trim();
                        const valueColumnIndex = row.querySelector('.value-column').value;
                        
                        if (propertyName && valueColumnIndex) {
                            mappings.push({
                                property: propertyName,
                                columnIndex: parseInt(valueColumnIndex)
                            });
                        }
                    });
                    
                    if (mappings.length === 0) {
                        showNotification('No valid metadata mappings defined', 'warning');
                        return;
                    }
                    
                    // Skip header row
                    const dataRows = sheetData.slice(1);
                    
                    // Build metadata updates
                    metadataUpdates = [];
                    
                    dataRows.forEach(row => {
                        const assetPath = row[assetPathColumnIndex];
                        
                        if (assetPath && assetPath.trim()) {
                            const properties = {};
                            let hasValues = false;
                            
                            mappings.forEach(mapping => {
                                const value = row[mapping.columnIndex];
                                // Convert null, undefined, or empty values to empty string
                                // Always add the property (even if empty) to ensure metadata update occurs
                                properties[mapping.property] = (value !== undefined && value !== null) ? String(value) : '';
                                hasValues = true;
                            });
                            
                            if (hasValues) {
                                metadataUpdates.push({
                                    assetPath,
                                    properties
                                });
                            }
                        }
                    });
                    
                    if (metadataUpdates.length === 0) {
                        showNotification('No metadata updates found in the selected data', 'warning');
                        return;
                    }
                    
                    // Populate metadata preview table
                    populateMetadataPreviewTable(metadataUpdates);
                    
                    // Show preview section
                    metadataPreviewSection.classList.remove('hidden');
                } catch (error) {
                    showNotification('Error generating metadata preview: ' + error.message, 'error');
                }
            }
            
            // Populate rename preview table
            function populateRenamePreviewTable(originalPaths, newPaths) {
                renamePreviewTableBody.innerHTML = '';
                
                let changeCount = 0;
                
                originalPaths.forEach((path, index) => {
                    const newPath = newPaths[index];
                    
                    // Skip if path didn't change
                    if (path === newPath) return;
                    
                    changeCount++;
                    
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 dark:hover:bg-gray-800';
                    
                    // Original path cell
                    const originalCell = document.createElement('td');
                    originalCell.className = 'py-3 px-4 text-sm';
                    originalCell.textContent = path;
                    row.appendChild(originalCell);
                    
                    // New path cell
                    const newCell = document.createElement('td');
                    newCell.className = 'py-3 px-4 text-sm';
                    
                    // Highlight differences
                    const originalFilename = path.substring(path.lastIndexOf('/') + 1);
                    const newFilename = newPath.substring(newPath.lastIndexOf('/') + 1);
                    
                    const directory = path.substring(0, path.lastIndexOf('/') + 1);
                    
                    newCell.innerHTML = directory + `<span class="font-semibold text-primary">${newFilename}</span>`;
                    row.appendChild(newCell);
                    
                    renamePreviewTableBody.appendChild(row);
                });
                
                if (changeCount === 0) {
                    const row = document.createElement('tr');
                    const cell = document.createElement('td');
                    cell.colSpan = 2;
                    cell.className = 'py-4 text-center text-sm text-gray-500 dark:text-gray-400';
                    cell.textContent = 'No changes required - all paths already match the configured pattern';
                    row.appendChild(cell);
                    renamePreviewTableBody.appendChild(row);
                }
            }
            
            // Populate metadata preview table with HTTP command details
            function populateMetadataPreviewTable(updates) {
                metadataPreviewTableBody.innerHTML = '';
                
                // Get AEM host (if available)
                const aemHost = document.getElementById('aemHost').value.trim() || 'http://your-aem-instance.com';
                
                updates.forEach(update => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 dark:hover:bg-gray-800';
                    
                    // Asset path cell
                    const pathCell = document.createElement('td');
                    pathCell.className = 'py-3 px-4 text-sm align-top';
                    pathCell.textContent = update.assetPath;
                    row.appendChild(pathCell);
                    
                    // Metadata updates cell with HTTP command details
                    const metadataCell = document.createElement('td');
                    metadataCell.className = 'py-3 px-4 text-sm';
                    
                    // Create the details section
                    const detailsSection = document.createElement('div');
                    detailsSection.className = 'mb-3';
                    
                    // Prepare the API path
                    const apiPath = buildApiPath(update.assetPath);
                    const fullUrl = new URL(apiPath, aemHost).toString();
                    
                    // Prepare request body
                    const requestBody = {
                        class: "asset",
                        properties: update.properties
                    };
                    
                    // Create the HTTP command display
                    detailsSection.innerHTML = `
                        <div class="border border-gray-200 dark:border-gray-700 rounded-md overflow-hidden mb-3">
                            <div class="bg-gray-100 dark:bg-gray-800 px-3 py-1 font-semibold text-xs">HTTP Request</div>
                            <div class="p-3 font-mono text-xs overflow-x-auto">
                                <div class="text-blue-600 dark:text-blue-400">PUT ${fullUrl}</div>
                                <div class="text-green-600 dark:text-green-400">Content-Type: application/json</div>
                                <div class="text-green-600 dark:text-green-400">Authorization: Bearer &lt;token&gt; or Basic &lt;credentials&gt;</div>
                                <div class="mt-2 text-gray-600 dark:text-gray-400">${JSON.stringify(requestBody, null, 2)}</div>
                            </div>
                        </div>
                    `;
                    
                    // Add the metadata updates list
                    const metadataList = document.createElement('ul');
                    metadataList.className = 'list-disc pl-5 space-y-1';
                    
                    // Add header for the metadata list
                    const metadataHeader = document.createElement('div');
                    metadataHeader.className = 'font-medium mb-2';
                    metadataHeader.textContent = 'Properties to update:';
                    
                    Object.entries(update.properties).forEach(([key, value]) => {
                        const item = document.createElement('li');
                        item.innerHTML = `<span class="font-medium">${key}</span>: <span class="text-primary">${value}</span>`;
                        metadataList.appendChild(item);
                    });
                    
                    // Add everything to the metadata cell
                    metadataCell.appendChild(detailsSection);
                    metadataCell.appendChild(metadataHeader);
                    metadataCell.appendChild(metadataList);
                    row.appendChild(metadataCell);
                    
                    metadataPreviewTableBody.appendChild(row);
                });
                
                if (updates.length === 0) {
                    const row = document.createElement('tr');
                    const cell = document.createElement('td');
                    cell.colSpan = 2;
                    cell.className = 'py-4 text-center text-sm text-gray-500 dark:text-gray-400';
                    cell.textContent = 'No metadata updates found';
                    row.appendChild(cell);
                    metadataPreviewTableBody.appendChild(row);
                }
            }
            
            // Execute renames - production implementation
            async function executeRenames() {
                // Check if authenticated before proceeding
                if (!isAuthenticated) {
                    showNotification('Please authenticate before executing renames', 'error');
                    return;
                }
                
                // Show results section
                resultsSection.classList.remove('hidden');
                renamePreviewSection.classList.add('hidden');
                
                // Get AEM host
                const aemHost = document.getElementById('aemHost').value.trim();
                if (!aemHost) {
                    showNotification('Please provide an AEM host URL', 'error');
                    addToLog('Error: AEM host URL is required', 'error');
                    return;
                }
                
                // Initialize counters
                let successCount = 0;
                let failureCount = 0;
                
                // Log header
                addToLog('Starting asset rename operation...', 'header');
                
                // Get authentication headers
                const headers = getAuthHeaders();
                
                // Process each asset
                for (let i = 0; i < assetPaths.length; i++) {
                    const originalPath = assetPaths[i];
                    const newPath = renamedPaths[i];
                    
                    // Skip if path didn't change
                    if (originalPath === newPath) continue;
                    
                    try {
                        // Log start of operation
                        addToLog(`Processing: ${originalPath} → ${newPath}`, 'info');
                        
                        // Prepare API paths
                        const apiOriginalPath = buildApiPath(originalPath);
                        const apiNewPath = buildApiPath(newPath);
                        
                        // Create the full URLs - with CORS proxy
                        const targetUrl = new URL(apiOriginalPath, aemHost).toString();
                        const corsProxyUrl = 'https://cors-proxy.philipp-koch.workers.dev/corsproxy/?apiurl=' + encodeURIComponent(targetUrl);
                        
                        // For the destination path, we need the full URL too (not just the path)
                        const fullDestinationUrl = new URL(apiNewPath, aemHost).toString();
                        
                        // Clone the headers to avoid mutation issues
                        const requestHeaders = new Headers(headers);
                        
                        // Add MOVE-specific headers
                        requestHeaders.append('X-Destination', fullDestinationUrl);
                        requestHeaders.append('X-Overwrite', 'T');
                        
                        // Log the actual request details
                        addToLog(`Sending MOVE request via CORS proxy`, 'info');
                        addToLog(`Source: ${targetUrl}`, 'info');
                        addToLog(`Destination: ${fullDestinationUrl}`, 'info');
                        
                        // Make the actual API call through the CORS proxy
                        const response = await fetch(corsProxyUrl, {
                            method: 'MOVE',
                            headers: requestHeaders,
                        });
                        
                        // Process the response
                        if (response.ok) {
                            addToLog(`Successfully renamed: ${originalPath} → ${newPath}`, 'success');
                            successCount++;
                        } else {
                            const errorText = await response.text().catch(() => 'Unknown error');
                            addToLog(`Failed to rename: ${originalPath}. Status: ${response.status}. Error: ${errorText}`, 'error');
                            failureCount++;
                        }
                    } catch (error) {
                        addToLog(`Error processing ${originalPath}: ${error.message}`, 'error');
                        failureCount++;
                    }
                    
                    // Small delay between operations to avoid overwhelming the server
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // Update counters in UI
                document.getElementById('successCount').textContent = successCount;
                document.getElementById('failureCount').textContent = failureCount;
                
                // Log completion
                addToLog(`Operation completed. ${successCount} successful, ${failureCount} failed.`, 'header');
            }
            
            // Execute metadata updates
            async function executeMetadataUpdates() {
                // Check if authenticated before proceeding
                if (!isAuthenticated) {
                    showNotification('Please authenticate before executing metadata updates', 'error');
                    return;
                }
                
                // Show results section
                resultsSection.classList.remove('hidden');
                metadataPreviewSection.classList.add('hidden');
                
                // Get AEM host
                const aemHost = document.getElementById('aemHost').value.trim();
                if (!aemHost) {
                    showNotification('Please provide an AEM host URL', 'error');
                    addToLog('Error: AEM host URL is required', 'error');
                    return;
                }
                
                // Initialize counters
                let successCount = 0;
                let failureCount = 0;
                
                // Log header
                addToLog('Starting metadata update operation...', 'header');
                
                // Get authentication headers
                const headers = getAuthHeaders();
                
                // Process each asset
                for (const update of metadataUpdates) {
                    try {
                        // Log start of operation
                        addToLog(`Updating metadata for: ${update.assetPath}`, 'info');
                        
                        // Prepare API path - direct path to the asset
                        const apiPath = buildApiPath(update.assetPath);
                        
                        // Prepare request body
                        const requestBody = {
                            class: "asset",
                            properties: update.properties
                        };
                        
                        // Create the full URL with CORS proxy
                        const targetUrl = new URL(apiPath, aemHost).toString();
                        
                        // Try different request methods in order of preference - all through CORS proxy
                        const requestMethods = [
                            { name: 'Original CORS Proxy (Fixed)', url: 'https://cors-proxy.philipp-koch.workers.dev/corsproxy/?apiurl=' + encodeURIComponent(targetUrl) },
                            { name: 'CORS-Anywhere', url: 'https://cors-anywhere.herokuapp.com/' + targetUrl },
                            { name: 'AllOrigins CORS Proxy', url: 'https://api.allorigins.win/raw?url=' + encodeURIComponent(targetUrl) }
                        ];
                        
                        const currentMethod = requestMethods[0];
                        const corsProxyUrl = currentMethod.url;
                        addToLog(`Using method: ${currentMethod.name}`, 'info');
                        
                        // Clone the headers to avoid mutation issues
                        const requestHeaders = new Headers(headers);
                        
                        // Add content-type header for JSON payload
                        requestHeaders.set('Content-Type', 'application/json');
                        
                        // Log the actual request details
                        addToLog(`Sending PUT request via CORS proxy`, 'info');
                        addToLog(`URL: ${targetUrl}`, 'info');
                        addToLog(`CORS Proxy URL: ${corsProxyUrl}`, 'info');
                        addToLog(`Headers: ${JSON.stringify(Object.fromEntries(requestHeaders.entries()))}`, 'info');
                        addToLog(`Body: ${JSON.stringify(requestBody)}`, 'info');
                        
                        // First, test if the CORS proxy is reachable with a simple GET
                        try {
                            addToLog(`Testing CORS proxy connectivity...`, 'info');
                            const testUrl = new URL('/api/assets.json?limit=1', aemHost).toString();
                            const testCorsProxyUrl = 'https://cors-proxy.philipp-koch.workers.dev/corsproxy/?apiurl=' + encodeURIComponent(testUrl);
                            const testResponse = await fetch(testCorsProxyUrl, {
                                method: 'GET',
                                headers: getAuthHeaders()
                            });
                            addToLog(`CORS proxy test status: ${testResponse.status} (${testUrl})`, testResponse.ok ? 'info' : 'error');
                        } catch (testError) {
                            addToLog(`CORS proxy test failed: ${testError.message}`, 'error');
                        }
                        
                        // Make the actual API call through the CORS proxy
                        addToLog(`About to send PUT request...`, 'info');
                        let response;
                        try {
                            response = await fetch(corsProxyUrl, {
                                method: 'PUT',
                                headers: requestHeaders,
                                body: JSON.stringify(requestBody)
                            });
                            addToLog(`PUT request completed with status: ${response.status}`, response.ok ? 'info' : 'error');
                        } catch (fetchError) {
                            addToLog(`PUT request failed with error: ${fetchError.message}`, 'error');
                            addToLog(`Error type: ${fetchError.name}`, 'error');
                            addToLog(`Error stack: ${fetchError.stack}`, 'error');
                            throw fetchError; // Re-throw to trigger the outer catch block
                        }
                        
                        // Process the response
                        if (response.ok) {
                            const propertiesList = Object.entries(update.properties)
                                .map(([key, value]) => `${key}: ${value}`)
                                .join(', ');
                                
                            addToLog(`Successfully updated metadata for: ${update.assetPath} (${propertiesList})`, 'success');
                            successCount++;
                        } else {
                            const errorText = await response.text().catch(() => 'Unknown error');
                            addToLog(`Failed to update metadata for: ${update.assetPath}. Status: ${response.status}. Error: ${errorText}`, 'error');
                            failureCount++;
                        }
                    } catch (error) {
                        addToLog(`Error processing ${update.assetPath}: ${error.message}`, 'error');
                        failureCount++;
                    }
                    
                    // Small delay between operations to avoid overwhelming the server
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // Update counters in UI
                document.getElementById('successCount').textContent = successCount;
                document.getElementById('failureCount').textContent = failureCount;
                
                // Log completion
                addToLog(`Operation completed. ${successCount} successful, ${failureCount} failed.`, 'header');
            }
            
            // Helper function to build API path from asset path
            function buildApiPath(path) {
                // Ensure the path has a leading slash
                if (!path.startsWith('/')) {
                    path = '/' + path;
                }
                
                // For the AEM Assets HTTP API:
                // If the path starts with /content/dam, we need to REMOVE it and replace with /api/assets
                // If the path is already in the right format, leave it as is
                
                if (path.startsWith('/content/dam/')) {
                    // Remove /content/dam prefix and replace with /api/assets
                    return '/api/assets' + path.substring('/content/dam'.length);
                } else if (path === '/content/dam') {
                    // Special case for root DAM folder
                    return '/api/assets';
                } else if (path.startsWith('/content/dam')) {
                    // Handle edge case with no trailing slash
                    return '/api/assets' + path.substring('/content/dam'.length);
                } else if (path.startsWith('/api/assets')) {
                    // Path is already in API format
                    return path;
                } else {
                    // Assume this is a relative path within DAM
                    // Add the /api/assets prefix directly
                    return '/api/assets' + path;
                }
            }
            
            // Get auth headers - prioritize IMS token when available, fall back to basic auth
            function getAuthHeaders() {
                const headers = new Headers();
                
                // Check for IMS token first
                const imsToken = document.getElementById('imsToken').value.trim();
                
                if (imsToken) {
                    // Use bearer token if available, regardless of selected auth method
                    headers.append('Authorization', `Bearer ${imsToken}`);
                    console.log('Using Bearer token authentication for API request');
                } else {
                    // Fall back to basic auth
                    const username = document.getElementById('username').value.trim();
                    const password = document.getElementById('password').value.trim();
                    
                    if (username && password) {
                        const basicAuth = btoa(`${username}:${password}`);
                        headers.append('Authorization', `Basic ${basicAuth}`);
                        console.log('Using Basic authentication for API request');
                    } else {
                        console.warn('No authentication credentials available');
                    }
                }
                
                return headers;
            }
            
            // Add entry to results log
            function addToLog(message, type = 'info') {
                const logEntry = document.createElement('div');
                logEntry.className = 'mb-1';
                
                switch (type) {
                    case 'header':
                        logEntry.className += ' font-bold text-primary dark:text-primary border-b pb-1 border-gray-300 dark:border-gray-600 mt-2';
                        break;
                    case 'success':
                        logEntry.className += ' text-green-600 dark:text-green-400';
                        break;
                    case 'error':
                        logEntry.className += ' text-red-600 dark:text-red-400';
                        break;
                    case 'info':
                    default:
                        logEntry.className += ' text-gray-700 dark:text-gray-300';
                        break;
                }
                
                logEntry.textContent = message;
                resultsLog.appendChild(logEntry);
                
                // Auto-scroll to bottom
                resultsLog.scrollTop = resultsLog.scrollHeight;
            }
            
            // Create demo assets for testing without authentication
            function createDemoSearchData() {
                // Sample SKUs to demonstrate with
                const demoSkus = [
                    'SKU12345', 'SKU98765', 'PROD-123', 'ITEM-456', 'ASSET-789'
                ];
                
                // Predefined asset types with corresponding thumbnail URLs and metadata
                const assetTypes = [
                    { 
                        ext: 'jpg', 
                        type: 'Image', 
                        icon: 'https://cdn.jsdelivr.net/npm/heroicons/24/outline/esm/photo.svg',
                        assetType: 'Product Imagery',
                        productShot: 'Product Silo'
                    },
                    { 
                        ext: 'png', 
                        type: 'Image', 
                        icon: 'https://cdn.jsdelivr.net/npm/heroicons/24/outline/esm/photo.svg',
                        assetType: 'Application Imagery',
                        productShot: 'Application Detail'
                    },
                    { 
                        ext: 'pdf', 
                        type: 'Document', 
                        icon: 'https://cdn.jsdelivr.net/npm/heroicons/24/outline/esm/document-text.svg',
                        assetType: 'PDF/Literature',
                        productShot: null
                    },
                    { 
                        ext: 'mp4', 
                        type: 'Video', 
                        icon: 'https://cdn.jsdelivr.net/npm/heroicons/24/outline/esm/film.svg',
                        assetType: 'Video',
                        productShot: 'Web Banner'
                    },
                    { 
                        ext: 'psd', 
                        type: 'Design', 
                        icon: 'https://cdn.jsdelivr.net/npm/heroicons/24/outline/esm/adjustments-horizontal.svg',
                        assetType: 'Web Imagery',
                        productShot: 'Web Silo Backgrounds'
                    },
                    { 
                        ext: 'jpg', 
                        type: 'Image', 
                        icon: 'https://cdn.jsdelivr.net/npm/heroicons/24/outline/esm/photo.svg',
                        assetType: 'Line Art',
                        productShot: null
                    },
                    { 
                        ext: 'jpg', 
                        type: 'Image', 
                        icon: 'https://cdn.jsdelivr.net/npm/heroicons/24/outline/esm/photo.svg',
                        assetType: 'Logos',
                        productShot: null
                    },
                    { 
                        ext: 'jpg', 
                        type: 'Image', 
                        icon: 'https://cdn.jsdelivr.net/npm/heroicons/24/outline/esm/photo.svg',
                        assetType: 'Social Media',
                        productShot: null
                    },
                    { 
                        ext: 'dwg', 
                        type: 'CAD', 
                        icon: 'https://cdn.jsdelivr.net/npm/heroicons/24/outline/esm/cube.svg',
                        assetType: 'CAD',
                        productShot: 'Product Silo Detail'
                    },
                    { 
                        ext: 'jpg', 
                        type: 'Image', 
                        icon: 'https://cdn.jsdelivr.net/npm/heroicons/24/outline/esm/photo.svg',
                        assetType: 'Event Imagery',
                        productShot: null
                    },
                    { 
                        ext: 'jpg', 
                        type: 'Image', 
                        icon: 'https://cdn.jsdelivr.net/npm/heroicons/24/outline/esm/photo.svg',
                        assetType: 'Partnership Imagery',
                        productShot: null
                    }
                ];
                
                // Sample folders to make paths more realistic
                const folders = [
                    '/content/dam/marketing/products', 
                    '/content/dam/social/campaigns', 
                    '/content/dam/catalog/items',
                    '/content/dam/projects/2023'
                ];
                
                // Generate demo results
                const results = [];
                
                // For each SKU, create a group of related assets
                demoSkus.forEach(sku => {
                    // Determine how many assets to generate for this SKU (2-7)
                    const assetCount = Math.floor(Math.random() * 6) + 2;
                    const assets = [];
                    
                    // Generate assets for this SKU
                    for (let i = 0; i < assetCount; i++) {
                        // Pick a random asset type
                        const assetType = assetTypes[Math.floor(Math.random() * assetTypes.length)];
                        // Pick a random folder
                        const folder = folders[Math.floor(Math.random() * folders.length)];
                        
                        // Create variations of filenames with the SKU
                        let filename;
                        if (i === 0) {
                            filename = `${sku}.${assetType.ext}`; // Simple naming
                        } else if (i === 1) {
                            filename = `${sku}_variant${i}.${assetType.ext}`; // With variant
                        } else if (i === 2) {
                            filename = `product_${sku}_detail.${assetType.ext}`; // Product detail
                        } else {
                            const descriptions = ['front', 'back', 'side', 'packaging', 'lifestyle', 'detail'];
                            const desc = descriptions[i % descriptions.length];
                            filename = `${sku}_${desc}.${assetType.ext}`; // With description
                        }
                        
                        // Full asset path
                        const path = `${folder}/${sku}/${filename}`;
                        
                        // Demo thumbnail URL - using placeholder images for demo purposes
                        let thumbnailUrl = '';
                        if (assetType.ext === 'jpg' || assetType.ext === 'png') {
                            // Use placeholder images for image assets
                            const width = 200;
                            const height = 200;
                            const imageId = Math.floor(Math.random() * 1000);
                            thumbnailUrl = `https://picsum.photos/id/${imageId}/${width}/${height}`;
                        } else {
                            // Use icon for non-image assets
                            thumbnailUrl = assetType.icon;
                        }
                        
                        // Generate a random ID
                        const id = Math.random().toString(36).substring(2, 15);
                        
                        // Create the asset object
                        assets.push({
                            id: id,
                            path: path,
                            name: filename,
                            thumbnailUrl: thumbnailUrl,
                            originalUrl: path, // In a real scenario, this would be a different URL
                            lastModified: new Date(Date.now() - Math.random() * 10000000000).toISOString(),
                            metadata: {
                                'dc:title': `${sku} ${assetType.type}`,
                                'dc:description': `Demo asset for ${sku} showing ${assetType.type.toLowerCase()} content`,
                                'xmp:CreatorTool': 'Adobe Photoshop',
                                'sku': sku
                            }
                        });
                    }
                    
                    // Add this SKU's assets to the results
                    results.push({
                        sku: sku,
                        assets: assets
                    });
                });
                
                return results;
            }
            
            // Perform bulk search
            async function performSearch() {
                if (!sheetData || sheetData.length <= 1) {
                    showNotification('No data to process', 'error');
                    return;
                }
                
                // Check if authenticated or if we should use demo mode
                const aemHost = document.getElementById('aemHost').value.trim();
                const isDemoMode = !isAuthenticated || !aemHost;
                
                if (isDemoMode) {
                    // Show notification about demo mode
                    showNotification('Showing demo content - authenticate with an AEM host for real search results', 'info', 7000);
                } else {
                    // In real mode, require authentication
                    if (!isAuthenticated) {
                        showNotification('Please authenticate before performing search', 'error');
                        return;
                    }
                }
                
                try {
                    // Get selected column index for SKUs
                    const skuColumnIndex = parseInt(assetPathColumnSelect.value);
                    
                    // Skip header row
                    const dataRows = sheetData.slice(1);
                    
                    // Get SKUs from selected column
                    const skus = dataRows.map(row => {
                        return row[skuColumnIndex] || '';
                    }).filter(sku => sku.trim() !== '');
                    
                    if (skus.length === 0) {
                        showNotification('No SKUs found in the selected column', 'warning');
                        return;
                    }
                    
                    // Get search configuration
                    const basePath = document.getElementById('searchBasePath').value.trim();
                    const resultsLimit = parseInt(document.getElementById('searchResultsLimit').value) || 100;
                    
                    // Get search property configuration
                    const searchMetadataProperty = document.getElementById('searchMetadataProperty').value;
                    const customProperty = document.getElementById('customSearchProperty').value.trim();
                    const searchInFilename = document.getElementById('searchInFilename').checked;
                    const searchInTags = document.getElementById('searchInTags').checked;
                    
                    // Determine the actual property to search
                    let primaryProperty = searchMetadataProperty;
                    if (searchMetadataProperty === 'custom' && customProperty) {
                        primaryProperty = customProperty;
                    }
                    
                    // Show loading state
                    const searchResultsContainer = document.getElementById('searchResultsContainer');
                    searchResultsContainer.innerHTML = `
                        <div class="py-20 flex flex-col items-center justify-center">
                            <div class="loader w-12 h-12 border-4 border-gray-300 dark:border-gray-600 rounded-full"></div>
                            <p class="mt-4 text-gray-600 dark:text-gray-400">Searching for ${skus.length} SKUs...</p>
                        </div>
                    `;
                    
                    // Show search results section
                    document.getElementById('searchResultsSection').classList.remove('hidden');
                    document.getElementById('searchConfigSection').classList.add('hidden');
                    
                    // Check if we're in demo mode
                    if (isDemoMode) {
                        // Simulate search delay for more realism
                        await new Promise(resolve => setTimeout(resolve, 1500));
                        
                        // Generate and use demo data instead of making API calls
                        let demoResults = createDemoSearchData();
                        
                        // Filter demo results to match SKUs from input if possible
                        if (skus.length > 0) {
                            // For each SKU in the data, try to find a matching demo SKU or create a new one
                            let combinedResults = [];
                            
                            skus.forEach(sku => {
                                // Look for exact match first
                                let match = demoResults.find(result => result.sku.toLowerCase() === sku.toLowerCase());
                                
                                // If no exact match, look for partial match
                                if (!match) {
                                    match = demoResults.find(result => 
                                        result.sku.toLowerCase().includes(sku.toLowerCase()) || 
                                        sku.toLowerCase().includes(result.sku.toLowerCase())
                                    );
                                }
                                
                                if (match) {
                                    // Use this match but update SKU to match input
                                    const copy = JSON.parse(JSON.stringify(match));
                                    copy.sku = sku;
                                    
                                    // Update assets to reference this SKU
                                    copy.assets.forEach(asset => {
                                        // Update paths and other properties to match the SKU
                                        const oldSku = match.sku;
                                        asset.path = asset.path.replace(oldSku, sku);
                                        asset.name = asset.name.replace(oldSku, sku);
                                        if (asset.metadata && asset.metadata.sku) {
                                            asset.metadata.sku = sku;
                                        }
                                    });
                                    
                                    combinedResults.push(copy);
                                } else {
                                    // Create a new demo result for this SKU
                                    // Use first demo result as template
                                    if (demoResults.length > 0) {
                                        const template = demoResults[0];
                                        const copy = JSON.parse(JSON.stringify(template));
                                        copy.sku = sku;
                                        
                                        // Update assets to reference this SKU
                                        copy.assets.forEach(asset => {
                                            const oldSku = template.sku;
                                            asset.path = asset.path.replace(oldSku, sku);
                                            asset.name = asset.name.replace(oldSku, sku);
                                            if (asset.metadata && asset.metadata.sku) {
                                                asset.metadata.sku = sku;
                                            }
                                        });
                                        
                                        combinedResults.push(copy);
                                    }
                                }
                            });
                            
                            // If we created custom results, use those
                            if (combinedResults.length > 0) {
                                demoResults = combinedResults;
                            }
                        }
                        
                        // Display demo results
                        displaySearchResults(demoResults);
                        return;
                    }
                    
                    // Continue with real API calls (non-demo mode)
                    
                    // Get AEM host
                    const aemHost = document.getElementById('aemHost').value.trim();
                    if (!aemHost) {
                        showNotification('Please provide an AEM host URL', 'error');
                        return;
                    }
                    
                    // Get authentication headers
                    const headers = getAuthHeaders();
                    
                    // Initialize search results
                    const searchResults = [];
                    let totalFound = 0;
                    
                    // Process SKUs in batches to avoid overwhelming the server
                    const batchSize = 5;
                    const batches = [];
                    
                    for (let i = 0; i < skus.length; i += batchSize) {
                        batches.push(skus.slice(i, i + batchSize));
                    }
                    
                    for (let i = 0; i < batches.length; i++) {
                        const batchSkus = batches[i];
                        const batchPromises = batchSkus.map(sku => searchAssetsForSku(aemHost, sku, basePath, resultsLimit, { primaryProperty, searchInFilename, searchInTags }, headers));
                        
                        // Update progress message
                        searchResultsContainer.innerHTML = `
                            <div class="py-20 flex flex-col items-center justify-center">
                                <div class="loader w-12 h-12 border-4 border-gray-300 dark:border-gray-600 rounded-full"></div>
                                <p class="mt-4 text-gray-600 dark:text-gray-400">
                                    Searching batch ${i + 1} of ${batches.length}... (${totalFound} assets found so far)
                                </p>
                            </div>
                        `;
                        
                        // Process batch
                        const batchResults = await Promise.all(batchPromises);
                        
                        // Add results to total
                        batchResults.forEach(result => {
                            if (result.assets && result.assets.length > 0) {
                                searchResults.push({
                                    sku: result.sku,
                                    assets: result.assets
                                });
                                totalFound += result.assets.length;
                            }
                        });
                        
                        // Small delay between batches
                        await new Promise(resolve => setTimeout(resolve, 300));
                    }
                    
                    // Display results
                    displaySearchResults(searchResults);
                    
                } catch (error) {
                    showNotification('Error performing search: ' + error.message, 'error');
                    console.error(error);
                }
            }
            
            // Search AEM for assets matching a SKU using Query Builder API
            async function searchAssetsForSku(aemHost, sku, basePath, limit, searchOptions, headers) {
                try {
                    // Build the Query Builder API URL
                    let apiPath = '/bin/querybuilder.json';
                    
                    // Add query parameters for Query Builder - simplified format
                    const params = new URLSearchParams();
                    
                    // Set the search path
                    params.append('path', basePath || '/content/dam');
                    
                    // Set asset type
                    params.append('type', 'dam:Asset');
                    
                    // Add limit with proper Query Builder syntax
                    params.append('p.limit', limit.toString());
                    params.append('p.guessTotal', 'true');
                    
                    // Search in the primary metadata property (simplified format)
                    if (searchOptions.primaryProperty) {
                        params.append('property', searchOptions.primaryProperty);
                        params.append('property.value', sku); // No wildcards, simple exact search
                    }
                    
                    // Create the full URL with CORS proxy
                    const targetUrl = new URL(apiPath + '?' + params.toString(), aemHost).toString();
                    const corsProxyUrl = 'https://cors-proxy.philipp-koch.workers.dev/corsproxy/?apiurl=' + encodeURIComponent(targetUrl);
                    
                    // Make the API call
                    const response = await fetch(corsProxyUrl, {
                        method: 'GET',
                        headers: headers
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Search failed: ${response.status} ${response.statusText}`);
                    }
                    
                    // Process response
                    const data = await response.json();
                    
                    // Extract assets from Query Builder response
                    const assets = [];
                    
                    if (data && data.success && data.hits) {
                        for (const hit of data.hits) {
                            const assetPath = hit.path || '';
                            const filename = hit.name || assetPath.split('/').pop() || '';
                            const title = hit.title || '';
                            const excerpt = hit.excerpt || '';
                            
                            // Since Query Builder already filtered by the property, trust all returned hits
                            // No additional client-side filtering needed
                            
                            // Generate thumbnail URL (standard AEM pattern)
                            const thumbnailUrl = `${aemHost}${assetPath}/_jcr_content/renditions/cq5dam.thumbnail.319.319.png`;
                            
                            // Get original asset URL  
                            const originalUrl = `${aemHost}${assetPath}`;
                            
                            // Add to results
                            assets.push({
                                id: Math.random().toString(36).substring(2, 15),
                                path: assetPath,
                                name: filename,
                                title: title,
                                thumbnailUrl: thumbnailUrl,
                                originalUrl: originalUrl,
                                lastModified: hit.lastModified || '',
                                excerpt: excerpt,
                                metadata: {
                                    'dc:title': title,
                                    'sku': sku // Add the searched SKU for reference
                                }
                            });
                        }
                    }
                    
                    return {
                        sku: sku,
                        assets: assets,
                        total: data?.total || 0,
                        queryUrl: targetUrl // For debugging
                    };
                } catch (error) {
                    console.error(`Error searching for SKU ${sku}:`, error);
                    return {
                        sku: sku,
                        assets: [],
                        error: error.message
                    };
                }
            }
            
            // Display search results in the UI
            function displaySearchResults(results) {
                const container = document.getElementById('searchResultsContainer');
                const selectedCountElement = document.getElementById('selectedCount');
                const totalResultsCountElement = document.getElementById('totalResultsCount');
                const downloadButton = document.getElementById('downloadSelectedBtn');
                
                // Clear container
                container.innerHTML = '';
                
                // Count total assets
                let totalAssets = 0;
                results.forEach(result => totalAssets += result.assets.length);
                
                // Update total count
                totalResultsCountElement.textContent = totalAssets.toString();
                selectedCountElement.textContent = '0';
                
                // Disable download button initially
                downloadButton.disabled = true;
                
                // Check if we have results
                if (results.length === 0 || totalAssets === 0) {
                    container.innerHTML = `
                        <div class="py-20 text-center text-gray-500 dark:text-gray-400">
                            No assets found matching your search criteria
                        </div>
                    `;
                    return;
                }
                
                // Create results for each SKU
                results.forEach(result => {
                    if (result.assets.length === 0) return;
                    
                    // Create SKU group
                    const skuGroup = document.createElement('div');
                    skuGroup.className = 'sku-group';
                    skuGroup.setAttribute('data-sku', result.sku);
                    
                    // Add SKU header
                    const skuHeader = document.createElement('div');
                    skuHeader.className = 'bg-gray-50 dark:bg-gray-700 px-4 py-2 font-medium sticky top-0 z-10';
                    skuHeader.textContent = `SKU: ${result.sku} (${result.assets.length} assets)`;
                    skuGroup.appendChild(skuHeader);
                    
                    // Add assets
                    result.assets.forEach(asset => {
                        const assetRow = document.createElement('div');
                        assetRow.className = 'asset-row flex items-center p-4 border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800';
                        assetRow.setAttribute('data-path', asset.path);
                        assetRow.setAttribute('data-name', asset.name);
                        assetRow.setAttribute('data-sku', result.sku);
                        
                        // Checkbox
                        const checkbox = document.createElement('div');
                        checkbox.className = 'w-7 mr-2';
                        checkbox.innerHTML = `
                            <input type="checkbox" class="asset-checkbox form-checkbox h-5 w-5 text-primary rounded" data-id="${asset.id}" data-url="${asset.originalUrl}">
                        `;
                        assetRow.appendChild(checkbox);
                        
                        // SKU cell
                        const skuCell = document.createElement('div');
                        skuCell.className = 'w-28 text-sm';
                        skuCell.textContent = result.sku;
                        assetRow.appendChild(skuCell);
                        
                        // Asset preview cell
                        const assetCell = document.createElement('div');
                        assetCell.className = 'flex-1 flex items-center';
                        
                        // Thumbnail container
                        const thumbnailContainer = document.createElement('div');
                        thumbnailContainer.className = 'w-16 h-16 flex items-center justify-center bg-gray-100 dark:bg-gray-800 mr-3';
                        
                        if (asset.thumbnailUrl) {
                            // Show loading spinner initially
                            thumbnailContainer.innerHTML = `
                                <div class="animate-spin rounded-full h-6 w-6 border-2 border-gray-300 border-t-2 border-t-primary"></div>
                            `;
                        } else {
                            // Placeholder for no thumbnail
                            thumbnailContainer.innerHTML = `
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                        `;
                        }
                        
                        // Asset info container
                        const assetInfo = document.createElement('div');
                        assetInfo.innerHTML = `
                            <div class="font-medium text-sm">${asset.name}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">${asset.path}</div>
                        `;
                        
                        // Append elements to asset cell
                        assetCell.appendChild(thumbnailContainer);
                        assetCell.appendChild(assetInfo);
                        
                        // Load image with authentication after DOM elements are connected
                        if (asset.thumbnailUrl) {
                            loadAuthenticatedImage(asset.thumbnailUrl, thumbnailContainer, asset.name);
                        }
                        
                        assetRow.appendChild(assetCell);
                        
                        // Add the asset row to the SKU group
                        skuGroup.appendChild(assetRow);
                        
                        // Add checkbox change handler
                        const checkboxInput = assetRow.querySelector('.asset-checkbox');
                        checkboxInput.addEventListener('change', updateSelectedCount);
                    });
                    
                    // Add the SKU group to the container
                    container.appendChild(skuGroup);
                });
                
                // Add event listener to container for delegation
                container.addEventListener('click', function(e) {
                    const assetRow = e.target.closest('.asset-row');
                    const checkbox = e.target.closest('.asset-checkbox');
                    
                    // If the user clicks on the row but not directly on the checkbox, toggle the checkbox
                    if (assetRow && !checkbox) {
                        const checkboxInput = assetRow.querySelector('.asset-checkbox');
                        checkboxInput.checked = !checkboxInput.checked;
                        updateSelectedCount();
                    }
                });
            }
            
            // Update the selected count
            function updateSelectedCount() {
                const selectedCount = document.querySelectorAll('.asset-checkbox:checked').length;
                document.getElementById('selectedCount').textContent = selectedCount.toString();
                document.getElementById('downloadSelectedBtn').disabled = selectedCount === 0;
            }
            
            // Filter search results based on user input and selected filters
            function filterSearchResults() {
                const filterValue = document.getElementById('searchResultsFilter').value.toLowerCase();
                const assetTypeFilter = document.getElementById('assetTypeFilter').value;
                const productShotFilter = document.getElementById('productShotFilter').value;
                
                const assetRows = document.querySelectorAll('.asset-row');
                const skuGroups = document.querySelectorAll('.sku-group');
                
                // Clear "select all" checkbox when filtering
                document.getElementById('selectAllCheckbox').checked = false;
                
                // Reset visibility of all groups first
                skuGroups.forEach(group => {
                    group.classList.remove('hidden');
                });
                
                // Filter asset rows
                assetRows.forEach(row => {
                    const path = row.getAttribute('data-path').toLowerCase();
                    const name = row.getAttribute('data-name').toLowerCase();
                    const sku = row.getAttribute('data-sku').toLowerCase();
                    
                    // Get the row's asset data for filtering by asset type and product shot
                    // In a real implementation, this data would come from the asset's metadata
                    // For demo purposes, we'll determine it based on the file extension and path
                    
                    // Calculate asset type
                    let assetType = '';
                    if (path.includes('/marketing/')) {
                        assetType = 'Product Imagery';
                    } else if (path.includes('/social/')) {
                        assetType = 'Social Media';
                    } else if (name.endsWith('.pdf')) {
                        assetType = 'PDF/Literature';
                    } else if (name.endsWith('.mp4')) {
                        assetType = 'Video';
                    } else if (name.endsWith('.dwg')) {
                        assetType = 'CAD';
                    } else if (name.includes('logo')) {
                        assetType = 'Logos';
                    } else if (name.includes('web')) {
                        assetType = 'Web Imagery';
                    } else if (name.includes('event')) {
                        assetType = 'Event Imagery';
                    } else if (name.includes('line') || name.includes('art')) {
                        assetType = 'Line Art';
                    } else if (name.includes('application') || name.includes('app')) {
                        assetType = 'Application Imagery';
                    } else if (name.includes('partner')) {
                        assetType = 'Partnership Imagery';
                    }
                    
                    // Calculate product shot type
                    let productShot = '';
                    if (name.includes('silo') && name.includes('detail')) {
                        productShot = 'Product Silo Detail';
                    } else if (name.includes('silo') && name.includes('background')) {
                        productShot = 'Web Silo Backgrounds';
                    } else if (name.includes('silo')) {
                        productShot = 'Product Silo';
                    } else if (name.includes('detail') && (name.includes('app') || name.includes('application'))) {
                        productShot = 'Application Detail';
                    } else if (name.includes('app') || name.includes('application')) {
                        productShot = 'Application';
                    } else if (name.includes('banner') || name.includes('web')) {
                        productShot = 'Web Banner';
                    }
                    
                    // Store these attributes as data attributes so we can reference them later
                    row.setAttribute('data-asset-type', assetType);
                    row.setAttribute('data-product-shot', productShot);
                    
                    // Apply all filters
                    const matchesTextFilter = filterValue === '' || 
                        path.includes(filterValue) || 
                        name.includes(filterValue) || 
                        sku.includes(filterValue);
                    
                    const matchesAssetType = assetTypeFilter === '' || assetType === assetTypeFilter;
                    const matchesProductShot = productShotFilter === '' || productShot === productShotFilter;
                    
                    // Show/hide based on all filter criteria
                    if (matchesTextFilter && matchesAssetType && matchesProductShot) {
                        row.classList.remove('hidden');
                    } else {
                        row.classList.add('hidden');
                    }
                });
                
                // Hide empty SKU groups
                skuGroups.forEach(group => {
                    const visibleAssets = group.querySelectorAll('.asset-row:not(.hidden)');
                    if (visibleAssets.length === 0) {
                        group.classList.add('hidden');
                    }
                });
                
                // Update results count
                const visibleRows = document.querySelectorAll('.asset-row:not(.hidden)');
                document.getElementById('totalResultsCount').textContent = visibleRows.length.toString();
            }
            
            // Clear all active filters
            document.getElementById('clearFiltersBtn').addEventListener('click', function() {
                document.getElementById('searchResultsFilter').value = '';
                document.getElementById('assetTypeFilter').value = '';
                document.getElementById('productShotFilter').value = '';
                filterSearchResults();
            });
            
            // Add event listeners for dropdown filters
            document.getElementById('assetTypeFilter').addEventListener('change', filterSearchResults);
            document.getElementById('productShotFilter').addEventListener('change', filterSearchResults);
            
            // Toggle select all visible assets
            function toggleSelectAllAssets() {
                const selectAll = document.getElementById('selectAllCheckbox').checked;
                const visibleCheckboxes = document.querySelectorAll('.asset-row:not(.hidden) .asset-checkbox');
                
                visibleCheckboxes.forEach(checkbox => {
                    checkbox.checked = selectAll;
                });
                
                updateSelectedCount();
            }
            
            // Download selected assets
            function downloadSelectedAssets() {
                const selectedAssets = document.querySelectorAll('.asset-checkbox:checked');
                if (selectedAssets.length === 0) {
                    showNotification('No assets selected for download', 'warning');
                    return;
                }
                
                // Create a manifest of selected assets
                const assets = Array.from(selectedAssets).map(checkbox => {
                    const row = checkbox.closest('.asset-row');
                    return {
                        name: row.getAttribute('data-name'),
                        path: row.getAttribute('data-path'),
                        sku: row.getAttribute('data-sku'),
                        url: checkbox.getAttribute('data-url')
                    };
                });
                
                // Group assets by SKU for the manifest
                const assetsByGroup = {};
                assets.forEach(asset => {
                    if (!assetsByGroup[asset.sku]) {
                        assetsByGroup[asset.sku] = [];
                    }
                    assetsByGroup[asset.sku].push(asset);
                });
                
                // Create manifest JSON
                const manifest = {
                    totalCount: assets.length,
                    timestamp: new Date().toISOString(),
                    assets: assetsByGroup
                };
                
                // Create a blob with the manifest
                const manifestBlob = new Blob([JSON.stringify(manifest, null, 2)], { type: 'application/json' });
                
                // Create a download link for the manifest
                const downloadLink = document.createElement('a');
                downloadLink.href = URL.createObjectURL(manifestBlob);
                downloadLink.download = `asset-download-manifest-${new Date().toISOString().split('T')[0]}.json`;
                downloadLink.click();
                
                // Show instructions for downloading the actual assets
                const instructions = `
                    <p class="mb-3">A manifest with ${assets.length} selected assets has been downloaded.</p>
                    <p class="mb-3">To download the actual assets:</p>
                    <ol class="list-decimal pl-5 mb-3 space-y-1">
                        <li>Go to the AEM Assets admin interface</li>
                        <li>Import the manifest JSON file to facilitate batch downloading</li>
                        <li>Alternatively, click each of the following links to download assets directly:</li>
                    </ol>
                    <div class="text-xs mt-3 overflow-y-auto max-h-[200px] bg-gray-50 dark:bg-gray-800 p-3 rounded">
                        ${assets.slice(0, 20).map(a => `<a href="${a.url}" target="_blank" class="block mb-1 hover:underline">${a.name}</a>`).join('')}
                        ${assets.length > 20 ? `<div class="mt-2 font-medium">... and ${assets.length - 20} more assets</div>` : ''}
                    </div>
                `;
                
                // Show custom notification with download links
                const notification = showNotification(instructions, 'success', 0);
                notification.classList.add('w-[500px]', 'max-w-full');
                
                // Show success notification
                showNotification(`Download manifest created with ${assets.length} assets`, 'success');
            }
            
            // Cancel operation
            function cancelOperation() {
                renamePreviewSection.classList.add('hidden');
                metadataPreviewSection.classList.add('hidden');
                document.getElementById('deletePreviewSection').classList.add('hidden');
                document.getElementById('searchResultsSection').classList.add('hidden');
                
                // Show appropriate config section based on active tab
                if (currentTab === 'rename') {
                    renameConfigSection.classList.remove('hidden');
                } else if (currentTab === 'metadata') {
                    metadataConfigSection.classList.remove('hidden');
                } else if (currentTab === 'delete') {
                    document.getElementById('deleteConfigSection').classList.remove('hidden');
                } else if (currentTab === 'search') {
                    document.getElementById('searchConfigSection').classList.remove('hidden');
                }
            }
            
            // Reset app
            function resetApp() {
                // Reset file input
                fileInput.value = '';
                
                // Reset and hide sections
                sheetSelection.classList.add('hidden');
                assetPathColumnSelection.classList.add('hidden');
                renameConfigSection.classList.add('hidden');
                metadataConfigSection.classList.add('hidden');
                renamePreviewSection.classList.add('hidden');
                metadataPreviewSection.classList.add('hidden');
                resultsSection.classList.add('hidden');
                excelPreview.classList.add('hidden');
                
                // Clear data
                workbook = null;
                selectedSheet = null;
                sheetData = null;
                assetPaths = [];
                renamedPaths = [];
                metadataUpdates = [];
                
                // Clear results log
                resultsLog.innerHTML = '';
            }
            
            // Setup collapsible panel functionality
            function setupCollapsiblePanel() {
                const authHeader = document.getElementById('authHeader');
                const authPanel = document.getElementById('authPanel');
                const toggleIcon = document.querySelector('.auth-toggle-icon');
                
                // Store panel state
                let isPanelOpen = false;
                
                // Function to toggle panel state
                function togglePanel() {
                    isPanelOpen = !isPanelOpen;
                    
                    if (isPanelOpen) {
                        // Open panel
                        authPanel.style.maxHeight = '1000px';
                        authPanel.style.opacity = '1';
                        toggleIcon.style.transform = 'rotate(0deg)';
                        authHeader.setAttribute('aria-expanded', 'true');
                    } else {
                        // Close panel
                        authPanel.style.maxHeight = '0';
                        authPanel.style.opacity = '0';
                        toggleIcon.style.transform = 'rotate(-90deg)';
                        authHeader.setAttribute('aria-expanded', 'false');
                    }
                }
                
                // Add click event listener to toggle panel
                authHeader.addEventListener('click', togglePanel);
                
                // Initialize panel state (closed by default)
                authHeader.setAttribute('aria-expanded', 'false');
                toggleIcon.style.transform = 'rotate(-90deg)';
            }
            
            // Load image with authentication headers
            async function loadAuthenticatedImage(imageUrl, container, altText) {
                try {
                    // Add CORS proxy for authenticated image loading
                    const corsProxyUrl = 'https://cors-proxy.philipp-koch.workers.dev/corsproxy/?apiurl=' + encodeURIComponent(imageUrl);
                    
                    // Get authentication headers
                    const headers = getAuthHeaders();
                    
                    // Fetch the image with authentication
                    const response = await fetch(corsProxyUrl, {
                        method: 'GET',
                        headers: headers
                    });
                    
                    if (response.ok) {
                        // Convert response to blob and create object URL
                        const blob = await response.blob();
                        const imageObjectUrl = URL.createObjectURL(blob);
                        
                        // Create and configure image element
                        const img = document.createElement('img');
                        img.src = imageObjectUrl;
                        img.alt = altText;
                        img.className = 'w-16 h-16 object-contain';
                        
                        // Replace loading spinner with image
                        container.innerHTML = '';
                        container.appendChild(img);
                        
                        // Clean up object URL after image loads
                        img.onload = () => {
                            setTimeout(() => URL.revokeObjectURL(imageObjectUrl), 1000);
                        };
                    } else {
                        throw new Error(`Failed to load image: ${response.status}`);
                    }
                } catch (error) {
                    console.warn('Failed to load authenticated image:', error);
                    
                    // Fall back to placeholder on error
                    container.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    `;
                }
            }
            
            // Notification system
            function showNotification(message, type = 'info', duration = 5000) {
                // Create notification element
                const notification = document.createElement('div');
                notification.className = 'notification fixed bottom-4 right-4 p-4 rounded-lg shadow-lg max-w-sm z-50 transform transition-transform duration-300 translate-y-full';
                
                // Set type-specific styles
                switch (type) {
                    case 'success':
                        notification.classList.add('bg-green-100', 'text-green-800', 'dark:bg-green-800', 'dark:text-green-100');
                        break;
                    case 'error':
                        notification.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-800', 'dark:text-red-100');
                        break;
                    case 'warning':
                        notification.classList.add('bg-yellow-100', 'text-yellow-800', 'dark:bg-yellow-800', 'dark:text-yellow-100');
                        break;
                    case 'info':
                    default:
                        notification.classList.add('bg-blue-100', 'text-blue-800', 'dark:bg-blue-800', 'dark:text-blue-100');
                        break;
                }
                
                // Set notification content
                notification.innerHTML = `
                    <div class="flex items-start">
                        <div class="flex-1">${message}</div>
                        <button type="button" class="ml-4 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                `;
                
                // Add to DOM
                document.body.appendChild(notification);
                
                // Animate in
                setTimeout(() => {
                    notification.classList.remove('translate-y-full');
                }, 10);
                
                // Close button handler
                const closeButton = notification.querySelector('button');
                closeButton.addEventListener('click', () => {
                    notification.classList.add('translate-y-full');
                    setTimeout(() => {
                        if (document.body.contains(notification)) {
                            document.body.removeChild(notification);
                        }
                    }, 300);
                });
                
                // Auto-remove after duration
                if (duration > 0) {
                    setTimeout(() => {
                        if (document.body.contains(notification)) {
                            notification.classList.add('translate-y-full');
                            setTimeout(() => {
                                if (document.body.contains(notification)) {
                                    document.body.removeChild(notification);
                                }
                            }, 300);
                        }
                    }, duration);
                }
                
                return notification;
            }
        });
    </script>
</body>
</html>
