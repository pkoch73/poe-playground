<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assets Bulk Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script defer type="text/javascript" src="https://rum.hlx.page/.rum/@adobe/helix-rum-js@^2/dist/rum-standalone.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    }
                }
            }
        }
    </script>
    <style>
        .loader {
            border-top-color: #5D5CDE;
            animation: spinner 1s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Dark mode support */
        .dark body {
            color-scheme: dark;
        }
        .dark .notification {
            @apply bg-gray-800 text-white;
        }
        .tab-active {
            @apply bg-primary text-white font-bold shadow-md relative;
        }
        .tab-active::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 8px;
            background-color: white;
            border-radius: 50%;
        }
        .tab-inactive {
            @apply bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors;
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">
    <!-- Check for dark mode -->
    <script>
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>

    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <h1 class="text-3xl font-bold text-center mb-8">Assets Bulk Tool</h1>
        
        <!-- Authentication Section -->
        <div class="mb-8 bg-white dark:bg-gray-800 rounded-lg shadow-md">
            <div class="p-4 flex justify-between items-center cursor-pointer" id="authHeader" aria-expanded="true" aria-controls="authPanel">
                <h2 class="text-xl font-semibold">Authentication</h2>
                <div class="auth-toggle-icon transition-transform duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
            </div>
            
            <div id="authPanel" class="px-6 pb-6 overflow-hidden transition-all duration-300 max-h-0 opacity-0">
                <div class="mb-4">
                    <div class="flex flex-col md:flex-row gap-4 mb-4">
                        <div class="flex-1">
                            <label for="aemHost" class="block text-sm font-medium mb-1">AEM Host</label>
                            <input type="text" id="aemHost" placeholder="http://localhost:4502" 
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base
                                focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent
                                dark:bg-gray-700 dark:text-white" />
                        </div>
                        <div class="flex-1">
                            <label for="username" class="block text-sm font-medium mb-1">Username</label>
                            <input type="text" id="username" placeholder="admin" 
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base
                                focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent
                                dark:bg-gray-700 dark:text-white" />
                        </div>
                        <div class="flex-1">
                            <label for="password" class="block text-sm font-medium mb-1">Password</label>
                            <input type="password" id="password" placeholder="********" 
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base
                                focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent
                                dark:bg-gray-700 dark:text-white" />
                        </div>
                    </div>
                    
                    <div class="flex flex-col md:flex-row items-center gap-4">
                        <button id="basicAuthBtn" class="px-4 py-2 bg-primary dark:bg-primary text-white rounded-md hover:bg-opacity-90 transition-colors">
                            Login with Basic Auth
                        </button>
                        <span class="text-sm text-gray-500 dark:text-gray-400">or</span>
                        <button id="imsAuthBtn" class="px-4 py-2 bg-[#FA0F00] text-white rounded-md hover:bg-opacity-90 transition-colors">
                            Login with Adobe IMS
                        </button>
                    </div>
                    
                    <div class="mt-6 border-t border-gray-200 dark:border-gray-700 pt-4">
                        <h3 class="text-sm font-semibold mb-2">Manual Token Entry (For Testing)</h3>
                        <div id="imsTokenSection">
                            <label for="imsToken" class="block text-sm font-medium mb-1">IMS Access Token</label>
                            <textarea id="imsToken" rows="2" placeholder="Paste your IMS token here for testing or if automatic detection fails"
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base
                                focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent
                                dark:bg-gray-700 dark:text-white"></textarea>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                Note: Bearer token authentication will be used automatically if a token is provided here.
                            </p>
                            <button id="testTokenBtn" class="mt-2 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-sm rounded-md hover:bg-opacity-90 transition-colors">
                                Validate Token
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="authStatus" class="hidden mt-4 p-3 rounded-md border">
                    <!-- Will be populated dynamically with authentication status -->
                </div>
            </div>
        </div>
        
        <!-- Tab Navigation -->
        <div class="mb-1">
            <h2 class="text-base font-medium text-gray-600 dark:text-gray-400 mb-2">Current Mode: <span id="currentTabLabel" class="font-bold text-primary">Asset Renamer</span></h2>
        </div>
        <div class="mb-6 flex space-x-1 rounded-lg bg-gray-100 dark:bg-gray-800 p-1 overflow-hidden">
            <button class="tab-button flex-1 py-2 px-4 rounded-md tab-active" data-tab="rename" data-label="Asset Renamer">Asset Renamer</button>
            <button class="tab-button flex-1 py-2 px-4 rounded-md tab-inactive" data-tab="metadata" data-label="Metadata Updater">Metadata Updater</button>
            <button class="tab-button flex-1 py-2 px-4 rounded-md tab-inactive" data-tab="delete" data-label="Bulk Delete">Bulk Delete</button>
        </div>
        
        <!-- File Input Section -->
        <div class="mb-8 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">Excel File Import</h2>
            
            <div class="mb-4">
                <label for="fileInput" class="block text-sm font-medium mb-1">Upload Excel File</label>
                <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" 
                    class="w-full text-base
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-md file:border-0
                    file:text-sm file:font-semibold
                    file:bg-primary file:text-white
                    hover:file:bg-opacity-90" />
            </div>
            
            <div id="fileProcessingStatus" class="my-3 py-2 px-3 bg-blue-50 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 rounded hidden">
                Processing file...
            </div>
            
            <div class="flex flex-col md:flex-row gap-4">
                <div id="sheetSelection" class="hidden flex-1">
                    <label for="sheetSelect" class="block text-sm font-medium mb-1">Select Sheet</label>
                    <select id="sheetSelect" 
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base
                        focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent
                        dark:bg-gray-700 dark:text-white">
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
                
                <div id="assetPathColumnSelection" class="hidden flex-1">
                    <label for="assetPathColumnSelect" class="block text-sm font-medium mb-1">Select Asset Path Column</label>
                    <select id="assetPathColumnSelect" 
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base
                        focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent
                        dark:bg-gray-700 dark:text-white">
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
            </div>
            
            <div id="excelPreview" class="mt-4 hidden">
                <h3 class="text-md font-medium mb-2">Excel File Preview</h3>
                <div class="overflow-x-auto max-h-[200px] border border-gray-300 dark:border-gray-600 rounded">
                    <table class="min-w-full divide-y divide-gray-300 dark:divide-gray-600">
                        <thead id="previewTableHead" class="bg-gray-100 dark:bg-gray-700">
                            <!-- Will be populated dynamically -->
                        </thead>
                        <tbody id="previewTableBody" class="divide-y divide-gray-200 dark:divide-gray-700 bg-white dark:bg-gray-800">
                            <!-- Will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Rename Configuration Section -->
        <div id="renameConfigSection" class="tab-content mb-8 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md hidden">
            <h2 class="text-xl font-semibold mb-4">Renaming Configuration</h2>
            
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Characters to Process</label>
                <div class="flex flex-wrap gap-3">
                    <label class="inline-flex items-center">
                        <input type="checkbox" checked class="char-checkbox form-checkbox h-5 w-5 text-primary" data-char="_">
                        <span class="ml-2">Underscore (_)</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="checkbox" class="char-checkbox form-checkbox h-5 w-5 text-primary" data-char=" ">
                        <span class="ml-2">Space ( )</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="checkbox" class="char-checkbox form-checkbox h-5 w-5 text-primary" data-char="-">
                        <span class="ml-2">Hyphen (-)</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="checkbox" class="char-checkbox form-checkbox h-5 w-5 text-primary" data-char=".">
                        <span class="ml-2">Period (.)</span>
                    </label>
                </div>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Action</label>
                <div class="flex gap-4">
                    <label class="inline-flex items-center">
                        <input type="radio" name="action" value="replace" checked 
                            class="form-radio h-5 w-5 text-primary">
                        <span class="ml-2">Replace with:</span>
                    </label>
                    <input type="text" id="replaceWith" value="-" placeholder="Replacement character" 
                        class="w-24 px-3 py-1 border border-gray-300 dark:border-gray-600 rounded-md text-base
                        focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent
                        dark:bg-gray-700 dark:text-white" />
                        
                    <label class="inline-flex items-center">
                        <input type="radio" name="action" value="remove" 
                            class="form-radio h-5 w-5 text-primary">
                        <span class="ml-2">Remove completely</span>
                    </label>
                </div>
            </div>
            
            <div class="mb-4">
                <button id="renamePreviewBtn" 
                    class="px-4 py-2 bg-primary text-white rounded-md hover:bg-opacity-90 transition-colors">
                    Preview Changes (Dry Run)
                </button>
            </div>
        </div>
        
        <!-- Metadata Configuration Section -->
        <div id="metadataConfigSection" class="tab-content mb-8 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md hidden">
            <h2 class="text-xl font-semibold mb-4">Metadata Configuration</h2>
            
            <div id="metadataMappingContainer" class="mb-6">
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-sm font-medium">Metadata Property Mappings</label>
                    <button id="addMappingBtn" class="text-primary hover:underline flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                        Add Property
                    </button>
                </div>
                
                <div id="mappingsContainer" class="space-y-3">
                    <!-- Initial mapping row -->
                    <div class="mapping-row flex flex-col md:flex-row gap-3 items-start md:items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-md">
                        <div class="flex-1">
                            <label class="block text-sm mb-1 text-gray-600 dark:text-gray-300">Property Name</label>
                            <input type="text" placeholder="dc:title" class="property-name w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-800 dark:text-white" value="dc:title" />
                        </div>
                        <div class="flex-1">
                            <label class="block text-sm mb-1 text-gray-600 dark:text-gray-300">Value Column</label>
                            <select class="value-column w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-800 dark:text-white">
                                <option value="">Select column</option>
                                <!-- Options will be populated dynamically -->
                            </select>
                        </div>
                        <div class="flex items-end justify-end h-full pt-6 md:pt-0">
                            <button class="remove-mapping p-1 text-red-500 hover:text-red-700 rounded-full hover:bg-red-100 dark:hover:bg-red-900">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                    <p>Common properties: dc:title, dc:description, jcr:lastModified, cq:tags</p>
                </div>
            </div>
            
            <div class="mb-4">
                <button id="metadataPreviewBtn" 
                    class="px-4 py-2 bg-primary text-white rounded-md hover:bg-opacity-90 transition-colors">
                    Preview Changes (Dry Run)
                </button>
            </div>
        </div>
        
        <!-- Delete Configuration Section -->
        <div id="deleteConfigSection" class="tab-content mb-8 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md hidden">
            <h2 class="text-xl font-semibold mb-4">Bulk Delete Configuration</h2>
            
            <div class="mb-6">
                <div class="p-3 bg-yellow-50 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-200 rounded-md border border-yellow-200 dark:border-yellow-700">
                    <div class="flex items-start">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mt-0.5 mr-2 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                        <div>
                            <p class="font-medium">Warning: Delete operations cannot be undone</p>
                            <p class="mt-1 text-sm">Assets will be permanently deleted and cannot be recovered unless you have a backup.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mb-4">
                <button id="deletePreviewBtn" 
                    class="px-4 py-2 bg-primary text-white rounded-md hover:bg-opacity-90 transition-colors">
                    Preview Deletions (Dry Run)
                </button>
            </div>
        </div>
        
        <!-- Rename Preview Section -->
        <div id="renamePreviewSection" class="tab-content mb-8 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md hidden">
            <h2 class="text-xl font-semibold mb-4">Rename Preview</h2>
            
            <div class="mb-6 overflow-auto max-h-[400px]">
                <table class="min-w-full divide-y divide-gray-300 dark:divide-gray-600">
                    <thead class="bg-gray-100 dark:bg-gray-700">
                        <tr>
                            <th scope="col" class="py-3 px-4 text-left text-sm font-semibold sticky top-0 bg-gray-100 dark:bg-gray-700">
                                Original Path
                            </th>
                            <th scope="col" class="py-3 px-4 text-left text-sm font-semibold sticky top-0 bg-gray-100 dark:bg-gray-700">
                                New Path
                            </th>
                        </tr>
                    </thead>
                    <tbody id="renamePreviewTableBody" class="divide-y divide-gray-200 dark:divide-gray-700">
                        <!-- Preview rows will be added here -->
                    </tbody>
                </table>
            </div>
            
            <div class="flex gap-4">
                <button id="executeRenameBtn" 
                    class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-opacity-90 transition-colors">
                    Execute Renames
                </button>
                <div id="renameAuthRequiredNote" class="text-sm text-gray-500 dark:text-gray-400 mt-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="inline-block h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Note: Authentication is required before executing renames
                </div>
                <button id="cancelRenameBtn" 
                    class="px-4 py-2 bg-gray-500 dark:bg-gray-600 text-white rounded-md hover:bg-opacity-90 transition-colors">
                    Cancel
                </button>
            </div>
        </div>
        
        <!-- Metadata Preview Section -->
        <div id="metadataPreviewSection" class="tab-content mb-8 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md hidden">
            <h2 class="text-xl font-semibold mb-4">Metadata Update Preview</h2>
            
            <div class="mb-6 overflow-auto max-h-[400px]">
                <table class="min-w-full divide-y divide-gray-300 dark:divide-gray-600">
                    <thead class="bg-gray-100 dark:bg-gray-700">
                        <tr>
                            <th scope="col" class="py-3 px-4 text-left text-sm font-semibold sticky top-0 bg-gray-100 dark:bg-gray-700">
                                Asset Path
                            </th>
                            <th scope="col" class="py-3 px-4 text-left text-sm font-semibold sticky top-0 bg-gray-100 dark:bg-gray-700">
                                Metadata Updates
                            </th>
                        </tr>
                    </thead>
                    <tbody id="metadataPreviewTableBody" class="divide-y divide-gray-200 dark:divide-gray-700">
                        <!-- Preview rows will be added here -->
                    </tbody>
                </table>
            </div>
            
            <div class="flex gap-4">
                <button id="executeMetadataBtn" 
                    class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-opacity-90 transition-colors">
                    Execute Metadata Updates
                </button>
                <div id="metadataAuthRequiredNote" class="text-sm text-gray-500 dark:text-gray-400 mt-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="inline-block h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Note: Authentication is required before executing metadata updates
                </div>
                <button id="cancelMetadataBtn" 
                    class="px-4 py-2 bg-gray-500 dark:bg-gray-600 text-white rounded-md hover:bg-opacity-90 transition-colors">
                    Cancel
                </button>
            </div>
        </div>
        
        <!-- Delete Preview Section -->
        <div id="deletePreviewSection" class="tab-content mb-8 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md hidden">
            <h2 class="text-xl font-semibold mb-4">Delete Preview</h2>
            
            <div class="mb-6 overflow-auto max-h-[400px]">
                <table class="min-w-full divide-y divide-gray-300 dark:divide-gray-600">
                    <thead class="bg-gray-100 dark:bg-gray-700">
                        <tr>
                            <th scope="col" class="py-3 px-4 text-left text-sm font-semibold sticky top-0 bg-gray-100 dark:bg-gray-700">
                                Asset Path
                            </th>
                            <th scope="col" class="py-3 px-4 text-left text-sm font-semibold sticky top-0 bg-gray-100 dark:bg-gray-700">
                                Action
                            </th>
                        </tr>
                    </thead>
                    <tbody id="deletePreviewTableBody" class="divide-y divide-gray-200 dark:divide-gray-700">
                        <!-- Preview rows will be added here -->
                    </tbody>
                </table>
            </div>
            
            <div class="mb-4 p-3 bg-yellow-50 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-200 rounded-md border border-yellow-200 dark:border-yellow-700">
                <div class="flex items-start">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mt-0.5 mr-2 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    <div>
                        <p class="font-medium">Warning: Delete operations cannot be undone</p>
                        <p class="mt-1">Please verify all assets before proceeding. This action will permanently delete the assets and cannot be recovered.</p>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-4">
                <button id="executeDeleteBtn" 
                    class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-opacity-90 transition-colors">
                    Execute Deletions
                </button>
                <div id="deleteAuthRequiredNote" class="text-sm text-gray-500 dark:text-gray-400 mt-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="inline-block h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Note: Authentication is required before executing deletions
                </div>
                <button id="cancelDeleteBtn" 
                    class="px-4 py-2 bg-gray-500 dark:bg-gray-600 text-white rounded-md hover:bg-opacity-90 transition-colors">
                    Cancel
                </button>
            </div>
        </div>
        
        <!-- Results Section -->
        <div id="resultsSection" class="mb-8 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md hidden">
            <h2 class="text-xl font-semibold mb-4">Execution Results</h2>
            
            <div class="mb-4 flex items-center gap-2">
                <div class="w-6 h-6 rounded-full bg-green-500 flex items-center justify-center text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                </div>
                <span id="successCount">0</span> <span class="text-sm text-gray-500 dark:text-gray-400">operations completed successfully</span>
            </div>
            
            <div class="mb-4 flex items-center gap-2">
                <div class="w-6 h-6 rounded-full bg-red-500 flex items-center justify-center text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </div>
                <span id="failureCount">0</span> <span class="text-sm text-gray-500 dark:text-gray-400">operations failed</span>
            </div>
            
            <div class="overflow-auto max-h-[300px]">
                <div id="resultsLog" class="p-4 bg-gray-100 dark:bg-gray-700 rounded-md font-mono text-sm">
                    <!-- Results log entries will be added here -->
                </div>
            </div>
            
            <div class="mt-4">
                <button id="resetBtn" 
                    class="px-4 py-2 bg-primary text-white rounded-md hover:bg-opacity-90 transition-colors">
                    Start New Operation
                </button>
            </div>
        </div>
    </div>
    
    <!-- IMS Authentication Configuration -->
    <script>
        // IMS Configuration with AEM CS Assets Selector client ID
        const imsConfig = {
            clientId: 'aemcs-poe-assetselector', // AEM CS Assets Selector client ID
            redirectUri: window.location.origin + window.location.pathname,
            scope: 'openid,AdobeID,read_organizations',
            responseType: 'token'
        };
        
        // Function to initiate IMS login flow
        function loginWithIMS() {
            // Create and show the auth loading indicator
            const authLoadingIndicator = document.createElement('div');
            authLoadingIndicator.id = 'authLoadingIndicator';
            authLoadingIndicator.className = 'fixed inset-0 bg-white/50 dark:bg-gray-900/50 flex flex-col justify-center items-center z-50';
            authLoadingIndicator.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg flex flex-col items-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-4 border-primary/30 border-t-4 border-t-primary mb-4"></div>
                    <p class="text-lg font-medium">Preparing Adobe Authentication...</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Please wait while we connect to Adobe's authentication service</p>
                </div>
            `;
            document.body.appendChild(authLoadingIndicator);
            
            // Save current app state to restore after authentication
            const currentState = {
                aemHost: document.getElementById('aemHost').value
            };
            
            // Store current state in memory so we can retrieve it later
            window.imsState = currentState;
            
            // Create the authorization URL
            const authUrl = `https://ims-na1.adobelogin.com/ims/authorize/v2?` +
                `client_id=${encodeURIComponent(imsConfig.clientId)}` +
                `&redirect_uri=${encodeURIComponent(imsConfig.redirectUri)}` +
                `&scope=${encodeURIComponent(imsConfig.scope)}` +
                `&response_type=${imsConfig.responseType}`;
            
            // Delay opening the window to give the user time to see the loading indicator
            setTimeout(() => {
                // Store the auth window reference globally to close it later
                window.authWindow = window.open(authUrl, 'adobeImsLogin', 
                    'width=800,height=600,location=yes,resizable=yes,scrollbars=yes,status=yes');
                
                if (!window.authWindow) {
                    // Remove the loading indicator
                    if (document.body.contains(authLoadingIndicator)) {
                        document.body.removeChild(authLoadingIndicator);
                    }
                    showNotification('Popup blocked. Please allow popups for this site and try again.', 'error');
                    return;
                }
                
                // Update the loading indicator message after opening the window
                const loadingText = authLoadingIndicator.querySelector('p.text-lg');
                const loadingSubtext = authLoadingIndicator.querySelector('p.text-sm');
                if (loadingText && loadingSubtext) {
                    loadingText.textContent = 'Adobe Authentication Window Opened';
                    loadingSubtext.textContent = 'Please complete the sign in process in the popup window';
                }
                
                // Remove loading indicator after a longer delay to ensure user notices it
                setTimeout(() => {
                    if (document.body.contains(authLoadingIndicator)) {
                        document.body.removeChild(authLoadingIndicator);
                    }
                    // Show a helper notification to guide users
                    showNotification('Adobe login window opened. Please complete authentication in the popup.', 'info', 10000);
                }, 1500);
                
                // Handle message events from the popup
                window.addEventListener('message', receiveImsToken, false);
                
                // Function to monitor for popup closure with a longer interval
                const checkClosed = setInterval(() => {
                    if (window.authWindow && window.authWindow.closed) {
                        clearInterval(checkClosed);
                        window.removeEventListener('message', receiveImsToken);
                        
                        // Show loading when checking for token
                        const tokenCheckIndicator = document.createElement('div');
                        tokenCheckIndicator.className = 'fixed inset-0 bg-white/50 dark:bg-gray-900/50 flex flex-col justify-center items-center z-50';
                        tokenCheckIndicator.innerHTML = `
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg flex flex-col items-center">
                                <div class="animate-spin rounded-full h-12 w-12 border-4 border-primary/30 border-t-4 border-t-primary mb-4"></div>
                                <p class="text-lg font-medium">Processing Authentication</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Retrieving your access token...</p>
                            </div>
                        `;
                        document.body.appendChild(tokenCheckIndicator);
                        
                        // Add a longer delay before checking for the token to give more time for processing
                        setTimeout(() => {
                            // Check if we have a token in the URL hash (in case the popup redirected to our main window)
                            const hasToken = handleImsRedirect();
                            
                            // Remove the token check indicator
                            if (document.body.contains(tokenCheckIndicator)) {
                                document.body.removeChild(tokenCheckIndicator);
                            }
                            
                            // If we don't have a token yet, prompt the user to enter it manually
                            const imsTokenField = document.getElementById('imsToken');
                            if (!hasToken && !imsTokenField.value) {
                                // Show manual token entry helper
                                showManualTokenHelper();
                            }
                        }, 2000); // Wait 2 seconds before checking for token
                    }
                }, 1000); // Check every second if the popup is closed
            }, 800); // Wait 800ms before opening the authentication window
        }
        
        // Function to receive IMS token from the popup window
        function receiveImsToken(event) {
            // Validate the origin of the message
            if (event.origin === 'https://ims-na1.adobelogin.com' || 
                event.origin === window.location.origin) {
                
                try {
                    // Parse the message data
                    const data = typeof event.data === 'string' 
                        ? JSON.parse(event.data) 
                        : event.data;
                    
                    // Check if this is an IMS token message
                    if (data && data.type === 'access_token' && data.token) {
                        // Store the token
                        document.getElementById('imsToken').value = data.token;
                        
                        // Close the auth window if it's still open
                        if (window.authWindow && !window.authWindow.closed) {
                            window.authWindow.close();
                        }
                        
                        // Update UI to show authenticated state
                        updateAuthStatusUI(true, 'IMS');
                        
                        // Remove event listener
                        window.removeEventListener('message', receiveImsToken);
                        
                        // Show success notification
                        showNotification('Successfully authenticated with Adobe IMS', 'success');
                    }
                } catch (err) {
                    console.error('Error processing IMS message:', err);
                }
            }
        }
        
        // Function to handle IMS redirect with token in URL hash
        function handleImsRedirect() {
            if (window.location.hash.includes('access_token=')) {
                try {
                    // Parse the hash parameters
                    const hashParams = new URLSearchParams(
                        window.location.hash.substring(1) // Remove the # character
                    );
                    
                    // Get the access token
                    const accessToken = hashParams.get('access_token');
                    
                    if (accessToken) {
                        // Store the token
                        document.getElementById('imsToken').value = accessToken;
                        
                        // Update UI to show authenticated state
                        updateAuthStatusUI(true, 'IMS');
                        
                        // Show success notification
                        showNotification('Successfully authenticated with Adobe IMS', 'success');
                        
                        // Clean the URL hash
                        window.history.replaceState(
                            null, 
                            document.title, 
                            window.location.pathname + window.location.search
                        );
                        
                        return true;
                    }
                } catch (err) {
                    console.error('Error processing IMS redirect:', err);
                }
            }
            return false;
        }
        
        // Function to show manual token entry helper
        function showManualTokenHelper() {
            // Show the token input section
            const tokenSection = document.getElementById('imsTokenSection');
            tokenSection.classList.remove('hidden');
            
            // Notification to guide the user
            showNotification('Please enter your IMS access token manually if it was not automatically detected', 'info', 10000);
        }
    </script>
    
    <!-- Main App Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Handle IMS redirect on page load
            handleImsRedirect();
            
            // Setup collapsible authentication panel
            setupCollapsiblePanel();
            
            // Setup tabs
            setupTabs();
            
            // State management
            let workbook = null;
            let selectedSheet = null;
            let sheetData = null;
            let assetPaths = [];
            let renamedPaths = [];
            let metadataUpdates = [];
            let currentTab = 'rename'; // Default tab
            
            // DOM elements
            const fileInput = document.getElementById('fileInput');
            const fileProcessingStatus = document.getElementById('fileProcessingStatus');
            const sheetSelect = document.getElementById('sheetSelect');
            const assetPathColumnSelect = document.getElementById('assetPathColumnSelect');
            const sheetSelection = document.getElementById('sheetSelection');
            const assetPathColumnSelection = document.getElementById('assetPathColumnSelection');
            const renameConfigSection = document.getElementById('renameConfigSection');
            const metadataConfigSection = document.getElementById('metadataConfigSection');
            const renamePreviewSection = document.getElementById('renamePreviewSection');
            const metadataPreviewSection = document.getElementById('metadataPreviewSection');
            const resultsSection = document.getElementById('resultsSection');
            const excelPreview = document.getElementById('excelPreview');
            const previewTableHead = document.getElementById('previewTableHead');
            const previewTableBody = document.getElementById('previewTableBody');
            const renamePreviewTableBody = document.getElementById('renamePreviewTableBody');
            const metadataPreviewTableBody = document.getElementById('metadataPreviewTableBody');
            const resultsLog = document.getElementById('resultsLog');
            const basicAuthBtn = document.getElementById('basicAuthBtn');
            const imsAuthBtn = document.getElementById('imsAuthBtn');
            const imsTokenSection = document.getElementById('imsTokenSection');
            const authStatus = document.getElementById('authStatus');
            const addMappingBtn = document.getElementById('addMappingBtn');
            
            // Authentication state
            let isAuthenticated = false;
            let authMethod = null;
            
            // Button event listeners
            basicAuthBtn.addEventListener('click', authenticateBasic);
            imsAuthBtn.addEventListener('click', loginWithIMS);
            fileInput.addEventListener('change', handleFileUpload);
            document.getElementById('renamePreviewBtn').addEventListener('click', previewRenames);
            document.getElementById('metadataPreviewBtn').addEventListener('click', previewMetadataUpdates);
            document.getElementById('deletePreviewBtn').addEventListener('click', previewDeletes);
            document.getElementById('executeRenameBtn').addEventListener('click', executeRenames);
            document.getElementById('executeMetadataBtn').addEventListener('click', executeMetadataUpdates);
            document.getElementById('executeDeleteBtn').addEventListener('click', executeDeletes);
            document.getElementById('cancelRenameBtn').addEventListener('click', cancelOperation);
            document.getElementById('cancelMetadataBtn').addEventListener('click', cancelOperation);
            document.getElementById('cancelDeleteBtn').addEventListener('click', cancelOperation);
            document.getElementById('resetBtn').addEventListener('click', resetApp);
            addMappingBtn.addEventListener('click', addMetadataMapping);
            
            // Initialize event listeners for removing metadata mappings
            document.addEventListener('click', function(e) {
                if (e.target.closest('.remove-mapping')) {
                    const mappingRow = e.target.closest('.mapping-row');
                    if (mappingRow && document.querySelectorAll('.mapping-row').length > 1) {
                        mappingRow.remove();
                    } else {
                        showNotification('Cannot remove the last mapping row', 'warning');
                    }
                }
            });
            
            // Initialize direct event listeners for select elements
            sheetSelect.addEventListener('change', function() {
                processSheetSelection(this.value);
            });
            
            assetPathColumnSelect.addEventListener('change', function() {
                // When asset path column is selected, show the appropriate config section based on the active tab
                if (currentTab === 'rename') {
                    renameConfigSection.classList.remove('hidden');
                } else if (currentTab === 'metadata') {
                    metadataConfigSection.classList.remove('hidden');
                    populateMetadataColumnOptions();
                } else if (currentTab === 'delete') {
                    document.getElementById('deleteConfigSection').classList.remove('hidden');
                }
            });
            
            // Document imsToken field update listener
            document.getElementById('imsToken').addEventListener('input', function() {
                if (this.value.trim()) {
                    updateAuthStatusUI(true, 'IMS');
                }
            });
            
            // Add test token button functionality
            document.getElementById('testTokenBtn').addEventListener('click', function() {
                const token = document.getElementById('imsToken').value.trim();
                if (!token) {
                    showNotification('Please enter an IMS token to validate', 'warning');
                    return;
                }
                
                // Show validation in progress
                const btn = this;
                const originalText = btn.textContent;
                btn.disabled = true;
                btn.innerHTML = `
                    <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-current inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Validating...
                `;
                
                // Here you would normally make an API call to validate the token
                // For demo purposes, we'll simulate a success after a brief delay
                setTimeout(() => {
                    updateAuthStatusUI(true, 'IMS');
                    showNotification('Token validated successfully', 'success');
                    
                    // Restore button state
                    btn.disabled = false;
                    btn.textContent = originalText;
                }, 1500);
            });
            
            // Setup tab functionality
            function setupTabs() {
                const tabButtons = document.querySelectorAll('.tab-button');
                const currentTabLabel = document.getElementById('currentTabLabel');
                
                tabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        // Update currentTab value
                        currentTab = button.getAttribute('data-tab');
                        
                        // Update the current tab label
                        const tabLabel = button.getAttribute('data-label');
                        currentTabLabel.textContent = tabLabel;
                        
                        // Update active tab button
                        tabButtons.forEach(btn => {
                            if (btn === button) {
                                btn.classList.remove('tab-inactive');
                                btn.classList.add('tab-active');
                            } else {
                                btn.classList.remove('tab-active');
                                btn.classList.add('tab-inactive');
                            }
                        });
                        
                        // Hide all tab content
                        document.querySelectorAll('.tab-content').forEach(content => {
                            content.classList.add('hidden');
                        });
                        
                        // Show appropriate config section if we have file data
                        if (workbook && assetPathColumnSelect.value) {
                            if (currentTab === 'rename') {
                                renameConfigSection.classList.remove('hidden');
                            } else if (currentTab === 'metadata') {
                                metadataConfigSection.classList.remove('hidden');
                                populateMetadataColumnOptions();
                            } else if (currentTab === 'delete') {
                                document.getElementById('deleteConfigSection').classList.remove('hidden');
                            }
                        }
                    });
                });
            }
            
            // Add a new metadata mapping row
            function addMetadataMapping() {
                const mappingsContainer = document.getElementById('mappingsContainer');
                const newRow = document.createElement('div');
                newRow.className = 'mapping-row flex flex-col md:flex-row gap-3 items-start md:items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-md';
                
                newRow.innerHTML = `
                    <div class="flex-1">
                        <label class="block text-sm mb-1 text-gray-600 dark:text-gray-300">Property Name</label>
                        <input type="text" placeholder="dc:description" class="property-name w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-800 dark:text-white" />
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm mb-1 text-gray-600 dark:text-gray-300">Value Column</label>
                        <select class="value-column w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-800 dark:text-white">
                            <option value="">Select column</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div class="flex items-end justify-end h-full pt-6 md:pt-0">
                        <button class="remove-mapping p-1 text-red-500 hover:text-red-700 rounded-full hover:bg-red-100 dark:hover:bg-red-900">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                `;
                
                mappingsContainer.appendChild(newRow);
                
                // Populate the column options in the new row
                populateMetadataColumnOptions();
            }
            
            // Populate column options for metadata mappings
            function populateMetadataColumnOptions() {
                if (!sheetData || !sheetData[0]) return;
                
                const headers = sheetData[0];
                const assetPathColumnIndex = parseInt(assetPathColumnSelect.value);
                
                // Get all value-column selects
                const valueColumns = document.querySelectorAll('.value-column');
                
                valueColumns.forEach(select => {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Select column</option>';
                    
                    headers.forEach((header, index) => {
                        // Skip the asset path column
                        if (index !== assetPathColumnIndex) {
                            const option = document.createElement('option');
                            option.value = index;
                            option.textContent = header || `Column ${index + 1}`;
                            select.appendChild(option);
                        }
                    });
                    
                    // Restore selected value if possible
                    if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) {
                        select.value = currentValue;
                    }
                });
            }
            
            // Handle Basic Authentication
            function authenticateBasic() {
                const aemHost = document.getElementById('aemHost').value.trim();
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();
                
                if (!aemHost || !username || !password) {
                    showNotification('Please provide AEM host, username, and password', 'error');
                    return;
                }
                
                // In a real app, you would validate the credentials with AEM
                // Here we'll just simulate a successful login
                setTimeout(() => {
                    updateAuthStatusUI(true, 'Basic');
                    showNotification('Successfully authenticated with Basic Auth', 'success');
                }, 1000);
            }
            
            // Preview delete operations
            function previewDeletes() {
                if (!sheetData || sheetData.length <= 1) {
                    showNotification('No data to process', 'error');
                    return;
                }
                
                try {
                    // Get selected column index
                    const columnIndex = parseInt(assetPathColumnSelect.value);
                    
                    // Skip header row
                    const dataRows = sheetData.slice(1);
                    
                    // Get asset paths from selected column
                    const deleteAssetPaths = dataRows.map(row => {
                        return row[columnIndex] || '';
                    }).filter(path => path.trim() !== '');
                    
                    if (deleteAssetPaths.length === 0) {
                        showNotification('No asset paths found in the selected column', 'warning');
                        return;
                    }
                    
                    // Store paths for later use
                    assetPaths = deleteAssetPaths;
                    
                    // Populate the delete preview table
                    populateDeletePreviewTable(deleteAssetPaths);
                    
                    // Show the delete preview section
                    document.getElementById('deletePreviewSection').classList.remove('hidden');
                    document.getElementById('deleteConfigSection').classList.add('hidden');
                    
                } catch (error) {
                    showNotification('Error generating delete preview: ' + error.message, 'error');
                }
            }
            
            // Populate the delete preview table
            function populateDeletePreviewTable(paths) {
                const tableBody = document.getElementById('deletePreviewTableBody');
                tableBody.innerHTML = '';
                
                if (paths.length === 0) {
                    const row = document.createElement('tr');
                    const cell = document.createElement('td');
                    cell.colSpan = 2;
                    cell.className = 'py-4 text-center text-sm text-gray-500 dark:text-gray-400';
                    cell.textContent = 'No assets found to delete';
                    row.appendChild(cell);
                    tableBody.appendChild(row);
                    return;
                }
                
                paths.forEach(path => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 dark:hover:bg-gray-800';
                    
                    // Asset path cell
                    const pathCell = document.createElement('td');
                    pathCell.className = 'py-3 px-4 text-sm';
                    pathCell.textContent = path;
                    row.appendChild(pathCell);
                    
                    // Action cell
                    const actionCell = document.createElement('td');
                    actionCell.className = 'py-3 px-4 text-sm text-red-600 dark:text-red-400 font-medium';
                    actionCell.textContent = 'DELETE';
                    row.appendChild(actionCell);
                    
                    tableBody.appendChild(row);
                });
            }
            
            // Execute delete operations
            async function executeDeletes() {
                // Check if authenticated before proceeding
                if (!isAuthenticated) {
                    showNotification('Please authenticate before executing deletions', 'error');
                    return;
                }
                
                // Show results section
                resultsSection.classList.remove('hidden');
                document.getElementById('deletePreviewSection').classList.add('hidden');
                
                // Get AEM host
                const aemHost = document.getElementById('aemHost').value.trim();
                if (!aemHost) {
                    showNotification('Please provide an AEM host URL', 'error');
                    addToLog('Error: AEM host URL is required', 'error');
                    return;
                }
                
                // Initialize counters
                let successCount = 0;
                let failureCount = 0;
                
                // Log header
                addToLog('Starting asset deletion operation...', 'header');
                
                // Get authentication headers
                const headers = getAuthHeaders();
                
                // Process each asset
                for (const path of assetPaths) {
                    try {
                        // Log start of operation
                        addToLog(`Deleting asset: ${path}`, 'info');
                        
                        // Prepare API path - asset path is without '/content/dam'
                        const apiPath = buildApiPath(path);
                        
                        // Create the full URL - with CORS proxy
                        const targetUrl = new URL(apiPath, aemHost).toString();
                        const corsProxyUrl = 'https://cors-proxy.philipp-koch.workers.dev/corsproxy/?apiurl=' + encodeURIComponent(targetUrl);
                        
                        // Log the actual request details
                        addToLog(`Sending DELETE request via CORS proxy`, 'info');
                        addToLog(`URL: ${targetUrl}`, 'info');
                        
                        // Make the actual API call through the CORS proxy
                        const response = await fetch(corsProxyUrl, {
                            method: 'DELETE',
                            headers: headers,
                        });
                        
                        // Process the response
                        if (response.ok) {
                            addToLog(`Successfully deleted: ${path}`, 'success');
                            successCount++;
                        } else {
                            const errorText = await response.text().catch(() => 'Unknown error');
                            addToLog(`Failed to delete: ${path}. Status: ${response.status}. Error: ${errorText}`, 'error');
                            failureCount++;
                        }
                    } catch (error) {
                        addToLog(`Error deleting ${path}: ${error.message}`, 'error');
                        failureCount++;
                    }
                    
                    // Small delay between operations to avoid overwhelming the server
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // Update counters in UI
                document.getElementById('successCount').textContent = successCount;
                document.getElementById('failureCount').textContent = failureCount;
                
                // Log completion
                addToLog(`Operation completed. ${successCount} successful, ${failureCount} failed.`, 'header');
            }
            
            // Update authentication status UI
            function updateAuthStatusUI(isSuccessful, method) {
                authStatus.classList.remove('hidden');
                
                if (isSuccessful) {
                    isAuthenticated = true;
                    authMethod = method;
                    
                    authStatus.className = 'mt-4 p-3 rounded-md border border-green-200 bg-green-50 text-green-800 dark:bg-green-900/30 dark:border-green-800 dark:text-green-400';
                    authStatus.innerHTML = `
                        <div class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span>Authenticated with ${method} Authentication</span>
                        </div>
                    `;
                } else {
                    isAuthenticated = false;
                    authMethod = null;
                    
                    authStatus.className = 'mt-4 p-3 rounded-md border border-red-200 bg-red-50 text-red-800 dark:bg-red-900/30 dark:border-red-800 dark:text-red-400';
                    authStatus.innerHTML = `
                        <div class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                            <span>Authentication Failed</span>
                        </div>
                    `;
                }
            }
            
            // Handle Excel file upload
            function handleFileUpload(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                // Show file processing status
                fileProcessingStatus.classList.remove('hidden');
                
                // Hide other sections
                sheetSelection.classList.add('hidden');
                assetPathColumnSelection.classList.add('hidden');
                renameConfigSection.classList.add('hidden');
                metadataConfigSection.classList.add('hidden');
                renamePreviewSection.classList.add('hidden');
                metadataPreviewSection.classList.add('hidden');
                resultsSection.classList.add('hidden');
                excelPreview.classList.add('hidden');
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        workbook = XLSX.read(data, { type: 'array' });
                        
                        // Populate sheet selection dropdown
                        populateSheetOptions();
                        
                        // Hide processing status
                        fileProcessingStatus.classList.add('hidden');
                        
                        // Show sheet selection
                        sheetSelection.classList.remove('hidden');
                        
                        // Auto-select first sheet if available
                        if (workbook.SheetNames.length > 0) {
                            sheetSelect.value = workbook.SheetNames[0];
                            processSheetSelection(workbook.SheetNames[0]);
                        }
                    } catch (error) {
                        fileProcessingStatus.classList.add('hidden');
                        showNotification('Error reading Excel file: ' + error.message, 'error');
                    }
                };
                
                reader.onerror = function(e) {
                    fileProcessingStatus.classList.add('hidden');
                    showNotification('Error reading the file', 'error');
                };
                
                reader.readAsArrayBuffer(file);
            }
            
            // Populate sheet options
            function populateSheetOptions() {
                sheetSelect.innerHTML = '';
                
                workbook.SheetNames.forEach(sheetName => {
                    const option = document.createElement('option');
                    option.value = sheetName;
                    option.textContent = sheetName;
                    sheetSelect.appendChild(option);
                });
            }
            
            // Process sheet selection
            function processSheetSelection(sheetName) {
                try {
                    // Get the selected sheet
                    selectedSheet = workbook.Sheets[sheetName];
                    
                    // Convert to JSON with headers
                    sheetData = XLSX.utils.sheet_to_json(selectedSheet, { header: 1 });
                    
                    if (sheetData.length === 0) {
                        showNotification('Selected sheet is empty', 'warning');
                        return;
                    }
                    
                    // Get headers (first row)
                    const headers = sheetData[0] || [];
                    
                    if (headers.length === 0) {
                        showNotification('No columns found in the selected sheet', 'error');
                        return;
                    }
                    
                    // Populate asset path column selection
                    populateAssetPathColumnOptions(headers);
                    
                    // Show Excel preview
                    generateExcelPreview(sheetData);
                    
                    // Show column selection
                    assetPathColumnSelection.classList.remove('hidden');
                    excelPreview.classList.remove('hidden');
                    
                    // Auto-select first column
                    if (assetPathColumnSelect.options.length > 0) {
                        assetPathColumnSelect.selectedIndex = 0;
                        
                        // Show appropriate config section based on active tab
                        if (currentTab === 'rename') {
                            renameConfigSection.classList.remove('hidden');
                        } else if (currentTab === 'metadata') {
                            metadataConfigSection.classList.remove('hidden');
                            populateMetadataColumnOptions();
                        } else if (currentTab === 'delete') {
                            document.getElementById('deleteConfigSection').classList.remove('hidden');
                        }
                    }
                } catch (error) {
                    showNotification('Error processing the selected sheet: ' + error.message, 'error');
                }
            }
            
            // Populate asset path column options
            function populateAssetPathColumnOptions(headers) {
                assetPathColumnSelect.innerHTML = '';
                
                headers.forEach((header, index) => {
                    const displayName = header || `Column ${index + 1}`;
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = displayName;
                    assetPathColumnSelect.appendChild(option);
                });
            }
            
            // Generate Excel preview table
            function generateExcelPreview(data) {
                if (!data || data.length === 0) return;
                
                const maxRows = 5; // Show first 5 rows including header
                const rowsToShow = Math.min(data.length, maxRows);
                
                // Generate header row
                const headerRow = document.createElement('tr');
                
                if (data[0]) {
                    data[0].forEach((cell, index) => {
                        const th = document.createElement('th');
                        th.className = 'py-2 px-4 text-left text-sm font-semibold';
                        th.textContent = cell || `Column ${index + 1}`;
                        headerRow.appendChild(th);
                    });
                }
                
                previewTableHead.innerHTML = '';
                previewTableHead.appendChild(headerRow);
                
                // Generate data rows
                previewTableBody.innerHTML = '';
                
                for (let i = 1; i < rowsToShow; i++) {
                    if (data[i]) {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700';
                        
                        data[i].forEach(cell => {
                            const td = document.createElement('td');
                            td.className = 'py-2 px-4 text-sm';
                            td.textContent = cell !== null && cell !== undefined ? cell : '';
                            row.appendChild(td);
                        });
                        
                        previewTableBody.appendChild(row);
                    }
                }
                
                // Add a "more rows" indicator if there's more data
                if (data.length > maxRows) {
                    const moreRow = document.createElement('tr');
                    const moreCell = document.createElement('td');
                    moreCell.colSpan = data[0] ? data[0].length : 1;
                    moreCell.className = 'py-2 px-4 text-sm text-center text-gray-500 italic';
                    moreCell.textContent = `... ${data.length - maxRows} more rows`;
                    moreRow.appendChild(moreCell);
                    previewTableBody.appendChild(moreRow);
                }
            }
            
            // Preview rename changes
            function previewRenames() {
                if (!sheetData || sheetData.length <= 1) {
                    showNotification('No data to process', 'error');
                    return;
                }
                
                try {
                    // Get selected column index
                    const columnIndex = parseInt(assetPathColumnSelect.value);
                    
                    // Skip header row
                    const dataRows = sheetData.slice(1);
                    
                    // Get asset paths from selected column
                    assetPaths = dataRows.map(row => {
                        return row[columnIndex] || '';
                    }).filter(path => path.trim() !== '');
                    
                    if (assetPaths.length === 0) {
                        showNotification('No asset paths found in the selected column', 'warning');
                        return;
                    }
                    
                    // Get characters to process
                    const charsToProcess = Array.from(document.querySelectorAll('.char-checkbox:checked'))
                        .map(checkbox => checkbox.getAttribute('data-char'));
                    
                    // Get action and replacement
                    const action = document.querySelector('input[name="action"]:checked').value;
                    const replacement = action === 'replace' ? document.getElementById('replaceWith').value : '';
                    
                    // Generate renamed paths
                    renamedPaths = assetPaths.map(path => {
                        // Extract path components
                        const lastSlashIndex = path.lastIndexOf('/');
                        const directory = path.substring(0, lastSlashIndex + 1);
                        const filename = path.substring(lastSlashIndex + 1);
                        
                        // Process filename
                        let newFilename = filename;
                        charsToProcess.forEach(char => {
                            const escapedChar = char === '.' ? '\\.' : char;
                            const regex = new RegExp(escapedChar, 'g');
                            newFilename = newFilename.replace(regex, replacement);
                        });
                        
                        return directory + newFilename;
                    });
                    
                    // Populate preview table
                    populateRenamePreviewTable(assetPaths, renamedPaths);
                    
                    // Show preview section
                    renamePreviewSection.classList.remove('hidden');
                } catch (error) {
                    showNotification('Error generating preview: ' + error.message, 'error');
                }
            }
            
            // Preview metadata updates
            function previewMetadataUpdates() {
                if (!sheetData || sheetData.length <= 1) {
                    showNotification('No data to process', 'error');
                    return;
                }
                
                try {
                    // Get selected asset path column index
                    const assetPathColumnIndex = parseInt(assetPathColumnSelect.value);
                    
                    // Get metadata mappings
                    const mappings = [];
                    document.querySelectorAll('.mapping-row').forEach(row => {
                        const propertyName = row.querySelector('.property-name').value.trim();
                        const valueColumnIndex = row.querySelector('.value-column').value;
                        
                        if (propertyName && valueColumnIndex) {
                            mappings.push({
                                property: propertyName,
                                columnIndex: parseInt(valueColumnIndex)
                            });
                        }
                    });
                    
                    if (mappings.length === 0) {
                        showNotification('No valid metadata mappings defined', 'warning');
                        return;
                    }
                    
                    // Skip header row
                    const dataRows = sheetData.slice(1);
                    
                    // Build metadata updates
                    metadataUpdates = [];
                    
                    dataRows.forEach(row => {
                        const assetPath = row[assetPathColumnIndex];
                        
                        if (assetPath && assetPath.trim()) {
                            const properties = {};
                            let hasValues = false;
                            
                            mappings.forEach(mapping => {
                                const value = row[mapping.columnIndex];
                                if (value !== undefined && value !== null && value !== '') {
                                    properties[mapping.property] = value;
                                    hasValues = true;
                                }
                            });
                            
                            if (hasValues) {
                                metadataUpdates.push({
                                    assetPath,
                                    properties
                                });
                            }
                        }
                    });
                    
                    if (metadataUpdates.length === 0) {
                        showNotification('No metadata updates found in the selected data', 'warning');
                        return;
                    }
                    
                    // Populate metadata preview table
                    populateMetadataPreviewTable(metadataUpdates);
                    
                    // Show preview section
                    metadataPreviewSection.classList.remove('hidden');
                } catch (error) {
                    showNotification('Error generating metadata preview: ' + error.message, 'error');
                }
            }
            
            // Populate rename preview table
            function populateRenamePreviewTable(originalPaths, newPaths) {
                renamePreviewTableBody.innerHTML = '';
                
                let changeCount = 0;
                
                originalPaths.forEach((path, index) => {
                    const newPath = newPaths[index];
                    
                    // Skip if path didn't change
                    if (path === newPath) return;
                    
                    changeCount++;
                    
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 dark:hover:bg-gray-800';
                    
                    // Original path cell
                    const originalCell = document.createElement('td');
                    originalCell.className = 'py-3 px-4 text-sm';
                    originalCell.textContent = path;
                    row.appendChild(originalCell);
                    
                    // New path cell
                    const newCell = document.createElement('td');
                    newCell.className = 'py-3 px-4 text-sm';
                    
                    // Highlight differences
                    const originalFilename = path.substring(path.lastIndexOf('/') + 1);
                    const newFilename = newPath.substring(newPath.lastIndexOf('/') + 1);
                    
                    const directory = path.substring(0, path.lastIndexOf('/') + 1);
                    
                    newCell.innerHTML = directory + `<span class="font-semibold text-primary">${newFilename}</span>`;
                    row.appendChild(newCell);
                    
                    renamePreviewTableBody.appendChild(row);
                });
                
                if (changeCount === 0) {
                    const row = document.createElement('tr');
                    const cell = document.createElement('td');
                    cell.colSpan = 2;
                    cell.className = 'py-4 text-center text-sm text-gray-500 dark:text-gray-400';
                    cell.textContent = 'No changes required - all paths already match the configured pattern';
                    row.appendChild(cell);
                    renamePreviewTableBody.appendChild(row);
                }
            }
            
            // Populate metadata preview table
            function populateMetadataPreviewTable(updates) {
                metadataPreviewTableBody.innerHTML = '';
                
                updates.forEach(update => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 dark:hover:bg-gray-800';
                    
                    // Asset path cell
                    const pathCell = document.createElement('td');
                    pathCell.className = 'py-3 px-4 text-sm';
                    pathCell.textContent = update.assetPath;
                    row.appendChild(pathCell);
                    
                    // Metadata updates cell
                    const metadataCell = document.createElement('td');
                    metadataCell.className = 'py-3 px-4 text-sm';
                    
                    const metadataList = document.createElement('ul');
                    metadataList.className = 'list-disc pl-5 space-y-1';
                    
                    Object.entries(update.properties).forEach(([key, value]) => {
                        const item = document.createElement('li');
                        item.innerHTML = `<span class="font-medium">${key}</span>: <span class="text-primary">${value}</span>`;
                        metadataList.appendChild(item);
                    });
                    
                    metadataCell.appendChild(metadataList);
                    row.appendChild(metadataCell);
                    
                    metadataPreviewTableBody.appendChild(row);
                });
                
                if (updates.length === 0) {
                    const row = document.createElement('tr');
                    const cell = document.createElement('td');
                    cell.colSpan = 2;
                    cell.className = 'py-4 text-center text-sm text-gray-500 dark:text-gray-400';
                    cell.textContent = 'No metadata updates found';
                    row.appendChild(cell);
                    metadataPreviewTableBody.appendChild(row);
                }
            }
            
            // Execute renames - production implementation
            async function executeRenames() {
                // Check if authenticated before proceeding
                if (!isAuthenticated) {
                    showNotification('Please authenticate before executing renames', 'error');
                    return;
                }
                
                // Show results section
                resultsSection.classList.remove('hidden');
                renamePreviewSection.classList.add('hidden');
                
                // Get AEM host
                const aemHost = document.getElementById('aemHost').value.trim();
                if (!aemHost) {
                    showNotification('Please provide an AEM host URL', 'error');
                    addToLog('Error: AEM host URL is required', 'error');
                    return;
                }
                
                // Initialize counters
                let successCount = 0;
                let failureCount = 0;
                
                // Log header
                addToLog('Starting asset rename operation...', 'header');
                
                // Get authentication headers
                const headers = getAuthHeaders();
                
                // Process each asset
                for (let i = 0; i < assetPaths.length; i++) {
                    const originalPath = assetPaths[i];
                    const newPath = renamedPaths[i];
                    
                    // Skip if path didn't change
                    if (originalPath === newPath) continue;
                    
                    try {
                        // Log start of operation
                        addToLog(`Processing: ${originalPath}  ${newPath}`, 'info');
                        
                        // Prepare API paths
                        const apiOriginalPath = buildApiPath(originalPath);
                        const apiNewPath = buildApiPath(newPath);
                        
                        // Create the full URLs - with CORS proxy
                        const targetUrl = new URL(apiOriginalPath, aemHost).toString();
                        const corsProxyUrl = 'https://cors-proxy.philipp-koch.workers.dev/corsproxy/?apiurl=' + encodeURIComponent(targetUrl);
                        
                        // For the destination path, we need the full URL too (not just the path)
                        const fullDestinationUrl = new URL(apiNewPath, aemHost).toString();
                        
                        // Clone the headers to avoid mutation issues
                        const requestHeaders = new Headers(headers);
                        
                        // Add MOVE-specific headers
                        requestHeaders.append('X-Destination', fullDestinationUrl);
                        requestHeaders.append('X-Overwrite', 'T');
                        
                        // Log the actual request details
                        addToLog(`Sending MOVE request via CORS proxy`, 'info');
                        addToLog(`Source: ${targetUrl}`, 'info');
                        addToLog(`Destination: ${fullDestinationUrl}`, 'info');
                        
                        // Make the actual API call through the CORS proxy
                        const response = await fetch(corsProxyUrl, {
                            method: 'MOVE',
                            headers: requestHeaders,
                        });
                        
                        // Process the response
                        if (response.ok) {
                            addToLog(`Successfully renamed: ${originalPath}  ${newPath}`, 'success');
                            successCount++;
                        } else {
                            const errorText = await response.text().catch(() => 'Unknown error');
                            addToLog(`Failed to rename: ${originalPath}. Status: ${response.status}. Error: ${errorText}`, 'error');
                            failureCount++;
                        }
                    } catch (error) {
                        addToLog(`Error processing ${originalPath}: ${error.message}`, 'error');
                        failureCount++;
                    }
                    
                    // Small delay between operations to avoid overwhelming the server
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // Update counters in UI
                document.getElementById('successCount').textContent = successCount;
                document.getElementById('failureCount').textContent = failureCount;
                
                // Log completion
                addToLog(`Operation completed. ${successCount} successful, ${failureCount} failed.`, 'header');
            }
            
            // Execute metadata updates
            async function executeMetadataUpdates() {
                // Check if authenticated before proceeding
                if (!isAuthenticated) {
                    showNotification('Please authenticate before executing metadata updates', 'error');
                    return;
                }
                
                // Show results section
                resultsSection.classList.remove('hidden');
                metadataPreviewSection.classList.add('hidden');
                
                // Get AEM host
                const aemHost = document.getElementById('aemHost').value.trim();
                
                // Initialize counters
                let successCount = 0;
                let failureCount = 0;
                
                // Log header
                addToLog('Starting metadata update operation...', 'header');
                
                // Process each asset
                for (const update of metadataUpdates) {
                    try {
                        // Log start of operation
                        addToLog(`Updating metadata for: ${update.assetPath}`, 'info');
                        
                        // Prepare API path
                        const apiPath = buildApiPath(update.assetPath);
                        
                        // Prepare request body
                        const requestBody = {
                            class: "asset",
                            properties: update.properties
                        };
                        
                        // In a real app, you would make the actual API call to update metadata
                        // API endpoint: PUT apiPath
                        // Headers: 
                        // - Content-Type: application/json
                        // - Authorization: Basic/Bearer based on auth method
                        // Body: JSON.stringify(requestBody)
                        
                        // Here we'll simulate success/failure based on a basic rule
                        const success = Math.random() > 0.2; // 80% success rate
                        
                        if (success) {
                            const propertiesList = Object.entries(update.properties)
                                .map(([key, value]) => `${key}: ${value}`)
                                .join(', ');
                                
                            addToLog(`Successfully updated metadata for: ${update.assetPath} (${propertiesList})`, 'success');
                            successCount++;
                        } else {
                            addToLog(`Failed to update metadata for: ${update.assetPath}. API error: Asset not found.`, 'error');
                            failureCount++;
                        }
                        
                        // Simulating API call delay
                        await new Promise(resolve => setTimeout(resolve, 300));
                    } catch (error) {
                        addToLog(`Error processing ${update.assetPath}: ${error.message}`, 'error');
                        failureCount++;
                    }
                }
                
                // Update counters in UI
                document.getElementById('successCount').textContent = successCount;
                document.getElementById('failureCount').textContent = failureCount;
                
                // Log completion
                addToLog(`Operation completed. ${successCount} successful, ${failureCount} failed.`, 'header');
            }
            
            // Helper function to build API path from asset path
            function buildApiPath(path) {
                // Ensure the path has a leading slash
                if (!path.startsWith('/')) {
                    path = '/' + path;
                }
                
                // For the AEM Assets HTTP API:
                // If the path starts with /content/dam, we need to REMOVE it and replace with /api/assets
                // If the path is already in the right format, leave it as is
                
                if (path.startsWith('/content/dam/')) {
                    // Remove /content/dam prefix and replace with /api/assets
                    return '/api/assets' + path.substring('/content/dam'.length);
                } else if (path === '/content/dam') {
                    // Special case for root DAM folder
                    return '/api/assets';
                } else if (path.startsWith('/content/dam')) {
                    // Handle edge case with no trailing slash
                    return '/api/assets' + path.substring('/content/dam'.length);
                } else if (path.startsWith('/api/assets')) {
                    // Path is already in API format
                    return path;
                } else {
                    // Assume this is a relative path within DAM
                    // Add the /api/assets prefix directly
                    return '/api/assets' + path;
                }
            }
            
            // Get auth headers - prioritize IMS token when available, fall back to basic auth
            function getAuthHeaders() {
                const headers = new Headers();
                
                // Check for IMS token first
                const imsToken = document.getElementById('imsToken').value.trim();
                
                if (imsToken) {
                    // Use bearer token if available, regardless of selected auth method
                    headers.append('Authorization', `Bearer ${imsToken}`);
                    console.log('Using Bearer token authentication for API request');
                } else {
                    // Fall back to basic auth
                    const username = document.getElementById('username').value.trim();
                    const password = document.getElementById('password').value.trim();
                    
                    if (username && password) {
                        const basicAuth = btoa(`${username}:${password}`);
                        headers.append('Authorization', `Basic ${basicAuth}`);
                        console.log('Using Basic authentication for API request');
                    } else {
                        console.warn('No authentication credentials available');
                    }
                }
                
                return headers;
            }
            
            // Add entry to results log
            function addToLog(message, type = 'info') {
                const logEntry = document.createElement('div');
                logEntry.className = 'mb-1';
                
                switch (type) {
                    case 'header':
                        logEntry.className += ' font-bold text-primary dark:text-primary border-b pb-1 border-gray-300 dark:border-gray-600 mt-2';
                        break;
                    case 'success':
                        logEntry.className += ' text-green-600 dark:text-green-400';
                        break;
                    case 'error':
                        logEntry.className += ' text-red-600 dark:text-red-400';
                        break;
                    case 'info':
                    default:
                        logEntry.className += ' text-gray-700 dark:text-gray-300';
                        break;
                }
                
                logEntry.textContent = message;
                resultsLog.appendChild(logEntry);
                
                // Auto-scroll to bottom
                resultsLog.scrollTop = resultsLog.scrollHeight;
            }
            
            // Cancel operation
            function cancelOperation() {
                renamePreviewSection.classList.add('hidden');
                metadataPreviewSection.classList.add('hidden');
            }
            
            // Reset app
            function resetApp() {
                // Reset file input
                fileInput.value = '';
                
                // Reset and hide sections
                sheetSelection.classList.add('hidden');
                assetPathColumnSelection.classList.add('hidden');
                renameConfigSection.classList.add('hidden');
                metadataConfigSection.classList.add('hidden');
                renamePreviewSection.classList.add('hidden');
                metadataPreviewSection.classList.add('hidden');
                resultsSection.classList.add('hidden');
                excelPreview.classList.add('hidden');
                
                // Clear data
                workbook = null;
                selectedSheet = null;
                sheetData = null;
                assetPaths = [];
                renamedPaths = [];
                metadataUpdates = [];
                
                // Clear results log
                resultsLog.innerHTML = '';
            }
            
            // Setup collapsible panel functionality
            function setupCollapsiblePanel() {
                const authHeader = document.getElementById('authHeader');
                const authPanel = document.getElementById('authPanel');
                const toggleIcon = document.querySelector('.auth-toggle-icon');
                
                // Store panel state
                let isPanelOpen = false;
                
                // Function to toggle panel state
                function togglePanel() {
                    isPanelOpen = !isPanelOpen;
                    
                    if (isPanelOpen) {
                        // Open panel
                        authPanel.style.maxHeight = '1000px';
                        authPanel.style.opacity = '1';
                        toggleIcon.style.transform = 'rotate(0deg)';
                        authHeader.setAttribute('aria-expanded', 'true');
                    } else {
                        // Close panel
                        authPanel.style.maxHeight = '0';
                        authPanel.style.opacity = '0';
                        toggleIcon.style.transform = 'rotate(-90deg)';
                        authHeader.setAttribute('aria-expanded', 'false');
                    }
                }
                
                // Add click event listener to toggle panel
                authHeader.addEventListener('click', togglePanel);
                
                // Initialize panel state (closed by default)
                authHeader.setAttribute('aria-expanded', 'false');
                toggleIcon.style.transform = 'rotate(-90deg)';
            }
            
            // Notification system
            function showNotification(message, type = 'info', duration = 5000) {
                // Create notification element
                const notification = document.createElement('div');
                notification.className = 'notification fixed bottom-4 right-4 p-4 rounded-lg shadow-lg max-w-sm z-50 transform transition-transform duration-300 translate-y-full';
                
                // Set type-specific styles
                switch (type) {
                    case 'success':
                        notification.classList.add('bg-green-100', 'text-green-800', 'dark:bg-green-800', 'dark:text-green-100');
                        break;
                    case 'error':
                        notification.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-800', 'dark:text-red-100');
                        break;
                    case 'warning':
                        notification.classList.add('bg-yellow-100', 'text-yellow-800', 'dark:bg-yellow-800', 'dark:text-yellow-100');
                        break;
                    case 'info':
                    default:
                        notification.classList.add('bg-blue-100', 'text-blue-800', 'dark:bg-blue-800', 'dark:text-blue-100');
                        break;
                }
                
                // Set notification content
                notification.innerHTML = `
                    <div class="flex items-start">
                        <div class="flex-1">${message}</div>
                        <button type="button" class="ml-4 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                `;
                
                // Add to DOM
                document.body.appendChild(notification);
                
                // Animate in
                setTimeout(() => {
                    notification.classList.remove('translate-y-full');
                }, 10);
                
                // Close button handler
                const closeButton = notification.querySelector('button');
                closeButton.addEventListener('click', () => {
                    notification.classList.add('translate-y-full');
                    setTimeout(() => {
                        if (document.body.contains(notification)) {
                            document.body.removeChild(notification);
                        }
                    }, 300);
                });
                
                // Auto-remove after duration
                if (duration > 0) {
                    setTimeout(() => {
                        if (document.body.contains(notification)) {
                            notification.classList.add('translate-y-full');
                            setTimeout(() => {
                                if (document.body.contains(notification)) {
                                    document.body.removeChild(notification);
                                }
                            }, 300);
                        }
                    }, duration);
                }
                
                return notification;
            }
        });
    </script>
</body>
</html>
