<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Activity Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="min-h-screen bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-200">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <h1 class="text-3xl font-bold mb-6 text-primary">GitHub Activity Tracker</h1>
        
        <div class="bg-blue-100 dark:bg-blue-900 border-l-4 border-blue-500 text-blue-700 dark:text-blue-200 p-4 mb-4 rounded shadow-md">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-info-circle text-blue-500 mt-1"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm leading-tight">
                        <strong>GitHub Personal Access Token Required:</strong> This app uses GitHub's GraphQL API which requires authentication.
                        Please provide a Personal Access Token with 'repo' and 'user' scopes to view contributions data, including activities in private repositories.
                        <a href="https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token" class="underline font-medium" target="_blank">Learn how to create a token</a>
                    </p>
                </div>
            </div>
        </div>
        
        <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-6 mb-8 shadow-md">
            <form id="github-form" class="space-y-4">
                <div>
                    <label for="github-users" class="block text-sm font-medium mb-1">GitHub Usernames</label>
                    <div class="flex items-center">
                        <input type="text" id="github-users" 
                            class="w-full px-4 py-2 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary" 
                            placeholder="Enter GitHub usernames (comma-separated)" />
                        <button type="button" id="add-user-btn" class="ml-2 px-4 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 transition">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <p class="text-xs mt-1 text-gray-500 dark:text-gray-400">Example: octocat, defunkt, torvalds</p>
                </div>
                
                <div>
                    <label for="github-url" class="block text-sm font-medium mb-1">GitHub URL</label>
                    <input type="text" id="github-url" 
                        class="w-full px-4 py-2 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary" 
                        placeholder="Enter GitHub URL (e.g., https://github.com or https://git.corp.adobe.com)" 
                        value="https://github.com" />
                    <p class="text-xs mt-1 text-gray-500 dark:text-gray-400">For GitHub Enterprise, use your company's GitHub URL</p>
                </div>
                
                <div>
                    <label for="cors-proxy" class="block text-sm font-medium mb-1">CORS Proxy URL (Optional)</label>
                    <input type="text" id="cors-proxy" 
                        class="w-full px-4 py-2 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary" 
                        placeholder="Enter CORS proxy URL (e.g., https://corsproxy.io/?apiurl)" />
                    <p class="text-xs mt-1 text-gray-500 dark:text-gray-400">May be needed for GitHub Enterprise due to CORS restrictions. Example: <code>https://corsproxy.io/?apiurl</code></p>
                </div>
                
                <div>
                    <label for="github-token" class="block text-sm font-medium mb-1">Personal Access Token (Optional)</label>
                    <div class="relative">
                        <input type="password" id="github-token" 
                            class="w-full px-4 py-2 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary" 
                            placeholder="Enter your GitHub personal access token" />
                        <button type="button" id="toggle-token" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500">
                            <i class="fas fa-eye-slash"></i>
                        </button>
                    </div>
                    <p class="text-xs mt-1 text-gray-500 dark:text-gray-400">Required for GitHub Enterprise and to access private repositories. Needs 'repo' and 'user' scopes.</p>
                </div>
                
                <div id="user-list" class="flex flex-wrap gap-2"></div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="start-date" class="block text-sm font-medium mb-1">Start Date</label>
                        <input type="date" id="start-date" 
                            class="w-full px-4 py-2 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary" />
                    </div>
                    <div>
                        <label for="end-date" class="block text-sm font-medium mb-1">End Date</label>
                        <input type="date" id="end-date" 
                            class="w-full px-4 py-2 text-base rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary" />
                    </div>
                </div>
                
                <div class="flex justify-center">
                    <button type="submit" class="px-8 py-3 bg-primary text-white rounded-lg hover:bg-opacity-90 transition text-base font-medium">
                        Fetch Activities
                    </button>
                </div>
            </form>
        </div>
        
        <div id="loading" class="hidden flex justify-center items-center p-10">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary"></div>
        </div>
        
        <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"></div>
        
        <div id="results" class="hidden space-y-8">
            <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-6 shadow-md">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Activity Timeline</h2>
                    <div class="flex items-center">
                        <span class="mr-2 text-sm">Show Averages</span>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="show-averages" class="sr-only peer">
                            <div class="relative w-11 h-6 bg-gray-300 dark:bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/30 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                        </label>
                    </div>
                </div>
                <div class="h-[400px]">
                    <canvas id="activity-chart"></canvas>
                </div>
            </div>
            
            <div id="summary-section" class="bg-gray-100 dark:bg-gray-800 rounded-lg p-6 shadow-md">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="summary-header" class="text-xl font-bold">Contribution Summary</h2>
                    <button id="export-csv-btn" class="flex items-center bg-primary text-white px-3 py-1.5 rounded-lg hover:bg-opacity-90 text-sm">
                        <i class="fas fa-download mr-2"></i>
                        Export CSV
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table id="summary-table" class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-200 dark:bg-gray-700">
                                <th class="p-3 text-left">User</th>
                                <th class="p-3 text-right">Total Contributions</th>
                                <th class="p-3 text-right">Daily Average</th>
                                <th class="p-3 text-right">Max on Single Day</th>
                                <th class="p-3 text-right">Active Days</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-300 dark:divide-gray-600"></tbody>
                    </table>
                </div>
            </div>
            
            <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-6 shadow-md">
                <h2 class="text-xl font-bold mb-4">Activity Details</h2>
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-200 dark:bg-gray-700">
                                <th class="p-3 text-left">User</th>
                                <th class="p-3 text-left">Date & Time</th>
                                <th class="p-3 text-left">Event Type</th>
                                <th class="p-3 text-left">Repository</th>
                                <th class="p-3 text-left">Details</th>
                            </tr>
                        </thead>
                        <tbody id="activity-table" class="divide-y divide-gray-300 dark:divide-gray-600"></tbody>
                    </table>
                </div>
                <div id="no-data" class="hidden text-center py-4 italic text-gray-500 dark:text-gray-400">
                    No activities found for the selected users and time period.
                </div>
            </div>
        </div>
    </div>
    
    <!-- CSV Export Modal -->
    <div id="csv-modal" class="fixed inset-0 hidden bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg w-full max-w-4xl mx-4 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-medium">CSV Export</h3>
                <button id="close-modal" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4 flex-1 overflow-y-auto">
                <p class="mb-3">Your CSV data is ready. Copy the text below and save it as a .csv file:</p>
                <div class="flex justify-between mb-2">
                    <button id="copy-csv" class="bg-primary text-white px-3 py-1.5 rounded-lg hover:bg-opacity-90 text-sm">
                        <i class="fas fa-copy mr-2"></i> Copy to Clipboard
                    </button>
                    <span id="copy-feedback" class="text-sm text-green-600 opacity-0 transition-opacity">Copied to clipboard!</span>
                </div>
                <pre id="csv-content" class="bg-gray-100 dark:bg-gray-900 p-4 rounded-lg border border-gray-300 dark:border-gray-700 overflow-x-auto text-sm font-mono h-64"></pre>
            </div>
            <div class="p-4 border-t border-gray-200 dark:border-gray-700">
                <p class="text-sm text-gray-600 dark:text-gray-400">
                    <i class="fas fa-info-circle mr-1"></i> To save this as a CSV file:
                    <ol class="list-decimal list-inside mt-2 ml-2">
                        <li>Copy the text above</li>
                        <li>Open a text editor (like Notepad or TextEdit)</li>
                        <li>Paste the content</li>
                        <li>Save the file with a .csv extension (e.g., "github_contributions.csv")</li>
                    </ol>
                </p>
            </div>
        </div>
    </div>

    <script>
        // Check for dark mode preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Initialize variables
        const form = document.getElementById('github-form');
        const userInput = document.getElementById('github-users');
        const addUserBtn = document.getElementById('add-user-btn');
        const userList = document.getElementById('user-list');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const loadingElement = document.getElementById('loading');
        const errorElement = document.getElementById('error-message');
        const resultsElement = document.getElementById('results');
        const activityTable = document.getElementById('activity-table');
        const noDataElement = document.getElementById('no-data');
        
        let activityChart = null;
        let addedUsers = new Set();
        const userColors = {};
        
        // Set default dates (last 7 days)
        const today = new Date();
        const weekAgo = new Date(today);
        weekAgo.setDate(today.getDate() - 7);
        
        startDateInput.value = formatDateForInput(weekAgo);
        endDateInput.value = formatDateForInput(today);
        
        function formatDateForInput(date) {
            return date.toISOString().split('T')[0];
        }
        
        // Generate a random color for each user
        function generateColor(username) {
            const colors = [
                '#4C51BF', // Indigo
                '#38A169', // Green
                '#E53E3E', // Red
                '#DD6B20', // Orange
                '#D69E2E', // Yellow
                '#805AD5', // Purple
                '#3182CE', // Blue
                '#00B5D8', // Cyan
                '#0694A2', // Teal
                '#D53F8C', // Pink
            ];
            
            const hash = username.split('').reduce((acc, char) => {
                return char.charCodeAt(0) + ((acc << 5) - acc);
            }, 0);
            
            return colors[Math.abs(hash) % colors.length];
        }
        
        // Add user chip to the list
        function addUserChip(username) {
            if (!username || username.trim() === '' || addedUsers.has(username.toLowerCase())) {
                return;
            }
            
            const cleanUsername = username.trim();
            addedUsers.add(cleanUsername.toLowerCase());
            
            const userColor = generateColor(cleanUsername);
            userColors[cleanUsername] = userColor;
            
            const chip = document.createElement('div');
            chip.className = 'flex items-center bg-primary bg-opacity-10 rounded-full px-3 py-1';
            chip.innerHTML = `
                <span class="mr-1 w-3 h-3 rounded-full" style="background-color: ${userColor}"></span>
                <span class="mr-2">${cleanUsername}</span>
                <button type="button" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200" data-username="${cleanUsername}">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            // Add remove event
            chip.querySelector('button').addEventListener('click', function() {
                const username = this.getAttribute('data-username');
                addedUsers.delete(username.toLowerCase());
                chip.remove();
            });
            
            userList.appendChild(chip);
            userInput.value = '';
        }
        
        // Add user button click
        addUserBtn.addEventListener('click', () => {
            const usernames = userInput.value.split(',').map(u => u.trim()).filter(u => u);
            usernames.forEach(addUserChip);
        });
        
        // Enter key in input adds users
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                const usernames = userInput.value.split(',').map(u => u.trim()).filter(u => u);
                usernames.forEach(addUserChip);
            }
        });
        
        // Toggle password visibility
        const toggleTokenBtn = document.getElementById('toggle-token');
        const tokenInput = document.getElementById('github-token');
        
        toggleTokenBtn.addEventListener('click', () => {
            const type = tokenInput.getAttribute('type') === 'password' ? 'text' : 'password';
            tokenInput.setAttribute('type', type);
            toggleTokenBtn.innerHTML = type === 'password' ? 
                '<i class="fas fa-eye-slash"></i>' : 
                '<i class="fas fa-eye"></i>';
        });
        
        // Toggle average lines in chart when the switch is clicked
        document.getElementById('show-averages').addEventListener('change', function() {
            // If we have activity data stored in window variables, update the chart
            if (window.lastActivities && window.lastStartDate && window.lastEndDate) {
                // Redraw chart with current toggle state
                displayActivityChart(window.lastActivities, window.lastStartDate, window.lastEndDate);
            }
        });
        
        // Form submit
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Validate inputs
            if (addedUsers.size === 0) {
                showError('Please add at least one GitHub username');
                return;
            }
            
            const startDate = new Date(startDateInput.value);
            const endDate = new Date(endDateInput.value);
            endDate.setHours(23, 59, 59); // Set to end of day
            
            if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                showError('Please select valid date range');
                return;
            }
            
            if (startDate > endDate) {
                showError('Start date must be before end date');
                return;
            }
            
            // Get token if provided
            const token = tokenInput.value.trim();
            
            // Clear previous results and show loading
            hideError();
            showLoading();
            clearResults();
            
            try {
                // Fetch activities for all users
                const allActivities = [];
                const userPromises = Array.from(addedUsers).map(async (username) => {
                    try {
                        const activities = await fetchUserActivities(username, startDate, endDate, token);
                        allActivities.push(...activities);
                    } catch (err) {
                        console.error(`Error fetching activities for ${username}:`, err);
                        throw new Error(`Failed to fetch activities for ${username}: ${err.message}`);
                    }
                });
                
                await Promise.all(userPromises);
                
                // Process and display results
                if (allActivities.length === 0) {
                    document.getElementById('no-data').classList.remove('hidden');
                } else {
                    displayActivities(allActivities, startDate, endDate);
                }
                
                hideLoading();
                showResults();
            } catch (error) {
                hideLoading();
                showError(error.message);
            }
        });
        
        // Fetch user activities from GitHub API using GraphQL
        async function fetchUserActivities(username, startDate, endDate, token = '') {
            try {
                // GraphQL requires authentication, so check if token exists
                if (!token) {
                    throw new Error('GitHub GraphQL API requires a Personal Access Token. Please provide a token to fetch activities.');
                }
                
                // Get the GitHub URL
                const githubUrl = document.getElementById('github-url').value.trim();
                if (!githubUrl) {
                    throw new Error('Please provide a valid GitHub URL');
                }
                
                // Debug the request path we're taking
                console.log(`Fetching activities for user: ${username} using ${githubUrl}`);
                
                // Determine if this is GitHub Enterprise
                const isEnterprise = !githubUrl.includes('github.com');
                
                // GraphQL endpoint is different for GitHub.com vs GitHub Enterprise
                let graphqlEndpoint;
                if (isEnterprise) {
                    // GitHub Enterprise endpoint includes /api/graphql
                    graphqlEndpoint = `${githubUrl.replace(/\/$/, '')}/api/graphql`;
                    
                    // For Enterprise instances, check if a CORS proxy is provided
                    const corsProxy = document.getElementById('cors-proxy').value.trim();
                    
                    // If proxy is provided, use it
                    if (corsProxy) {
                        // Prepend the CORS proxy to the endpoint with the correct format
                        // Check if the proxy URL ends with a ? or contains ?apiurl=
                        if (corsProxy.endsWith('?')) {
                            graphqlEndpoint = `${corsProxy}${encodeURIComponent(graphqlEndpoint)}`;
                        } else if (corsProxy.includes('?')) {
                            // Assume the proxy needs an additional parameter like ?apiurl=
                            if (!corsProxy.endsWith('=')) {
                                // Add = if it's not already there
                                graphqlEndpoint = `${corsProxy}=${encodeURIComponent(graphqlEndpoint)}`;
                            } else {
                                graphqlEndpoint = `${corsProxy}${encodeURIComponent(graphqlEndpoint)}`;
                            }
                        } else {
                            // No ? in proxy URL, add ?apiurl=
                            graphqlEndpoint = `${corsProxy}?apiurl=${encodeURIComponent(graphqlEndpoint)}`;
                        }
                        
                        console.log(`Using CORS proxy: ${graphqlEndpoint}`);
                    } else {
                        // No proxy provided, attempt direct connection (may fail due to CORS)
                        console.warn('No CORS proxy provided for GitHub Enterprise. Direct requests may fail due to CORS restrictions.');
                    }
                } else {
                    // GitHub.com endpoint
                    graphqlEndpoint = 'https://api.github.com/graphql';
                }
                
                // Format dates for GraphQL query
                const fromDate = startDate.toISOString().split('T')[0]; // YYYY-MM-DD
                const toDate = endDate.toISOString().split('T')[0];     // YYYY-MM-DD
                
                // GraphQL query to get user contributions
                const query = `
                query {
                  user(login: "${username}") {
                    name
                    contributionsCollection(from: "${fromDate}T00:00:00Z", to: "${toDate}T23:59:59Z") {
                      contributionCalendar {
                        totalContributions
                        weeks {
                          contributionDays {
                            contributionCount
                            date
                            weekday
                          }
                        }
                      }
                      commitContributionsByRepository {
                        repository {
                          name
                          owner { login }
                          isPrivate
                        }
                        contributions {
                          totalCount
                        }
                      }
                      pullRequestContributionsByRepository {
                        repository {
                          name
                          owner { login }
                          isPrivate
                        }
                        contributions {
                          totalCount
                        }
                      }
                      issueContributionsByRepository {
                        repository {
                          name
                          owner { login }
                          isPrivate
                        }
                        contributions {
                          totalCount
                        }
                      }
                    }
                  }
                }`;
                
                // Make GraphQL API request
                const response = await fetch(graphqlEndpoint, {
                    method: 'POST',
                    headers: {
                        'Authorization': `bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query })
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('Invalid GitHub token. Please check your token and try again.');
                    } else if (response.status === 403) {
                        throw new Error('GitHub API rate limit exceeded. Please try again later.');
                    } else {
                        throw new Error(`GitHub API error: ${response.status}`);
                    }
                }
                
                const result = await response.json();
                
                // Check for GraphQL errors
                if (result.errors) {
                    if (result.errors[0].type === 'NOT_FOUND') {
                        throw new Error(`User '${username}' not found`);
                    }
                    throw new Error(result.errors[0].message || 'GraphQL query error');
                }
                
                // Extract user data
                const userData = result.data.user;
                
                if (!userData) {
                    throw new Error(`User '${username}' not found`);
                }
                
                // Process contribution data
                const activities = [];
                const contribCollection = userData.contributionsCollection;
                const calendar = contribCollection.contributionCalendar;
                
                // Process daily contribution counts
                calendar.weeks.forEach(week => {
                    week.contributionDays.forEach(day => {
                        if (day.contributionCount > 0) {
                            const date = new Date(day.date + 'T12:00:00Z'); // Add time component to avoid timezone issues
                            
                            activities.push({
                                username,
                                date: date,
                                type: 'Contribution',
                                repo: 'Multiple Repositories',
                                details: `${day.contributionCount} contribution${day.contributionCount > 1 ? 's' : ''}`,
                                count: day.contributionCount,
                                color: userColors[username],
                                isPrivate: false // Default to public since we don't know at this level
                            });
                        }
                    });
                });
                
                // Process repository-specific contributions for more detailed info
                // Process commits by repository
                contribCollection.commitContributionsByRepository.forEach(item => {
                    const repoName = `${item.repository.owner.login}/${item.repository.name}`;
                    const isPrivate = item.repository.isPrivate;
                    const count = item.contributions.totalCount;
                    
                    if (count > 0) {
                        activities.push({
                            username,
                            date: null, // We don't have exact dates at this level
                            type: 'Commits',
                            repo: repoName,
                            details: `${count} commit${count > 1 ? 's' : ''}`,
                            count: count,
                            color: userColors[username],
                            isPrivate: isPrivate
                        });
                    }
                });
                
                // Process pull requests by repository
                contribCollection.pullRequestContributionsByRepository.forEach(item => {
                    const repoName = `${item.repository.owner.login}/${item.repository.name}`;
                    const isPrivate = item.repository.isPrivate;
                    const count = item.contributions.totalCount;
                    
                    if (count > 0) {
                        activities.push({
                            username,
                            date: null, // We don't have exact dates at this level
                            type: 'Pull Requests',
                            repo: repoName,
                            details: `${count} pull request${count > 1 ? 's' : ''}`,
                            count: count,
                            color: userColors[username],
                            isPrivate: isPrivate
                        });
                    }
                });
                
                // Process issues by repository
                contribCollection.issueContributionsByRepository.forEach(item => {
                    const repoName = `${item.repository.owner.login}/${item.repository.name}`;
                    const isPrivate = item.repository.isPrivate;
                    const count = item.contributions.totalCount;
                    
                    if (count > 0) {
                        activities.push({
                            username,
                            date: null, // We don't have exact dates at this level
                            type: 'Issues',
                            repo: repoName,
                            details: `${count} issue${count > 1 ? 's' : ''}`,
                            count: count,
                            color: userColors[username],
                            isPrivate: isPrivate
                        });
                    }
                });
                
                return activities;
            } catch (error) {
                console.error('Error fetching GitHub activities:', error);
                throw error;
            }
        }
        
        // CSV Export functionality
        // Store the current summary data for export
        let currentSummaryData = [];
        
        // Initialize the CSV export button and modal
        document.addEventListener('DOMContentLoaded', () => {
            const exportBtn = document.getElementById('export-csv-btn');
            const csvModal = document.getElementById('csv-modal');
            const closeModal = document.getElementById('close-modal');
            const copyBtn = document.getElementById('copy-csv');
            const copyFeedback = document.getElementById('copy-feedback');
            
            // Show modal when export button is clicked
            exportBtn.addEventListener('click', () => {
                generateCSV();
                csvModal.classList.remove('hidden');
            });
            
            // Close modal
            closeModal.addEventListener('click', () => {
                csvModal.classList.add('hidden');
            });
            
            // Close modal when clicking outside
            csvModal.addEventListener('click', (e) => {
                if (e.target === csvModal) {
                    csvModal.classList.add('hidden');
                }
            });
            
            // Copy to clipboard functionality
            copyBtn.addEventListener('click', () => {
                const csvContent = document.getElementById('csv-content');
                
                // Select the text
                const range = document.createRange();
                range.selectNode(csvContent);
                window.getSelection().removeAllRanges();
                window.getSelection().addRange(range);
                
                // Copy to clipboard
                try {
                    document.execCommand('copy');
                    window.getSelection().removeAllRanges();
                    
                    // Show feedback
                    copyFeedback.style.opacity = '1';
                    setTimeout(() => {
                        copyFeedback.style.opacity = '0';
                    }, 2000);
                } catch (err) {
                    console.error('Failed to copy: ', err);
                    alert('Failed to copy to clipboard. Please select and copy manually.');
                }
            });
        });
        
        // Generate CSV content from the summary data
        function generateCSV() {
            // Get date range from summary header
            const dateRange = document.getElementById('summary-header').textContent
                .replace('Contribution Summary', '').trim();
                
            // Get table headers
            const headers = Array.from(document.querySelectorAll('#summary-table thead th'))
                .map(th => th.textContent.trim());
                
            // Get table rows (excluding any rows with no activity)
            const rows = [];
            document.querySelectorAll('#summary-table tbody tr').forEach(tr => {
                const rowData = Array.from(tr.querySelectorAll('td')).map((td, index) => {
                    // For the username column, extract just the text (not the color indicator)
                    if (index === 0) {
                        return td.textContent.trim();
                    }
                    // For other columns, use the text content
                    return td.textContent.trim();
                });
                
                // Only add rows that have actual data (not empty rows)
                if (rowData.length > 0 && !rowData[0].includes('No activity data found')) {
                    rows.push(rowData);
                }
            });
            
            // Create CSV content with the date range as a header comment
            let csvContent = `# GitHub Contribution Summary ${dateRange}\n`;
            csvContent += `# Generated on ${new Date().toLocaleString()}\n\n`;
            
            // Add headers
            csvContent += headers.join(',') + '\n';
            
            // Add data rows
            rows.forEach(row => {
                csvContent += row.join(',') + '\n';
            });
            
            // Set the content to the pre element
            document.getElementById('csv-content').textContent = csvContent;
        }
        
        // Get the currently authenticated user
        async function getCurrentUser(token) {
            try {
                if (!token) return null;
                
                // Get the GitHub URL
                const githubUrl = document.getElementById('github-url').value.trim();
                if (!githubUrl) {
                    throw new Error('Please provide a valid GitHub URL');
                }
                
                // Determine if this is GitHub Enterprise
                const isEnterprise = !githubUrl.includes('github.com');
                
                // REST API endpoint is different for GitHub.com vs GitHub Enterprise
                let apiEndpoint;
                if (isEnterprise) {
                    // GitHub Enterprise endpoint
                    apiEndpoint = `${githubUrl.replace(/\/$/, '')}/api/v3/user`;
                    
                    // For Enterprise instances, check if a CORS proxy is provided
                    const corsProxy = document.getElementById('cors-proxy').value.trim();
                    
                    // If proxy is provided, use it
                    if (corsProxy) {
                        // Prepend the CORS proxy to the endpoint with the correct format
                        // Check if the proxy URL ends with a ? or contains ?apiurl=
                        if (corsProxy.endsWith('?')) {
                            apiEndpoint = `${corsProxy}${encodeURIComponent(apiEndpoint)}`;
                        } else if (corsProxy.includes('?')) {
                            // Assume the proxy needs an additional parameter like ?apiurl=
                            if (!corsProxy.endsWith('=')) {
                                // Add = if it's not already there
                                apiEndpoint = `${corsProxy}=${encodeURIComponent(apiEndpoint)}`;
                            } else {
                                apiEndpoint = `${corsProxy}${encodeURIComponent(apiEndpoint)}`;
                            }
                        } else {
                            // No ? in proxy URL, add ?apiurl=
                            apiEndpoint = `${corsProxy}?apiurl=${encodeURIComponent(apiEndpoint)}`;
                        }
                        
                        console.log(`Using CORS proxy for user info: ${apiEndpoint}`);
                    } else {
                        // No proxy provided, attempt direct connection (may fail due to CORS)
                        console.warn('No CORS proxy provided for GitHub Enterprise. Direct requests may fail due to CORS restrictions.');
                    }
                } else {
                    // GitHub.com endpoint
                    apiEndpoint = 'https://api.github.com/user';
                }
                
                const response = await fetch(apiEndpoint, {
                    headers: {
                        'Accept': 'application/vnd.github.v3+json',
                        'Authorization': `token ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.login.toLowerCase();
                }
                return null;
            } catch (error) {
                console.error('Error getting current user:', error);
                return null;
            }
        }
        
        // Get readable details for an event
        function getEventDetails(event) {
            switch (event.type) {
                case 'PushEvent':
                    const commits = event.payload.commits || [];
                    return `Pushed ${commits.length} commit${commits.length === 1 ? '' : 's'}`;
                case 'PullRequestEvent':
                    const action = event.payload.action;
                    const prNumber = event.payload.pull_request?.number || '';
                    return `${action} pull request #${prNumber}`;
                case 'IssuesEvent':
                    return `${event.payload.action} issue #${event.payload.issue?.number || ''}`;
                case 'CreateEvent':
                    return `Created ${event.payload.ref_type} ${event.payload.ref || ''}`;
                case 'DeleteEvent':
                    return `Deleted ${event.payload.ref_type} ${event.payload.ref || ''}`;
                case 'IssueCommentEvent':
                    return `Commented on issue #${event.payload.issue?.number || ''}`;
                case 'WatchEvent':
                    return 'Starred repository';
                case 'ForkEvent':
                    return 'Forked repository';
                case 'ReleaseEvent':
                    return `${event.payload.action} release ${event.payload.release?.tag_name || ''}`;
                default:
                    return event.type.replace('Event', '');
            }
        }
        
        // Display activities in chart and table
        function displayActivities(activities, startDate, endDate) {
            // Sort activities by date
            activities.sort((a, b) => a.date - b.date);
            
            // Display in table
            displayActivityTable(activities);
            
            // Display in chart
            displayActivityChart(activities, startDate, endDate);
            
            // Generate and display contribution summary
            displayContributionSummary(activities, startDate, endDate);
        }
        
        // Generate and display contribution summary
        function displayContributionSummary(activities, startDate, endDate) {
            // Get the summary section and make it visible
            const summarySection = document.getElementById('summary-section');
            summarySection.classList.remove('hidden');
            
            // Get the table body reference
            const summaryTable = document.querySelector('#summary-table tbody');
            summaryTable.innerHTML = '';
            
            // Get all dates in the range
            const allDates = getDatesInRange(startDate, endDate);
            const totalDays = allDates.length;
            
            // Add header text with date range
            const summaryHeader = document.getElementById('summary-header');
            const dateFormat = { year: 'numeric', month: 'short', day: 'numeric' };
            const formattedStartDate = startDate.toLocaleDateString(undefined, dateFormat);
            const formattedEndDate = endDate.toLocaleDateString(undefined, dateFormat);
            summaryHeader.textContent = `Contribution Summary (${formattedStartDate} to ${formattedEndDate})`;
            
            // Filter only daily activities (with dates)
            const dailyActivities = activities.filter(a => a.date !== null);
            
            // Group activities by user and date
            const userStats = {};
            
            // Initialize user stats objects
            Array.from(addedUsers).forEach(username => {
                userStats[username] = {
                    totalContributions: 0,
                    maxContributions: 0,
                    activeDays: 0,
                    contributions: {}
                };
                
                // Initialize with zero values for all dates
                allDates.forEach(date => {
                    userStats[username].contributions[date] = 0;
                });
            });
            
            // Process daily contributions
            dailyActivities.forEach(activity => {
                if (activity.date) {
                    const dateKey = activity.date.toISOString().split('T')[0];
                    const username = activity.username;
                    const count = activity.count || 1;
                    
                    // Add to daily count
                    userStats[username].contributions[dateKey] += count;
                    
                    // Update total count
                    userStats[username].totalContributions += count;
                    
                    // Update max contributions for a single day
                    if (userStats[username].contributions[dateKey] > userStats[username].maxContributions) {
                        userStats[username].maxContributions = userStats[username].contributions[dateKey];
                    }
                }
            });
            
            console.log("Generating summary for users:", Object.keys(userStats));
            
            // Calculate additional stats and sort users by total contributions (descending)
            const sortedUsers = Object.keys(userStats).sort((a, b) => 
                userStats[b].totalContributions - userStats[a].totalContributions
            );
            
            // Counter for striping rows
            let rowCount = 0;
            
            sortedUsers.forEach(username => {
                const stats = userStats[username];
                
                // Count active days (days with at least one contribution)
                stats.activeDays = Object.values(stats.contributions).filter(count => count > 0).length;
                
                // Calculate daily average
                stats.dailyAverage = stats.totalContributions / totalDays;
                
                // Add row to summary table with alternating background for better readability
                const row = document.createElement('tr');
                row.className = rowCount % 2 === 0 
                    ? 'bg-gray-50 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700' 
                    : 'hover:bg-gray-200 dark:hover:bg-gray-700';
                rowCount++;
                
                row.innerHTML = `
                    <td class="p-3 pl-4">
                        <div class="flex items-center">
                            <span class="w-4 h-4 rounded-full mr-2" style="background-color: ${userColors[username]}"></span>
                            <span class="font-medium">${username}</span>
                        </div>
                    </td>
                    <td class="p-3 text-right font-semibold text-primary">${stats.totalContributions.toLocaleString()}</td>
                    <td class="p-3 text-right">${stats.dailyAverage.toFixed(1)}</td>
                    <td class="p-3 text-right">${stats.maxContributions}</td>
                    <td class="p-3 text-right">${stats.activeDays}/${totalDays} (${Math.round(stats.activeDays/totalDays*100)}%)</td>
                `;
                
                summaryTable.appendChild(row);
            });
            
            // If no users had data, show a message
            if (sortedUsers.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="5" class="p-4 text-center text-gray-500 italic">
                        No activity data found for the selected users and time period.
                    </td>
                `;
                summaryTable.appendChild(emptyRow);
            }
        }
        
        // Display activities in table
        function displayActivityTable(activities) {
            activityTable.innerHTML = '';
            
            // Get the GitHub URL for repository links
            const githubUrl = document.getElementById('github-url').value.trim().replace(/\/$/, '');
            
            // Group by type
            const dailyActivities = activities.filter(a => a.date !== null);
            const repoActivities = activities.filter(a => a.date === null);
            
            // First show daily activities
            dailyActivities.forEach(activity => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-200 dark:hover:bg-gray-700';
                
                const formattedDate = activity.date ? new Intl.DateTimeFormat('default', {
                    dateStyle: 'medium',
                    timeStyle: 'short'
                }).format(activity.date) : '-';
                
                row.innerHTML = `
                    <td class="p-3">
                        <div class="flex items-center">
                            <span class="w-3 h-3 rounded-full mr-2" style="background-color: ${activity.color}"></span>
                            ${activity.username}
                        </div>
                    </td>
                    <td class="p-3">${formattedDate}</td>
                    <td class="p-3">${activity.type}</td>
                    <td class="p-3">
                        <div class="flex items-center">
                            ${activity.repo === 'Multiple Repositories' ? 
                                activity.repo : 
                                `<a href="${githubUrl}/${activity.repo}" target="_blank" 
                                   class="text-primary hover:underline mr-1">${activity.repo}</a>`
                            }
                            ${activity.isPrivate ? '<span class="ml-1 px-1.5 py-0.5 bg-gray-200 dark:bg-gray-700 text-xs rounded-md">private</span>' : ''}
                        </div>
                    </td>
                    <td class="p-3">${activity.details}</td>
                `;
                
                activityTable.appendChild(row);
            });
            
            // Add a separator for repository summary if there are daily activities
            if (dailyActivities.length > 0 && repoActivities.length > 0) {
                const separatorRow = document.createElement('tr');
                separatorRow.innerHTML = `
                    <td colspan="5" class="py-2 px-3 bg-gray-100 dark:bg-gray-800 text-sm font-medium">
                        Repository Summary
                    </td>
                `;
                activityTable.appendChild(separatorRow);
            }
            
            // Then show repository summaries
            repoActivities.forEach(activity => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-200 dark:hover:bg-gray-700';
                
                row.innerHTML = `
                    <td class="p-3">
                        <div class="flex items-center">
                            <span class="w-3 h-3 rounded-full mr-2" style="background-color: ${activity.color}"></span>
                            ${activity.username}
                        </div>
                    </td>
                    <td class="p-3">-</td>
                    <td class="p-3">${activity.type}</td>
                    <td class="p-3">
                        <div class="flex items-center">
                            <a href="${githubUrl}/${activity.repo}" target="_blank" 
                               class="text-primary hover:underline mr-1">${activity.repo}</a>
                            ${activity.isPrivate ? '<span class="ml-1 px-1.5 py-0.5 bg-gray-200 dark:bg-gray-700 text-xs rounded-md">private</span>' : ''}
                        </div>
                    </td>
                    <td class="p-3">${activity.details}</td>
                `;
                
                activityTable.appendChild(row);
            });
        }
        
        // Display activities in chart
        function displayActivityChart(activities, startDate, endDate) {
            // Store these values for later toggle operations
            window.lastActivities = activities;
            window.lastStartDate = startDate;
            window.lastEndDate = endDate;
            // We need to filter to only use activities that have date information
            const dailyActivities = activities.filter(a => a.date !== null);
            
            // Group activities by user and date
            const userActivities = {};
            const allDates = getDatesInRange(startDate, endDate);
            
            // Initialize with zero values for all dates
            Array.from(addedUsers).forEach(username => {
                userActivities[username] = {};
                allDates.forEach(date => {
                    userActivities[username][date] = 0;
                });
            });
            
            // Count contribution counts by user and date
            dailyActivities.forEach(activity => {
                if (activity.date) {
                    const dateKey = activity.date.toISOString().split('T')[0];
                    
                    // For contributions from the GraphQL API, we have actual counts
                    if (activity.count) {
                        userActivities[activity.username][dateKey] = activity.count;
                    } else {
                        // Fallback for other activity types
                        userActivities[activity.username][dateKey] += 1;
                    }
                }
            });
            
            // Calculate averages for each user
            const userAverages = {};
            Array.from(addedUsers).forEach(username => {
                const values = Object.values(userActivities[username]);
                const sum = values.reduce((acc, val) => acc + val, 0);
                userAverages[username] = sum / values.length;
            });
            
            // Check if averages should be shown
            const showAverages = document.getElementById('show-averages').checked;
            
            // Prepare datasets for Chart.js
            const datasets = [];
            
            // Add actual contribution lines
            Array.from(addedUsers).forEach(username => {
                const data = allDates.map(date => ({
                    x: date,
                    y: userActivities[username][date] || 0
                }));
                
                datasets.push({
                    label: username,
                    data: data,
                    backgroundColor: userColors[username],
                    borderColor: userColors[username],
                    borderWidth: 2,
                    tension: 0.3,
                    pointRadius: 3,
                    pointHoverRadius: 5
                });
                
                // Add average contribution dotted lines if toggle is on
                if (showAverages) {
                    datasets.push({
                        label: `${username} (avg: ${userAverages[username].toFixed(1)})`,
                        data: allDates.map(date => ({
                            x: date,
                            y: userAverages[username]
                        })),
                        borderColor: userColors[username],
                        borderWidth: 2,
                        borderDash: [5, 5],
                        tension: 0,
                        pointRadius: 0,
                        fill: false,
                        spanGaps: true,
                        order: 1 // Make sure average lines are drawn behind the actual data
                    });
                }
            });
            
            // Create or update chart
            const ctx = document.getElementById('activity-chart').getContext('2d');
            
            if (activityChart) {
                activityChart.destroy();
            }
            
            // Create new chart
            activityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                tooltipFormat: 'PP'
                            },
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Contributions'
                            },
                            ticks: {
                                precision: 0
                            }
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: (tooltipItems) => {
                                    return new Date(tooltipItems[0].parsed.x).toLocaleDateString();
                                }
                            }
                        },
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                boxWidth: 10,
                                filter: function(item) {
                                    // Only show the main user lines in the legend, not the averages
                                    return !item.text.includes('(avg:');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Get all dates in a range
        function getDatesInRange(startDate, endDate) {
            const dates = [];
            let currentDate = new Date(startDate);
            
            // Reset to start of day
            currentDate.setHours(0, 0, 0, 0);
            
            while (currentDate <= endDate) {
                dates.push(currentDate.toISOString().split('T')[0]);
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            return dates;
        }
        
        // Show loading indicator
        function showLoading() {
            loadingElement.classList.remove('hidden');
        }
        
        // Hide loading indicator
        function hideLoading() {
            loadingElement.classList.add('hidden');
        }
        
        // Show error message
        function showError(message) {
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
        }
        
        // Hide error message
        function hideError() {
            errorElement.classList.add('hidden');
        }
        
        // Show results section
        function showResults() {
            resultsElement.classList.remove('hidden');
        }
        
        // Clear previous results
        function clearResults() {
            if (activityChart) {
                activityChart.destroy();
                activityChart = null;
            }
            
            // Clear all tables
            activityTable.innerHTML = '';
            document.querySelector('#summary-table tbody').innerHTML = '';
            
            // Hide sections
            document.getElementById('no-data').classList.add('hidden');
            document.getElementById('summary-section').classList.add('hidden');
            resultsElement.classList.add('hidden');
        }
    </script>
</body>
</html>
