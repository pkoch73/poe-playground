<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Plan Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --border: #e2e8f0;
            --accent: #6366f1;
            --accent-light: #818cf8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
        }

        .dark {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #64748b;
            --border: #334155;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: background 0.3s, color 0.3s;
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        .upload-zone {
            border: 2px dashed var(--border);
            background: var(--bg-secondary);
            transition: all 0.3s;
        }

        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--accent);
            background: var(--bg-tertiary);
        }

        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
        }

        .status-done { background: var(--success); color: white; }
        .status-wip { background: var(--warning); color: white; }
        .status-new { background: var(--info); color: white; }
        .status-blocked { background: var(--danger); color: white; }
        .status-postmvp { background: var(--text-muted); color: white; }

        .issue-card {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05));
            border-left: 4px solid var(--danger);
        }

        .dark .issue-card {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1));
        }

        .node-done { fill: var(--success); }
        .node-wip { fill: var(--warning); }
        .node-new { fill: var(--info); }
        .node-blocked { fill: var(--danger); }
        .node-postmvp { fill: var(--text-muted); }
        .node-issue {
            stroke: var(--danger);
            stroke-width: 4px;
            filter: drop-shadow(0 0 8px rgba(239, 68, 68, 0.6));
            animation: pulseIssue 2s ease-in-out infinite;
        }

        @keyframes pulseIssue {
            0%, 100% { filter: drop-shadow(0 0 8px rgba(239, 68, 68, 0.6)); }
            50% { filter: drop-shadow(0 0 16px rgba(239, 68, 68, 0.9)); }
        }

        .link { stroke: var(--text-muted); stroke-opacity: 0.6; fill: none; }
        .link-issue { stroke: var(--danger); stroke-opacity: 0.8; stroke-dasharray: 5,5; }

        .feasibility-go {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05));
            border: 2px solid var(--success);
            border-radius: 12px;
        }

        .feasibility-warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(245, 158, 11, 0.05));
            border: 2px solid var(--warning);
            border-radius: 12px;
        }

        .feasibility-blocked {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.05));
            border: 2px solid var(--danger);
            border-radius: 12px;
        }

        .dep-chain-item {
            padding: 8px 12px;
            border-radius: 6px;
            background: var(--bg-tertiary);
            border-left: 3px solid var(--border);
        }

        .dep-chain-item.done { border-left-color: var(--success); }
        .dep-chain-item.wip { border-left-color: var(--warning); }
        .dep-chain-item.blocked { border-left-color: var(--danger); }
        .dep-chain-item.new { border-left-color: var(--info); }

        .tooltip {
            position: absolute;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
            max-width: 300px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .tab-btn {
            padding: 10px 20px;
            border-radius: 8px;
            transition: all 0.2s;
            color: var(--text-secondary);
            background: transparent;
        }

        .tab-btn:hover { background: var(--bg-tertiary); }
        .tab-btn.active { background: var(--accent); color: white; }

        .gantt-bar {
            height: 24px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .gantt-bar:hover { filter: brightness(1.1); transform: scaleY(1.1); }

        .gantt-bar-svg { transition: all 0.2s; cursor: pointer; }
        .gantt-bar-svg:hover { filter: brightness(1.15); }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in { animation: fadeIn 0.4s ease-out forwards; }

        .stagger-1 { animation-delay: 0.1s; opacity: 0; }
        .stagger-2 { animation-delay: 0.2s; opacity: 0; }
        .stagger-3 { animation-delay: 0.3s; opacity: 0; }

        input[type="file"] { font-size: 16px; }

        .legend-item { display: flex; align-items: center; gap: 8px; }
        .legend-dot { width: 12px; height: 12px; border-radius: 50%; }

        #graph-container { overflow: hidden; }

        svg text { font-family: 'JetBrains Mono', monospace; font-size: 11px; }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen p-4 md:p-8">
        <!-- Header -->
        <header class="max-w-7xl mx-auto mb-8 fade-in">
            <h1 class="text-3xl md:text-4xl font-bold mb-2" style="color: var(--accent);">
                üìä Project Plan Analyzer
            </h1>
            <p style="color: var(--text-secondary);">Upload your Excel file to visualize dependencies and identify issues</p>
        </header>

        <!-- Compact Upload Section -->
        <section id="upload-section" class="max-w-7xl mx-auto mb-6 fade-in stagger-1">
            <div class="card p-4">
                <div class="flex flex-wrap items-center gap-4">
                    <!-- Drop Zone (Compact) -->
                    <div class="upload-zone rounded-lg px-6 py-4 cursor-pointer flex items-center gap-4 flex-grow" id="drop-zone" style="min-width: 200px; border-radius: 8px;">
                        <input type="file" id="file-input" accept=".xlsx,.xls" class="hidden">
                        <svg class="w-8 h-8 flex-shrink-0" style="color: var(--accent);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        <div>
                            <p class="font-medium" style="color: var(--text-primary);">Drop Excel file or click to browse</p>
                            <p class="text-xs mono" style="color: var(--text-muted);">.xlsx, .xls</p>
                        </div>
                    </div>

                    <!-- File Info (shown after upload) -->
                    <div id="file-info" class="hidden flex items-center gap-3 px-4 py-2 rounded-lg" style="background: var(--bg-tertiary);">
                        <span class="text-xl">üìÑ</span>
                        <div>
                            <p class="font-medium text-sm" id="file-name">filename.xlsx</p>
                            <p class="text-xs" style="color: var(--text-muted);" id="file-size">0 KB</p>
                        </div>
                        <button id="clear-file" class="ml-2 p-1 rounded hover:bg-red-100 dark:hover:bg-red-900" style="color: var(--danger);" title="Clear file">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>

                    <!-- Sheet Selector (shown after upload) -->
                    <div id="sheet-section" class="hidden flex items-center gap-2">
                        <label class="text-sm font-medium" style="color: var(--text-secondary);">Sheet:</label>
                        <select id="sheet-select" class="px-3 py-2 rounded-lg text-base" style="background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border); min-width: 180px;">
                        </select>
                    </div>
                </div>
            </div>
        </section>

        <!-- Results Section -->
        <section id="results-section" class="max-w-7xl mx-auto hidden">
            <!-- Summary Panel (Top of Results) -->
            <div id="summary-panel" class="card mb-6 fade-in" style="border-left: 4px solid var(--accent);">
                <div class="p-5">
                    <!-- Header with stats and actions -->
                    <div class="flex flex-wrap items-start justify-between gap-4 mb-4">
                        <div>
                            <h2 class="text-xl font-bold flex items-center gap-2" style="color: var(--accent);">
                                üìä Project Summary
                                <span id="summary-date" class="text-sm font-normal" style="color: var(--text-muted);"></span>
                            </h2>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="copySummaryToClipboard()" class="px-3 py-1.5 rounded-lg text-sm font-medium flex items-center gap-1" style="background: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border);" title="Copy as Markdown">
                                üìã Copy
                            </button>
                            <button onclick="printSummary()" class="px-3 py-1.5 rounded-lg text-sm font-medium flex items-center gap-1" style="background: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border);" title="Print summary">
                                üñ®Ô∏è Print
                            </button>
                        </div>
                    </div>

                    <!-- Quick Stats Row -->
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-5">
                        <div class="p-3 rounded-lg text-center" style="background: var(--bg-tertiary);">
                            <p class="text-2xl font-bold" style="color: var(--accent);" id="stat-total">0</p>
                            <p class="text-xs" style="color: var(--text-muted);">Total</p>
                        </div>
                        <div class="p-3 rounded-lg text-center" style="background: var(--bg-tertiary);">
                            <p class="text-2xl font-bold" style="color: var(--success);" id="stat-done">0</p>
                            <p class="text-xs" style="color: var(--text-muted);">Done</p>
                        </div>
                        <div class="p-3 rounded-lg text-center" style="background: var(--bg-tertiary);">
                            <p class="text-2xl font-bold" style="color: var(--warning);" id="stat-wip">0</p>
                            <p class="text-xs" style="color: var(--text-muted);">In Progress</p>
                        </div>
                        <div class="p-3 rounded-lg text-center" style="background: var(--bg-tertiary);">
                            <p class="text-2xl font-bold" style="color: var(--info);" id="stat-new">0</p>
                            <p class="text-xs" style="color: var(--text-muted);">Not Started</p>
                        </div>
                        <div class="p-3 rounded-lg text-center" style="background: var(--bg-tertiary);">
                            <p class="text-2xl font-bold" style="color: var(--danger);" id="stat-issues">0</p>
                            <p class="text-xs" style="color: var(--text-muted);">Issues</p>
                        </div>
                    </div>

                    <!-- Summary Content Grid -->
                    <div id="summary-content" class="grid md:grid-cols-2 gap-4">
                        <!-- Content will be populated by JavaScript -->
                    </div>

                    <!-- Expand/Collapse -->
                    <div class="mt-4 pt-3 border-t" style="border-color: var(--border);">
                        <button onclick="toggleSummaryExpand()" id="summary-toggle-btn" class="text-sm font-medium" style="color: var(--accent);">
                            ‚ñº Show more details
                        </button>
                    </div>

                    <!-- Expanded Section (hidden by default) -->
                    <div id="summary-expanded" class="hidden mt-4">
                        <div id="summary-expanded-content" class="grid md:grid-cols-2 gap-4">
                            <!-- Additional content when expanded -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Go-Live Milestone Validator -->
            <div class="card p-4 mb-6 fade-in stagger-1">
                <div class="flex flex-wrap items-end gap-4">
                    <div class="flex-grow" style="max-width: 300px;">
                        <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">
                            üéØ Go-Live Milestone Task #
                        </label>
                        <div class="flex gap-2">
                            <select id="milestone-select" class="flex-grow px-4 py-2 rounded-lg text-base" style="background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border);">
                                <option value="">Select milestone...</option>
                            </select>
                            <button id="validate-btn" class="px-4 py-2 rounded-lg font-medium" style="background: var(--accent); color: white;">
                                Validate
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Feasibility Panel -->
            <div id="feasibility-panel" class="mb-8 hidden fade-in">
                <div id="feasibility-content"></div>
            </div>

            <!-- Issues Panel -->
            <div id="issues-panel" class="mb-8 hidden fade-in stagger-2">
                <h2 class="text-xl font-bold mb-4" style="color: var(--danger);">‚ö†Ô∏è Dependency Issues Found</h2>
                <div id="issues-list" class="space-y-3"></div>
            </div>

            <!-- Risk Radar Panel -->
            <div id="risk-radar-panel" class="mb-8 hidden fade-in stagger-2">
                <div class="card p-6" style="border-left: 4px solid var(--warning);">
                    <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 12px; margin-bottom: 16px;">
                        <div>
                            <h2 class="text-xl font-bold" style="color: var(--warning);">üéØ Risk Radar - Vulnerability Analysis</h2>
                            <p class="text-sm mt-1" style="color: var(--text-secondary);">
                                Automatically identifies high-risk areas. Click any task for details.
                            </p>
                        </div>
                        <button onclick="toggleRiskRadarHelp()" class="px-3 py-1 rounded text-sm" style="background: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border);">
                            ‚ùì How it works
                        </button>
                    </div>
                    <!-- Help Panel (hidden by default) -->
                    <div id="risk-radar-help" class="hidden mb-4 p-4" style="background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border);">
                        <h4 class="font-bold mb-3" style="color: var(--text-primary);">üìä How Risk Radar Works</h4>
                        <div class="space-y-3 text-sm" style="color: var(--text-secondary);">
                            <div>
                                <p class="font-medium" style="color: var(--text-primary);">What it does:</p>
                                <p>Automatically simulates a 3-day delay on each incomplete task to identify which tasks would cause the most damage if they slip.</p>
                            </div>
                            <div>
                                <p class="font-medium" style="color: var(--text-primary);">Risk Score Calculation:</p>
                                <ul class="mt-1 ml-4 space-y-1" style="list-style: disc;">
                                    <li><strong>Downstream Impact:</strong> +2 points per task that depends on this one (directly or indirectly)</li>
                                    <li><strong>Critical Impacts:</strong> +10 points for each task that would miss deadline or lose 50%+ time</li>
                                    <li><strong>At-Risk Impacts:</strong> +5 points for each task that would have tight buffer</li>
                                    <li><strong>Time Buffer:</strong> +50 if overdue, +30 if ‚â§7 days, +15 if ‚â§14 days to deadline</li>
                                    <li><strong>Status:</strong> +40 if blocked, +10 if new (not started)</li>
                                </ul>
                            </div>
                            <div>
                                <p class="font-medium" style="color: var(--text-primary);">Severity Levels:</p>
                                <ul class="mt-1 ml-4 space-y-1">
                                    <li>üî¥ <strong>High Risk (‚â•50):</strong> Critical bottlenecks - delay here causes widespread damage</li>
                                    <li>üü† <strong>Medium Risk (20-49):</strong> Significant impact - monitor closely</li>
                                    <li>üü¢ <strong>Low Risk (&lt;20):</strong> Limited downstream impact</li>
                                </ul>
                            </div>
                            <div>
                                <p class="font-medium" style="color: var(--text-primary);">How to use:</p>
                                <p>Focus attention on high-risk tasks first. Use the What-If Simulator in Gantt View to explore specific delay scenarios in more detail.</p>
                            </div>
                        </div>
                    </div>
                    <div id="risk-radar-content"></div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="flex gap-2 mb-6 flex-wrap fade-in stagger-2">
                <button class="tab-btn active" data-tab="graph">Dependency Graph</button>
                <button class="tab-btn" data-tab="gantt">Gantt View</button>
                <button class="tab-btn" data-tab="table">Table View</button>
            </div>

            <!-- Legend -->
            <div class="card p-4 mb-6 fade-in stagger-2">
                <div class="flex flex-wrap gap-6">
                    <div class="legend-item"><div class="legend-dot" style="background: var(--success);"></div><span class="text-sm">Done</span></div>
                    <div class="legend-item"><div class="legend-dot" style="background: var(--warning);"></div><span class="text-sm">WIP</span></div>
                    <div class="legend-item"><div class="legend-dot" style="background: var(--info);"></div><span class="text-sm">New</span></div>
                    <div class="legend-item"><div class="legend-dot" style="background: var(--danger);"></div><span class="text-sm">Blocked</span></div>
                    <div class="legend-item"><div class="legend-dot" style="background: var(--text-muted);"></div><span class="text-sm">Post-MVP</span></div>
                    <div class="legend-item"><div class="legend-dot" style="border: 3px solid var(--danger); background: transparent;"></div><span class="text-sm">Has Issue</span></div>
                </div>
            </div>

            <!-- Graph Tab -->
            <div id="tab-graph" class="card p-4 fade-in stagger-3">
                <div id="graph-container" style="height: 600px; width: 100%;"></div>
            </div>

            <!-- Gantt Tab -->
            <div id="tab-gantt" class="card p-4 hidden fade-in">
                <!-- Delay Simulator Panel -->
                <div id="delay-simulator" class="mb-4 p-4" style="background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border);">
                    <div style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;" onclick="toggleSimulator()">
                        <h3 class="font-bold" style="color: var(--accent);">üîÆ What-If Delay Simulator</h3>
                        <span id="simulator-toggle" style="color: var(--text-muted); font-size: 20px;">‚ñº</span>
                    </div>
                    <div id="simulator-content" class="mt-4">
                        <div class="grid md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Select Task to Delay</label>
                                <select id="simulator-task" class="w-full px-3 py-2 rounded-lg text-base" style="background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border);">
                                    <option value="">Choose a task...</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Delay (days)</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="range" id="simulator-days-slider" min="1" max="30" value="5" style="flex: 1;" oninput="document.getElementById('simulator-days').value = this.value">
                                    <input type="number" id="simulator-days" min="1" max="90" value="5" class="px-3 py-2 rounded-lg text-base mono" style="width: 70px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border);" oninput="document.getElementById('simulator-days-slider').value = Math.min(30, this.value)">
                                </div>
                            </div>
                            <div style="display: flex; align-items: flex-end;">
                                <button onclick="runDelaySimulation()" class="w-full px-4 py-2 rounded-lg font-medium" style="background: var(--accent); color: white;">
                                    ‚ñ∂Ô∏è Simulate Impact
                                </button>
                            </div>
                        </div>
                        <div id="simulator-results" class="hidden">
                            <!-- Results will be rendered here -->
                        </div>
                    </div>
                </div>
                <div id="gantt-container" style="overflow-x: auto;"></div>
            </div>

            <!-- Table Tab -->
            <div id="tab-table" class="card p-4 hidden fade-in">
                <div id="table-container" style="overflow-x: auto;"></div>
            </div>
        </section>

        <!-- Tooltip -->
        <div id="tooltip" class="tooltip"></div>
    </div>

    <script>
        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            document.documentElement.classList.toggle('dark', event.matches);
        });

        // State
        let workbook = null;
        let projectData = [];
        let issues = [];

        // DOM Elements
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const fileInfo = document.getElementById('file-info');
        const fileName = document.getElementById('file-name');
        const fileSize = document.getElementById('file-size');
        const clearFileBtn = document.getElementById('clear-file');
        const sheetSection = document.getElementById('sheet-section');
        const sheetSelect = document.getElementById('sheet-select');
        const resultsSection = document.getElementById('results-section');
        const tooltip = document.getElementById('tooltip');

        // File Upload Handling
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) handleFile(e.target.files[0]);
        });
        clearFileBtn.addEventListener('click', resetApp);

        function handleFile(file) {
            if (!file.name.match(/\.xlsx?$/i)) {
                showCustomAlert('Please upload an Excel file (.xlsx or .xls)');
                return;
            }

            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    workbook = XLSX.read(e.target.result, { type: 'array', cellDates: true });
                    populateSheetSelector();
                } catch (err) {
                    showCustomAlert('Error reading file: ' + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function populateSheetSelector() {
            sheetSelect.innerHTML = '';
            let defaultSheet = null;
            let exactMatch = null;

            workbook.SheetNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;

                // Check for MVP Launch Project Plan - prioritize exact match
                const nameLower = name.toLowerCase().replace(/\s+/g, ' ').trim();
                const nameNormalized = name.replace(/\s+/g, ' ').trim();

                // Exact match (case-insensitive) - highest priority
                if (nameNormalized === 'MVP Launch Project Plan' ||
                    nameLower === 'mvp launch project plan') {
                    exactMatch = name;
                }
                // Partial match - lower priority (only use if no exact match)
                else if (nameLower.includes('mvp launch project plan') ||
                         nameLower.includes('mvp') && nameLower.includes('launch') && nameLower.includes('project')) {
                    if (!defaultSheet) defaultSheet = name;
                }

                sheetSelect.appendChild(option);
            });

            // Prefer exact match, fallback to partial match
            const selectedSheet = exactMatch || defaultSheet;

            // Set the default selection
            if (selectedSheet) {
                sheetSelect.value = selectedSheet;
            }

            sheetSection.classList.remove('hidden');
            processSheet(sheetSelect.value);
        }

        sheetSelect.addEventListener('change', () => processSheet(sheetSelect.value));

        function processSheet(sheetName) {
            const sheet = workbook.Sheets[sheetName];
            // Use raw: true to preserve exact numeric values like 2.21 (not formatted to 2.2)
            const data = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: true, dateNF: 'yyyy-mm-dd' });

            // Find header row
            let headerRowIndex = -1;
            let headers = [];
            for (let i = 0; i < Math.min(10, data.length); i++) {
                const row = data[i];
                if (row && row.some(cell => cell && cell.toString().toLowerCase().includes('task'))) {
                    headerRowIndex = i;
                    headers = row.map(h => h ? h.toString().trim() : '');
                    break;
                }
            }

            if (headerRowIndex === -1) {
                showCustomAlert('Could not find header row with Task column');
                return;
            }

            // Map columns
            const colMap = {};
            headers.forEach((h, i) => {
                const hLower = h.toLowerCase();
                if (hLower.includes('task') && hLower.includes('#')) colMap.taskId = i;
                else if (hLower.includes('task') && hLower.includes('description')) colMap.description = i;
                else if (hLower.includes('owner')) colMap.owner = i;
                else if (hLower === 'status') colMap.status = i;
                else if (hLower.includes('dependencies') || hLower.includes('dependency')) colMap.dependencies = i;
                else if (hLower.includes('start')) colMap.startDate = i;
                else if (hLower.includes('actual') && hLower.includes('end')) colMap.actualEnd = i;
                else if (hLower.includes('anticipated') && hLower.includes('end')) colMap.anticipatedEnd = i;
                else if (hLower.includes('comments')) colMap.comments = i;
            });

            // Parse data
            projectData = [];
            for (let i = headerRowIndex + 1; i < data.length; i++) {
                const row = data[i];
                if (!row || row[colMap.taskId] === undefined || row[colMap.taskId] === null) continue;

                // Format task ID - preserve decimal precision for numbers like 2.21
                let taskId = row[colMap.taskId];
                if (typeof taskId === 'number') {
                    // Use toPrecision or toString to preserve decimals
                    taskId = String(taskId);
                } else {
                    taskId = taskId?.toString().trim();
                }
                if (!taskId || taskId === '--') continue;

                const status = normalizeStatus(row[colMap.status]);
                const deps = parseDependencies(row[colMap.dependencies]);
                const dateHistory = parseDateHistory(row[colMap.anticipatedEnd]);
                const anticipatedEnd = dateHistory.current;
                const originalAnticipatedEnd = dateHistory.original;
                const actualEnd = parseDate(row[colMap.actualEnd]);
                const startDate = parseDate(row[colMap.startDate]);

                projectData.push({
                    id: taskId,
                    description: row[colMap.description]?.toString().trim() || '',
                    owner: row[colMap.owner]?.toString().trim() || '',
                    status: status,
                    dependencies: deps,
                    startDate: startDate,
                    actualEnd: actualEnd,
                    anticipatedEnd: anticipatedEnd,
                    originalAnticipatedEnd: originalAnticipatedEnd,
                    dateWasMoved: dateHistory.wasMoved,
                    dateMovedDays: dateHistory.daysMoved,
                    comments: row[colMap.comments]?.toString().trim() || ''
                });
            }

            // Analyze issues
            analyzeIssues();

            // Display results
            displayResults();
        }

        function normalizeStatus(status) {
            if (!status) return 'unknown';
            const s = status.toString().toLowerCase().trim();
            if (s === 'done') return 'done';
            if (s === 'wip') return 'wip';
            if (s === 'new') return 'new';
            if (s === 'blocked') return 'blocked';
            if (s.includes('post') || s.includes('mvp')) return 'postmvp';
            return 'unknown';
        }

        function parseDependencies(deps) {
            if (!deps) return [];
            const depsStr = deps.toString().trim();
            if (depsStr === '--' || depsStr === '-' || depsStr === '') return [];
            return depsStr.split(/[,;]/).map(d => d.trim()).filter(d => d && d !== '--');
        }

        function parseDate(dateVal) {
            if (!dateVal) return null;

            // Handle Excel date objects
            if (dateVal instanceof Date && !isNaN(dateVal)) {
                return dateVal;
            }

            // Handle Excel serial date numbers (raw: true returns these)
            // Excel dates are days since 1900-01-01 (with a bug for 1900 leap year)
            if (typeof dateVal === 'number' && dateVal > 1000 && dateVal < 100000) {
                // Convert Excel serial to JS Date
                const excelEpoch = new Date(1899, 11, 30); // Excel epoch (Dec 30, 1899)
                const jsDate = new Date(excelEpoch.getTime() + dateVal * 24 * 60 * 60 * 1000);
                if (!isNaN(jsDate)) return jsDate;
            }

            const str = dateVal.toString().trim();
            if (!str || str.toLowerCase() === 'post-mvp' || str === '--') return null;

            // Try to extract the last date from strings with multiple dates
            const datePatterns = str.split(/\s+/);
            const lastPart = datePatterns[datePatterns.length - 1];

            // Try dd-mm-yyyy
            let match = lastPart.match(/(\d{1,2})-(\d{1,2})-(\d{4})/);
            if (match) {
                const [, day, month, year] = match;
                return new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
            }

            // Try mm/dd/yyyy
            match = lastPart.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
            if (match) {
                const [, month, day, year] = match;
                return new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
            }

            // Try yyyy-mm-dd
            match = lastPart.match(/(\d{4})-(\d{1,2})-(\d{1,2})/);
            if (match) {
                const [, year, month, day] = match;
                return new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
            }

            // Try parsing as is
            const parsed = new Date(str);
            if (!isNaN(parsed)) return parsed;

            return null;
        }

        // Parse date history to detect moved dates (multiple dates in cell = date was revised)
        function parseDateHistory(dateVal) {
            const result = {
                current: null,
                original: null,
                wasMoved: false,
                daysMoved: 0,
                allDates: []
            };

            if (!dateVal) return result;

            // Handle Excel date objects (single date, no history)
            if (dateVal instanceof Date && !isNaN(dateVal)) {
                result.current = dateVal;
                return result;
            }

            // Handle Excel serial date numbers (single date, no history)
            if (typeof dateVal === 'number' && dateVal > 1000 && dateVal < 100000) {
                const excelEpoch = new Date(1899, 11, 30);
                const jsDate = new Date(excelEpoch.getTime() + dateVal * 24 * 60 * 60 * 1000);
                if (!isNaN(jsDate)) {
                    result.current = jsDate;
                }
                return result;
            }

            const str = dateVal.toString().trim();
            if (!str || str.toLowerCase() === 'post-mvp' || str === '--') return result;

            // Helper function to parse a single date string
            function parseSingleDate(dateStr) {
                if (!dateStr) return null;
                dateStr = dateStr.trim();

                // Try dd-mm-yyyy
                let match = dateStr.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/);
                if (match) {
                    const [, day, month, year] = match;
                    return new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                }

                // Try mm/dd/yyyy
                match = dateStr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
                if (match) {
                    const [, month, day, year] = match;
                    return new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                }

                // Try yyyy-mm-dd
                match = dateStr.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
                if (match) {
                    const [, year, month, day] = match;
                    return new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                }

                return null;
            }

            // Split by whitespace to find multiple dates
            const parts = str.split(/\s+/).filter(p => p.length > 0);
            const dates = [];

            for (const part of parts) {
                const parsed = parseSingleDate(part);
                if (parsed && !isNaN(parsed)) {
                    dates.push(parsed);
                }
            }

            result.allDates = dates;

            if (dates.length > 0) {
                // Current date is the last one (most recent)
                result.current = dates[dates.length - 1];

                if (dates.length > 1) {
                    // Original date is the first one
                    result.original = dates[0];
                    result.wasMoved = true;

                    // Calculate days moved (positive = pushed out, negative = pulled in)
                    const diffMs = result.current.getTime() - result.original.getTime();
                    result.daysMoved = Math.round(diffMs / (1000 * 60 * 60 * 24));
                }
            }

            return result;
        }

        function analyzeIssues() {
            issues = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const taskMap = new Map(projectData.map(t => [t.id, t]));

            projectData.forEach(task => {
                const taskIssues = [];

                task.dependencies.forEach(depId => {
                    const dep = taskMap.get(depId);
                    if (!dep) {
                        // Dependency not found - could be missing data
                        taskIssues.push({
                            type: 'missing',
                            depId: depId,
                            message: `Dependency "${depId}" not found in project plan`
                        });
                    } else if (dep.status !== 'done') {
                        // Check if this task's due date has passed but dependency isn't done
                        const dueDate = task.anticipatedEnd || task.actualEnd;
                        if (dueDate && dueDate < today) {
                            taskIssues.push({
                                type: 'overdue',
                                depId: depId,
                                depStatus: dep.status,
                                dueDate: dueDate,
                                message: `Dependency "${depId}" (${dep.status.toUpperCase()}) not complete but task was due ${formatDate(dueDate)}`
                            });
                        } else if (dep.status === 'wip' || dep.status === 'new' || dep.status === 'blocked') {
                            taskIssues.push({
                                type: 'incomplete',
                                depId: depId,
                                depStatus: dep.status,
                                message: `Dependency "${depId}" is ${dep.status.toUpperCase()}, not yet complete`
                            });
                        }
                    }
                });

                if (taskIssues.length > 0) {
                    issues.push({
                        task: task,
                        issues: taskIssues
                    });
                }

                task.hasIssue = taskIssues.some(i => i.type === 'overdue' || i.type === 'missing');
            });
        }

        function displayResults() {
            resultsSection.classList.remove('hidden');

            // Stats
            document.getElementById('stat-total').textContent = projectData.length;
            document.getElementById('stat-done').textContent = projectData.filter(t => t.status === 'done').length;
            document.getElementById('stat-wip').textContent = projectData.filter(t => t.status === 'wip').length;
            document.getElementById('stat-new').textContent = projectData.filter(t => t.status === 'new').length;
            document.getElementById('stat-issues').textContent = issues.filter(i => i.issues.some(is => is.type === 'overdue')).length;

            // Populate inline summary panel
            populateSummaryPanel();

            // Issues Panel
            const criticalIssues = issues.filter(i => i.issues.some(is => is.type === 'overdue'));
            const issuesPanel = document.getElementById('issues-panel');
            const issuesList = document.getElementById('issues-list');

            if (criticalIssues.length > 0) {
                issuesPanel.classList.remove('hidden');
                issuesList.innerHTML = criticalIssues.map(issue => `
                    <div class="issue-card card p-4">
                        <div class="flex items-start gap-3">
                            <span class="text-2xl">üö®</span>
                            <div>
                                <p class="font-bold mono">${escapeHtml(issue.task.id)}: ${escapeHtml(truncate(issue.task.description, 60))}</p>
                                <ul class="mt-2 space-y-1">
                                    ${issue.issues.filter(i => i.type === 'overdue').map(i => `
                                        <li class="text-sm" style="color: var(--text-secondary);">‚Ä¢ ${escapeHtml(i.message)}</li>
                                    `).join('')}
                                </ul>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                issuesPanel.classList.add('hidden');
            }

            // Render views
            renderGraph();
            renderGantt();
            renderTable();

            // Populate milestone selector
            populateMilestoneSelector();

            // Populate simulator task dropdown
            populateSimulatorTasks();

            // Run automatic risk analysis
            analyzeRiskAreas();
        }

        function populateMilestoneSelector() {
            const select = document.getElementById('milestone-select');
            select.innerHTML = '<option value="">Select milestone...</option>';

            projectData.forEach(task => {
                const option = document.createElement('option');
                option.value = task.id;
                option.textContent = `${task.id}: ${truncate(task.description, 50)}`;
                select.appendChild(option);
            });
        }

        function validateGoLiveFeasibility(milestoneId) {
            const taskMap = new Map(projectData.map(t => [t.id, t]));
            const milestone = taskMap.get(milestoneId);

            if (!milestone) {
                showCustomAlert(`Milestone "${milestoneId}" not found`);
                return;
            }

            // Trace all dependencies recursively
            const visited = new Set();
            const dependencyChain = [];
            const blockers = [];
            const warnings = [];

            function traceDependencies(taskId, depth = 0) {
                if (visited.has(taskId)) return;
                visited.add(taskId);

                const task = taskMap.get(taskId);
                if (!task) {
                    blockers.push({
                        type: 'missing',
                        taskId: taskId,
                        message: `Task "${taskId}" not found in project plan`,
                        depth: depth
                    });
                    return;
                }

                dependencyChain.push({ task, depth });

                // Check for issues
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                if (task.status === 'blocked') {
                    blockers.push({
                        type: 'blocked',
                        task: task,
                        message: `Task ${task.id} is BLOCKED`,
                        depth: depth
                    });
                } else if (task.status !== 'done') {
                    const dueDate = task.anticipatedEnd;
                    if (dueDate && dueDate < today) {
                        blockers.push({
                            type: 'overdue',
                            task: task,
                            message: `Task ${task.id} (${task.status.toUpperCase()}) is overdue - was due ${formatDate(dueDate)}`,
                            depth: depth
                        });
                    } else if (task.status === 'wip' || task.status === 'new') {
                        warnings.push({
                            type: 'incomplete',
                            task: task,
                            message: `Task ${task.id} is ${task.status.toUpperCase()} - due ${dueDate ? formatDate(dueDate) : 'TBD'}`,
                            depth: depth
                        });
                    }
                }

                // Recurse into dependencies
                task.dependencies.forEach(depId => {
                    traceDependencies(depId, depth + 1);
                });
            }

            traceDependencies(milestoneId);

            // Calculate stats
            const totalDeps = dependencyChain.length;
            const completedDeps = dependencyChain.filter(d => d.task.status === 'done').length;
            const completionPercent = totalDeps > 0 ? Math.round((completedDeps / totalDeps) * 100) : 0;

            // Calculate next week outlook
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const nextWeekEnd = new Date(today);
            nextWeekEnd.setDate(nextWeekEnd.getDate() + 7);

            const nextWeekTasks = dependencyChain
                .filter(d => {
                    if (d.task.status === 'done') return false;
                    const dueDate = d.task.anticipatedEnd;
                    if (!dueDate) return false;
                    return dueDate >= today && dueDate <= nextWeekEnd;
                })
                .sort((a, b) => (a.task.anticipatedEnd || 0) - (b.task.anticipatedEnd || 0));

            // Calculate week after next (for lookahead)
            const twoWeeksEnd = new Date(today);
            twoWeeksEnd.setDate(twoWeeksEnd.getDate() + 14);

            const followingWeekTasks = dependencyChain
                .filter(d => {
                    if (d.task.status === 'done') return false;
                    const dueDate = d.task.anticipatedEnd;
                    if (!dueDate) return false;
                    return dueDate > nextWeekEnd && dueDate <= twoWeeksEnd;
                })
                .sort((a, b) => (a.task.anticipatedEnd || 0) - (b.task.anticipatedEnd || 0));

            // Find tasks without planned dates (not done)
            const tasksWithoutDates = dependencyChain
                .filter(d => {
                    if (d.task.status === 'done') return false;
                    return !d.task.anticipatedEnd;
                })
                .sort((a, b) => {
                    // Sort by owner, then by task ID
                    const ownerA = a.task.owner || 'ZZZ';
                    const ownerB = b.task.owner || 'ZZZ';
                    if (ownerA !== ownerB) return ownerA.localeCompare(ownerB);
                    return a.task.id.localeCompare(b.task.id);
                });

            // Find tasks where dates were moved (pushed out or pulled in)
            const tasksWithMovedDates = dependencyChain
                .filter(d => d.task.dateWasMoved)
                .sort((a, b) => {
                    // Sort by days moved (largest pushout first)
                    return b.task.dateMovedDays - a.task.dateMovedDays;
                });

            // Calculate total slip days
            const totalSlipDays = tasksWithMovedDates
                .filter(d => d.task.dateMovedDays > 0)
                .reduce((sum, d) => sum + d.task.dateMovedDays, 0);

            // Determine feasibility
            let feasibility = 'go';
            let feasibilityText = '‚úÖ GO - Plan is on track!';
            let feasibilityClass = 'feasibility-go';

            if (blockers.length > 0) {
                feasibility = 'blocked';
                feasibilityText = 'üö´ AT RISK - Critical blockers detected!';
                feasibilityClass = 'feasibility-blocked';
            } else if (warnings.length > 0) {
                feasibility = 'warning';
                feasibilityText = '‚ö†Ô∏è CAUTION - Tasks still in progress';
                feasibilityClass = 'feasibility-warning';
            }

            // Render feasibility panel
            const panel = document.getElementById('feasibility-panel');
            const content = document.getElementById('feasibility-content');

            panel.classList.remove('hidden');

            content.innerHTML = `
                <div class="${feasibilityClass} p-6">
                    <div class="flex flex-wrap items-start justify-between gap-4 mb-6">
                        <div>
                            <h2 class="text-2xl font-bold mb-1">${feasibilityText}</h2>
                            <p class="mono" style="color: var(--text-secondary);">
                                Milestone: <strong>${escapeHtml(milestoneId)}</strong> - ${escapeHtml(truncate(milestone.description, 60))}
                            </p>
                            ${milestone.anticipatedEnd ? `<p class="text-sm mt-1" style="color: var(--text-secondary);">Target Date: <strong>${formatDate(milestone.anticipatedEnd)}</strong></p>` : ''}
                        </div>
                        <div class="text-center">
                            <div class="text-4xl font-bold" style="color: ${feasibility === 'go' ? 'var(--success)' : feasibility === 'warning' ? 'var(--warning)' : 'var(--danger)'};">
                                ${completionPercent}%
                            </div>
                            <p class="text-sm" style="color: var(--text-secondary);">${completedDeps}/${totalDeps} tasks done</p>
                        </div>
                    </div>

                    ${blockers.length > 0 ? `
                        <div class="mb-4">
                            <h3 class="font-bold mb-2" style="color: var(--danger);">üö® Critical Blockers (${blockers.length})</h3>
                            <div class="space-y-2">
                                ${blockers.map(b => `
                                    <div class="dep-chain-item blocked" style="background: rgba(239, 68, 68, 0.15); border-left-color: var(--danger);">
                                        <div class="flex justify-between items-start gap-2">
                                            <div>
                                                <span class="mono font-medium">${escapeHtml(b.task ? b.task.id : b.taskId)}</span>
                                                <span class="text-sm ml-2" style="color: var(--danger);">${escapeHtml(b.message)}</span>
                                                ${b.task && b.task.description ? `<p class="text-sm mt-1" style="color: var(--text-secondary);">${escapeHtml(truncate(b.task.description, 60))}</p>` : ''}
                                            </div>
                                            ${b.task && b.task.owner ? `<div class="text-right flex-shrink-0">
                                                <span class="px-2 py-1 rounded text-xs font-medium" style="background: var(--danger); color: white;">üë§ ${escapeHtml(b.task.owner)}</span>
                                            </div>` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${warnings.length > 0 ? `
                        <div class="mb-4">
                            <h3 class="font-bold mb-2" style="color: var(--warning);">‚ö†Ô∏è In-Progress Tasks (${warnings.length})</h3>
                            <div class="space-y-2">
                                ${warnings.map(w => `
                                    <div class="dep-chain-item ${w.task.status}">
                                        <div class="flex justify-between items-start gap-2">
                                            <div>
                                                <span class="mono font-medium">${escapeHtml(w.task.id)}</span>
                                                <span class="px-2 py-0.5 rounded text-xs font-medium ml-2 status-${w.task.status}">${w.task.status.toUpperCase()}</span>
                                                <span class="text-sm ml-2">${escapeHtml(w.message)}</span>
                                                ${w.task.description ? `<p class="text-sm mt-1" style="color: var(--text-secondary);">${escapeHtml(truncate(w.task.description, 60))}</p>` : ''}
                                            </div>
                                            ${w.task.owner ? `<div class="text-right flex-shrink-0">
                                                <span class="px-2 py-1 rounded text-xs font-medium" style="background: var(--warning); color: white;">üë§ ${escapeHtml(w.task.owner)}</span>
                                            </div>` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Next Week Outlook -->
                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div class="p-4" style="background: var(--bg-tertiary); border-radius: 8px;">
                            <h3 class="font-bold mb-3" style="color: var(--accent);">
                                üìÖ This Week's Focus
                                <span class="text-sm font-normal ml-2" style="color: var(--text-muted);">(${formatDate(today)} - ${formatDate(nextWeekEnd)})</span>
                            </h3>
                            ${nextWeekTasks.length > 0 ? `
                                <div class="space-y-2">
                                    ${nextWeekTasks.map(d => {
                                        const daysLeft = Math.ceil((d.task.anticipatedEnd - today) / (1000 * 60 * 60 * 24));
                                        const urgencyColor = daysLeft <= 2 ? 'var(--danger)' : daysLeft <= 4 ? 'var(--warning)' : 'var(--text-secondary)';
                                        return `
                                            <div class="dep-chain-item ${d.task.status}">
                                                <div class="flex justify-between items-start gap-2">
                                                    <div>
                                                        <span class="mono font-medium">${escapeHtml(d.task.id)}</span>
                                                        <span class="px-2 py-0.5 rounded text-xs font-medium ml-2 status-${d.task.status}">${d.task.status.toUpperCase()}</span>
                                                        <p class="text-sm mt-1" style="color: var(--text-secondary);">${escapeHtml(truncate(d.task.description, 50))}</p>
                                                        ${d.task.owner ? `<p class="text-xs mt-1" style="color: var(--text-muted);">Owner: ${escapeHtml(d.task.owner)}</p>` : ''}
                                                    </div>
                                                    <div class="text-right flex-shrink-0">
                                                        <div class="text-sm font-bold" style="color: ${urgencyColor};">${daysLeft === 0 ? 'TODAY' : daysLeft === 1 ? 'Tomorrow' : daysLeft + ' days'}</div>
                                                        <div class="text-xs" style="color: var(--text-muted);">${formatDate(d.task.anticipatedEnd)}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            ` : `
                                <p class="text-sm" style="color: var(--text-muted);">No tasks due this week üéâ</p>
                            `}
                        </div>

                        <div class="p-4" style="background: var(--bg-tertiary); border-radius: 8px;">
                            <h3 class="font-bold mb-3" style="color: var(--text-secondary);">
                                üîÆ Following Week Preview
                                <span class="text-sm font-normal ml-2" style="color: var(--text-muted);">(${formatDate(new Date(nextWeekEnd.getTime() + 86400000))} - ${formatDate(twoWeeksEnd)})</span>
                            </h3>
                            ${followingWeekTasks.length > 0 ? `
                                <div class="space-y-2">
                                    ${followingWeekTasks.map(d => `
                                        <div class="dep-chain-item ${d.task.status}">
                                            <div class="flex justify-between items-start gap-2">
                                                <div>
                                                    <span class="mono font-medium">${escapeHtml(d.task.id)}</span>
                                                    <span class="px-2 py-0.5 rounded text-xs font-medium ml-2 status-${d.task.status}">${d.task.status.toUpperCase()}</span>
                                                    <p class="text-sm mt-1" style="color: var(--text-secondary);">${escapeHtml(truncate(d.task.description, 50))}</p>
                                                </div>
                                                <div class="text-right flex-shrink-0">
                                                    <div class="text-xs" style="color: var(--text-muted);">${formatDate(d.task.anticipatedEnd)}</div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : `
                                <p class="text-sm" style="color: var(--text-muted);">No tasks due next week</p>
                            `}
                        </div>
                    </div>

                    <!-- Tasks Without Planned Dates -->
                    ${tasksWithoutDates.length > 0 ? `
                        <div class="mb-4 p-4" style="background: var(--bg-tertiary); border-radius: 8px; border-left: 4px solid var(--text-muted);">
                            <h3 class="font-bold mb-3" style="color: var(--text-muted);">
                                üì≠ Tasks Missing Due Dates (${tasksWithoutDates.length})
                                <span class="text-sm font-normal ml-2">- Need scheduling attention</span>
                            </h3>
                            <div class="space-y-2" style="max-height: 250px; overflow-y: auto;">
                                ${(() => {
                                    // Group by owner
                                    const byOwner = {};
                                    tasksWithoutDates.forEach(d => {
                                        const owner = d.task.owner || 'Unassigned';
                                        if (!byOwner[owner]) byOwner[owner] = [];
                                        byOwner[owner].push(d);
                                    });

                                    return Object.entries(byOwner).map(([owner, tasks]) => `
                                        <div class="mb-3">
                                            <div class="flex items-center gap-2 mb-2">
                                                <span class="px-2 py-1 rounded text-xs font-medium" style="background: var(--accent); color: white;">üë§ ${escapeHtml(owner)}</span>
                                                <span class="text-sm" style="color: var(--text-muted);">${tasks.length} task${tasks.length > 1 ? 's' : ''}</span>
                                            </div>
                                            <div class="space-y-1 ml-4">
                                                ${tasks.map(d => `
                                                    <div class="dep-chain-item ${d.task.status}" style="background: var(--bg-secondary);">
                                                        <div class="flex justify-between items-center gap-2">
                                                            <div class="flex items-center gap-2 flex-wrap">
                                                                <span class="mono font-medium">${escapeHtml(d.task.id)}</span>
                                                                <span class="px-2 py-0.5 rounded text-xs font-medium status-${d.task.status}">${d.task.status.toUpperCase()}</span>
                                                                <span class="px-2 py-0.5 rounded text-xs font-medium" style="background: var(--text-muted); color: white;">üìÖ NO DATE</span>
                                                            </div>
                                                        </div>
                                                        <p class="text-sm mt-1" style="color: var(--text-secondary);">${escapeHtml(truncate(d.task.description, 60))}</p>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `).join('');
                                })()}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Tasks With Moved Dates -->
                    ${tasksWithMovedDates.length > 0 ? `
                        <div class="mb-4 p-4" style="background: var(--bg-tertiary); border-radius: 8px; border-left: 4px solid var(--warning);">
                            <h3 class="font-bold mb-3" style="color: var(--warning);">
                                üìÜ Schedule Slippage Analysis (${tasksWithMovedDates.length} tasks moved)
                                ${totalSlipDays > 0 ? `<span class="text-sm font-normal ml-2" style="color: var(--danger);">Total slip: +${totalSlipDays} days</span>` : ''}
                            </h3>
                            <div class="space-y-2" style="max-height: 300px; overflow-y: auto;">
                                ${tasksWithMovedDates.map(d => {
                                    const isPushedOut = d.task.dateMovedDays > 0;
                                    const moveColor = isPushedOut ? 'var(--danger)' : 'var(--success)';
                                    const moveIcon = isPushedOut ? '‚è©' : '‚è™';
                                    const moveText = isPushedOut ? `+${d.task.dateMovedDays} days` : `${d.task.dateMovedDays} days`;
                                    const bgStyle = isPushedOut ? 'background: rgba(239, 68, 68, 0.1);' : 'background: rgba(16, 185, 129, 0.1);';

                                    return `
                                        <div class="dep-chain-item ${d.task.status}" style="${bgStyle}">
                                            <div class="flex justify-between items-start gap-2">
                                                <div class="flex-grow">
                                                    <div class="flex items-center gap-2 flex-wrap">
                                                        <span class="mono font-medium">${escapeHtml(d.task.id)}</span>
                                                        <span class="px-2 py-0.5 rounded text-xs font-medium status-${d.task.status}">${d.task.status.toUpperCase()}</span>
                                                        <span class="px-2 py-0.5 rounded text-xs font-medium" style="background: ${moveColor}; color: white;">${moveIcon} ${moveText}</span>
                                                    </div>
                                                    <p class="text-sm mt-1" style="color: var(--text-secondary);">${escapeHtml(truncate(d.task.description, 55))}</p>
                                                    <div class="text-xs mt-1" style="color: var(--text-muted);">
                                                        <span style="text-decoration: line-through; color: var(--danger);">${formatDate(d.task.originalAnticipatedEnd)}</span>
                                                        <span class="mx-1">‚Üí</span>
                                                        <span style="font-weight: 600;">${formatDate(d.task.anticipatedEnd)}</span>
                                                    </div>
                                                </div>
                                                ${d.task.owner ? `<div class="text-right flex-shrink-0">
                                                    <span class="px-2 py-1 rounded text-xs font-medium" style="background: ${moveColor}; color: white;">üë§ ${escapeHtml(d.task.owner)}</span>
                                                </div>` : ''}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <div>
                        <h3 class="font-bold mb-2" style="color: var(--text-secondary);">üìã Full Dependency Chain (${totalDeps} tasks)</h3>
                        <div class="space-y-1" style="max-height: 300px; overflow-y: auto;">
                            ${dependencyChain.sort((a, b) => a.depth - b.depth).map(d => {
                                const isOverdue = d.task.status !== 'done' && d.task.anticipatedEnd && d.task.anticipatedEnd < today;
                                const overdueStyle = isOverdue ? 'background: rgba(239, 68, 68, 0.15); border-left-color: var(--danger);' : '';
                                return `
                                <div class="dep-chain-item ${d.task.status}" style="margin-left: ${d.depth * 16}px; ${overdueStyle}">
                                    <div class="flex justify-between items-center gap-2">
                                        <div class="flex items-center gap-2 flex-wrap">
                                            <span class="mono font-medium" ${isOverdue ? 'style="color: var(--danger);"' : ''}>${escapeHtml(d.task.id)}</span>
                                            <span class="px-2 py-0.5 rounded text-xs font-medium status-${d.task.status}">${d.task.status.toUpperCase()}</span>
                                            ${isOverdue ? '<span class="px-2 py-0.5 rounded text-xs font-medium" style="background: var(--danger); color: white;">‚è∞ OVERDUE</span>' : ''}
                                            <span class="text-sm" style="color: var(--text-secondary);">${escapeHtml(truncate(d.task.description, 35))}</span>
                                        </div>
                                        ${d.task.owner ? `<span class="text-xs px-2 py-1 rounded flex-shrink-0" style="background: var(--bg-primary); color: var(--text-muted);">üë§ ${escapeHtml(d.task.owner)}</span>` : ''}
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // Event listener for validate button
        document.getElementById('validate-btn').addEventListener('click', () => {
            const milestoneId = document.getElementById('milestone-select').value;
            if (!milestoneId) {
                showCustomAlert('Please select a milestone task');
                return;
            }
            validateGoLiveFeasibility(milestoneId);
        });

        function renderGraph() {
            const container = document.getElementById('graph-container');
            container.innerHTML = '';

            const width = container.clientWidth;
            const height = 600;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            // Create nodes and links
            const nodes = projectData.map(t => ({
                id: t.id,
                description: t.description,
                status: t.status,
                hasIssue: t.hasIssue,
                owner: t.owner,
                anticipatedEnd: t.anticipatedEnd
            }));

            const nodeIds = new Set(nodes.map(n => n.id));
            const links = [];

            projectData.forEach(task => {
                task.dependencies.forEach(depId => {
                    if (nodeIds.has(depId)) {
                        const hasOverdueIssue = issues.some(i =>
                            i.task.id === task.id &&
                            i.issues.some(is => is.depId === depId && is.type === 'overdue')
                        );
                        links.push({
                            source: depId,
                            target: task.id,
                            isIssue: hasOverdueIssue
                        });
                    }
                });
            });

            // Force simulation - use larger collision radius for issue nodes
            const simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links).id(d => d.id).distance(120))
                .force('charge', d3.forceManyBody().strength(-400))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(d => d.hasIssue ? 40 : 25));

            // Arrow marker
            svg.append('defs').append('marker')
                .attr('id', 'arrowhead')
                .attr('viewBox', '-0 -5 10 10')
                .attr('refX', 20)
                .attr('refY', 0)
                .attr('orient', 'auto')
                .attr('markerWidth', 8)
                .attr('markerHeight', 8)
                .append('path')
                .attr('d', 'M 0,-5 L 10,0 L 0,5')
                .attr('fill', 'var(--text-muted)');

            svg.append('defs').append('marker')
                .attr('id', 'arrowhead-issue')
                .attr('viewBox', '-0 -5 10 10')
                .attr('refX', 32)
                .attr('refY', 0)
                .attr('orient', 'auto')
                .attr('markerWidth', 10)
                .attr('markerHeight', 10)
                .append('path')
                .attr('d', 'M 0,-5 L 10,0 L 0,5')
                .attr('fill', 'var(--danger)');

            // Links
            const link = svg.append('g')
                .selectAll('line')
                .data(links)
                .join('line')
                .attr('class', d => d.isIssue ? 'link link-issue' : 'link')
                .attr('stroke-width', d => d.isIssue ? 3 : 1.5)
                .attr('marker-end', d => d.isIssue ? 'url(#arrowhead-issue)' : 'url(#arrowhead)');

            // Nodes - larger radius for issue nodes
            const nodeRadius = d => d.hasIssue ? 28 : 15;
            const node = svg.append('g')
                .selectAll('circle')
                .data(nodes)
                .join('circle')
                .attr('r', nodeRadius)
                .attr('class', d => `node-${d.status}${d.hasIssue ? ' node-issue' : ''}`)
                .style('cursor', 'pointer')
                .call(drag(simulation));

            // Labels - larger font for issue nodes
            const label = svg.append('g')
                .selectAll('text')
                .data(nodes)
                .join('text')
                .text(d => d.id)
                .attr('text-anchor', 'middle')
                .attr('dy', 4)
                .style('fill', 'white')
                .style('font-weight', d => d.hasIssue ? '700' : '600')
                .style('font-size', d => d.hasIssue ? '14px' : '11px')
                .style('pointer-events', 'none');

            // Tooltip
            node.on('mouseover', (event, d) => {
                // Find the specific issues for this task
                let issueHtml = '';
                if (d.hasIssue) {
                    const taskIssues = issues.find(i => i.task.id === d.id);
                    if (taskIssues && taskIssues.issues.length > 0) {
                        const issueItems = taskIssues.issues.map(i =>
                            `<li style="margin-left: 12px; list-style: disc;">‚Ä¢ ${escapeHtml(i.message)}</li>`
                        ).join('');
                        issueHtml = `
                            <div class="mt-2 p-2" style="background: rgba(239, 68, 68, 0.1); border-radius: 6px; border-left: 3px solid var(--danger);">
                                <p class="text-sm font-semibold" style="color: var(--danger);">‚ö†Ô∏è Dependency Issues:</p>
                                <ul class="mt-1 text-sm" style="color: var(--danger);">${issueItems}</ul>
                            </div>
                        `;
                    }
                }

                tooltip.innerHTML = `
                    <p class="font-bold mono">${escapeHtml(d.id)}</p>
                    <p class="mt-1 text-sm">${escapeHtml(truncate(d.description, 100))}</p>
                    <p class="mt-2 text-sm"><strong>Status:</strong> ${d.status.toUpperCase()}</p>
                    ${d.owner ? `<p class="text-sm"><strong>Owner:</strong> ${escapeHtml(d.owner)}</p>` : ''}
                    ${d.anticipatedEnd ? `<p class="text-sm"><strong>Due:</strong> ${formatDate(d.anticipatedEnd)}</p>` : ''}
                    ${issueHtml}
                `;
                tooltip.style.opacity = 1;
                tooltip.style.left = (event.pageX + 10) + 'px';
                tooltip.style.top = (event.pageY - 10) + 'px';
            })
            .on('mouseout', () => {
                tooltip.style.opacity = 0;
            });

            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                node
                    .attr('cx', d => d.x = Math.max(20, Math.min(width - 20, d.x)))
                    .attr('cy', d => d.y = Math.max(20, Math.min(height - 20, d.y)));

                label
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
            });

            function drag(simulation) {
                return d3.drag()
                    .on('start', (event, d) => {
                        if (!event.active) simulation.alphaTarget(0.3).restart();
                        d.fx = d.x;
                        d.fy = d.y;
                    })
                    .on('drag', (event, d) => {
                        d.fx = event.x;
                        d.fy = event.y;
                    })
                    .on('end', (event, d) => {
                        if (!event.active) simulation.alphaTarget(0);
                        d.fx = null;
                        d.fy = null;
                    });
            }
        }

        function renderGantt() {
            const container = document.getElementById('gantt-container');

            // Filter tasks with dates
            const tasksWithDates = projectData.filter(t => t.startDate || t.anticipatedEnd);

            if (tasksWithDates.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 40px;">No tasks with date information found</p>';
                return;
            }

            // Find date range - initialize to first task's dates
            let minDate = null;
            let maxDate = null;

            tasksWithDates.forEach(t => {
                const taskStart = t.startDate || t.anticipatedEnd;
                const taskEnd = t.anticipatedEnd || t.startDate;

                if (taskStart) {
                    if (!minDate || taskStart < minDate) minDate = new Date(taskStart);
                    if (!maxDate || taskStart > maxDate) maxDate = new Date(taskStart);
                }
                if (taskEnd) {
                    if (!minDate || taskEnd < minDate) minDate = new Date(taskEnd);
                    if (!maxDate || taskEnd > maxDate) maxDate = new Date(taskEnd);
                }
            });

            // Fallback to today if no dates found
            if (!minDate) minDate = new Date();
            if (!maxDate) maxDate = new Date();

            // Extend range a bit
            minDate = new Date(minDate);
            minDate.setDate(minDate.getDate() - 7);
            maxDate = new Date(maxDate);
            maxDate.setDate(maxDate.getDate() + 14);

            const totalDays = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24));
            const dayWidth = Math.max(15, 800 / totalDays);
            const chartWidth = totalDays * dayWidth;
            const rowHeight = 36;
            const leftMargin = 200;

            // Create task index map for dependency lines
            const taskIndexMap = new Map();
            tasksWithDates.forEach((task, i) => {
                taskIndexMap.set(task.id, i);
            });

            // Calculate bar positions for dependency lines
            const barPositions = new Map();
            tasksWithDates.forEach((task, i) => {
                const start = task.startDate || task.anticipatedEnd;
                const end = task.anticipatedEnd || task.startDate;
                const startDay = Math.ceil((start - minDate) / (1000 * 60 * 60 * 24));
                const endDay = Math.ceil((end - minDate) / (1000 * 60 * 60 * 24));
                const barWidth = Math.max(dayWidth, (endDay - startDay + 1) * dayWidth);

                barPositions.set(task.id, {
                    rowIndex: i,
                    startX: startDay * dayWidth,
                    endX: startDay * dayWidth + barWidth,
                    centerY: i * rowHeight + rowHeight / 2
                });
            });

            // Generate dependency lines (SVG paths)
            let dependencyLines = '';
            const svgHeight = tasksWithDates.length * rowHeight;

            tasksWithDates.forEach(task => {
                const targetPos = barPositions.get(task.id);
                if (!targetPos) return;

                task.dependencies.forEach(depId => {
                    const sourcePos = barPositions.get(depId);
                    if (!sourcePos) return;

                    // Check if this is an issue dependency
                    const hasIssue = issues.some(i =>
                        i.task.id === task.id &&
                        i.issues.some(is => is.depId === depId && is.type === 'overdue')
                    );

                    const lineColor = hasIssue ? 'var(--danger)' : 'var(--text-muted)';
                    const lineWidth = hasIssue ? 2 : 1;
                    const dashArray = hasIssue ? '4,2' : 'none';

                    // Draw path from end of source to start of target
                    const startX = sourcePos.endX;
                    const startY = sourcePos.centerY;
                    const endX = targetPos.startX;
                    const endY = targetPos.centerY;

                    // Create a curved path
                    const midX = (startX + endX) / 2;

                    if (startX < endX) {
                        // Normal case: dependency ends before task starts
                        dependencyLines += `
                            <path d="M ${startX} ${startY} C ${midX} ${startY}, ${midX} ${endY}, ${endX} ${endY}"
                                  fill="none" stroke="${lineColor}" stroke-width="${lineWidth}"
                                  stroke-dasharray="${dashArray}" opacity="0.7"
                                  marker-end="url(#gantt-arrow${hasIssue ? '-issue' : ''})"/>
                        `;
                    } else {
                        // Overlap case: need to route around
                        const offsetY = 15;
                        const routeY = Math.min(startY, endY) - offsetY;
                        dependencyLines += `
                            <path d="M ${startX} ${startY} L ${startX + 10} ${startY} L ${startX + 10} ${routeY} L ${endX - 10} ${routeY} L ${endX - 10} ${endY} L ${endX} ${endY}"
                                  fill="none" stroke="${lineColor}" stroke-width="${lineWidth}"
                                  stroke-dasharray="${dashArray}" opacity="0.7"
                                  marker-end="url(#gantt-arrow${hasIssue ? '-issue' : ''})"/>
                        `;
                    }
                });
            });

            // Generate week headers
            let weekHeaders = '';
            const startWeek = new Date(minDate);
            startWeek.setDate(startWeek.getDate() - startWeek.getDay()); // Start of week
            const numWeeks = Math.ceil((maxDate - startWeek) / (1000 * 60 * 60 * 24 * 7)) + 1;

            for (let w = 0; w < numWeeks; w++) {
                const weekStart = new Date(startWeek);
                weekStart.setDate(weekStart.getDate() + (w * 7));
                const left = Math.max(0, ((weekStart - minDate) / (1000 * 60 * 60 * 24)) * dayWidth);
                const weekWidth = 7 * dayWidth;
                weekHeaders += `<div style="position: absolute; left: ${left}px; width: ${weekWidth}px; text-align: center; border-left: 1px solid var(--border); font-size: 11px; color: var(--text-muted); padding: 4px 0;">${formatDate(weekStart)}</div>`;
            }

            // Generate task rows with bars
            let taskBars = '';
            tasksWithDates.forEach((task, i) => {
                const pos = barPositions.get(task.id);
                const barWidth = pos.endX - pos.startX;

                const statusColor = {
                    'done': 'var(--success)',
                    'wip': 'var(--warning)',
                    'new': 'var(--info)',
                    'blocked': 'var(--danger)',
                    'postmvp': 'var(--text-muted)'
                }[task.status] || 'var(--text-muted)';

                const issueStyle = task.hasIssue ? 'stroke: var(--danger); stroke-width: 2;' : '';
                const yPos = i * rowHeight + 6;

                taskBars += `
                    <rect x="${pos.startX}" y="${yPos}" width="${barWidth}" height="24" rx="4"
                          fill="${statusColor}" style="${issueStyle}" class="gantt-bar-svg"
                          data-task-id="${escapeHtml(task.id)}">
                    </rect>
                `;
            });

            // Generate task labels (left side)
            let taskLabels = '';
            tasksWithDates.forEach((task, i) => {
                const statusColor = {
                    'done': 'var(--success)',
                    'wip': 'var(--warning)',
                    'new': 'var(--info)',
                    'blocked': 'var(--danger)',
                    'postmvp': 'var(--text-muted)'
                }[task.status] || 'var(--text-muted)';

                taskLabels += `
                    <div style="display: flex; align-items: center; height: ${rowHeight}px; border-bottom: 1px solid var(--border);">
                        <div style="width: ${leftMargin}px; flex-shrink: 0; padding: 0 8px; font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: flex; align-items: center; gap: 6px;" class="mono" title="${escapeHtml(task.id)}: ${escapeHtml(task.description)} (${task.status.toUpperCase()})">
                            <span style="width: 8px; height: 8px; border-radius: 50%; background: ${statusColor}; flex-shrink: 0; ${task.hasIssue ? 'box-shadow: 0 0 0 2px var(--danger);' : ''}"></span>
                            <span style="${task.hasIssue ? 'color: var(--danger);' : ''}">${escapeHtml(task.id)}</span>
                            ${task.dependencies.length > 0 ? `<span style="color: var(--text-muted); font-size: 10px;">(‚Üê${task.dependencies.length})</span>` : ''}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = `
                <div style="display: flex; position: relative;">
                    <!-- Fixed task column -->
                    <div style="width: ${leftMargin}px; flex-shrink: 0; position: sticky; left: 0; z-index: 10; background: var(--bg-secondary);">
                        <div style="font-weight: 600; padding: 8px; border-bottom: 2px solid var(--border); font-size: 13px; height: 38px; display: flex; align-items: center;">Task</div>
                        <div style="max-height: 500px; overflow-y: auto; overflow-x: hidden;" id="gantt-task-scroll">
                            ${taskLabels}
                        </div>
                    </div>
                    <!-- Scrollable chart area -->
                    <div style="flex: 1; overflow-x: auto; overflow-y: hidden;">
                        <div style="min-width: ${chartWidth}px;">
                            <div style="position: relative; height: 38px; border-bottom: 2px solid var(--border);">
                                ${weekHeaders}
                            </div>
                            <div style="max-height: 500px; overflow-y: auto; position: relative;" id="gantt-chart-scroll">
                                <div style="position: relative; height: ${svgHeight}px;">
                                    <svg width="${chartWidth}" height="${svgHeight}" style="position: absolute; top: 0; left: 0;">
                                        <defs>
                                            <marker id="gantt-arrow" viewBox="0 -5 10 10" refX="8" refY="0" markerWidth="6" markerHeight="6" orient="auto">
                                                <path d="M0,-4L10,0L0,4" fill="var(--text-muted)"/>
                                            </marker>
                                            <marker id="gantt-arrow-issue" viewBox="0 -5 10 10" refX="8" refY="0" markerWidth="6" markerHeight="6" orient="auto">
                                                <path d="M0,-4L10,0L0,4" fill="var(--danger)"/>
                                            </marker>
                                        </defs>
                                        <!-- Row backgrounds -->
                                        ${tasksWithDates.map((task, i) => `
                                            <rect x="0" y="${i * rowHeight}" width="${chartWidth}" height="${rowHeight}" fill="transparent" stroke="var(--border)" stroke-width="0.5" style="stroke-dasharray: 0 ${chartWidth} ${rowHeight} 0;"/>
                                            <line x1="0" y1="${(i + 1) * rowHeight}" x2="${chartWidth}" y2="${(i + 1) * rowHeight}" stroke="var(--border)" stroke-width="0.5"/>
                                        `).join('')}
                                        <!-- Dependency lines (drawn first, behind bars) -->
                                        <g class="dependency-lines">
                                            ${dependencyLines}
                                        </g>
                                        <!-- Task bars -->
                                        <g class="task-bars">
                                            ${taskBars}
                                        </g>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 8px; padding: 8px; font-size: 11px; color: var(--text-muted);">
                    <span style="margin-right: 16px;">üìä Dependencies: <span style="border-bottom: 1px dashed var(--text-muted);">gray lines</span></span>
                    <span>‚ö†Ô∏è Issue dependencies: <span style="border-bottom: 2px dashed var(--danger); color: var(--danger);">red dashed lines</span></span>
                </div>
            `;

            // Sync vertical scrolling between task list and chart
            const taskScroll = document.getElementById('gantt-task-scroll');
            const chartScroll = document.getElementById('gantt-chart-scroll');
            if (taskScroll && chartScroll) {
                taskScroll.addEventListener('scroll', () => {
                    chartScroll.scrollTop = taskScroll.scrollTop;
                });
                chartScroll.addEventListener('scroll', () => {
                    taskScroll.scrollTop = chartScroll.scrollTop;
                });
            }

            // Add click handlers to Gantt bars
            container.querySelectorAll('.gantt-bar-svg').forEach(bar => {
                bar.addEventListener('click', (e) => {
                    const taskId = bar.getAttribute('data-task-id');
                    const task = projectData.find(t => t.id === taskId);
                    if (task) {
                        showGanttPopup(task, e);
                    }
                });
            });
        }

        function showGanttPopup(task, event) {
            // Use the shared task popup function
            showTaskPopup(task);
        }

        // Delay Simulator Functions
        function toggleSimulator() {
            const content = document.getElementById('simulator-content');
            const toggle = document.getElementById('simulator-toggle');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = '‚ñº';
            } else {
                content.style.display = 'none';
                toggle.textContent = '‚ñ∂';
            }
        }

        function toggleRiskRadarHelp() {
            const help = document.getElementById('risk-radar-help');
            help.classList.toggle('hidden');
        }

        function populateSimulatorTasks() {
            const select = document.getElementById('simulator-task');
            if (!select) return;

            select.innerHTML = '<option value="">Choose a task...</option>';

            // Only show tasks that have dates and are not done
            projectData
                .filter(t => t.anticipatedEnd && t.status !== 'done')
                .forEach(task => {
                    const option = document.createElement('option');
                    option.value = task.id;
                    option.textContent = `${task.id}: ${truncate(task.description, 40)}`;
                    select.appendChild(option);
                });
        }

        function analyzeRiskAreas() {
            const panel = document.getElementById('risk-radar-panel');
            const content = document.getElementById('risk-radar-content');

            // Only analyze incomplete tasks with dates
            const incompleteTasks = projectData.filter(t =>
                t.status !== 'done' && t.status !== 'postmvp'
            );

            if (incompleteTasks.length === 0) {
                panel.classList.add('hidden');
                return;
            }

            const taskMap = new Map(projectData.map(t => [t.id, t]));
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Build reverse dependency map (task -> tasks that depend on it)
            const reverseDeps = new Map();
            projectData.forEach(task => {
                task.dependencies.forEach(depId => {
                    if (!reverseDeps.has(depId)) {
                        reverseDeps.set(depId, []);
                    }
                    reverseDeps.get(depId).push(task.id);
                });
            });

            // Count all downstream dependents (recursive)
            function countDownstream(taskId, visited = new Set()) {
                if (visited.has(taskId)) return 0;
                visited.add(taskId);

                const directDeps = reverseDeps.get(taskId) || [];
                let count = directDeps.length;
                directDeps.forEach(depId => {
                    count += countDownstream(depId, visited);
                });
                return count;
            }

            // Simulate delay and count critical impacts
            function simulateDelayImpact(taskId, delayDays) {
                const visited = new Set([taskId]);
                let criticalCount = 0;
                let atRiskCount = 0;
                let totalAffected = 0;

                function propagate(currentId) {
                    const dependents = reverseDeps.get(currentId) || [];
                    dependents.forEach(depId => {
                        if (visited.has(depId)) return;
                        visited.add(depId);
                        totalAffected++;

                        const depTask = taskMap.get(depId);
                        if (depTask && depTask.anticipatedEnd) {
                            const daysToDeadline = Math.ceil((depTask.anticipatedEnd - today) / (1000 * 60 * 60 * 24));
                            const newWindow = daysToDeadline - delayDays;
                            const compressionPct = daysToDeadline > 0 ? Math.round((delayDays / daysToDeadline) * 100) : 100;

                            if (newWindow <= 0 || compressionPct >= 50) {
                                criticalCount++;
                            } else if (compressionPct >= 25 || newWindow <= 5) {
                                atRiskCount++;
                            }
                        }
                        propagate(depId);
                    });
                }

                propagate(taskId);
                return { criticalCount, atRiskCount, totalAffected };
            }

            // Analyze each incomplete task
            const riskAnalysis = incompleteTasks.map(task => {
                const downstreamCount = countDownstream(task.id);
                const daysToDeadline = task.anticipatedEnd
                    ? Math.ceil((task.anticipatedEnd - today) / (1000 * 60 * 60 * 24))
                    : null;

                // Simulate a 3-day delay
                const impact = simulateDelayImpact(task.id, 3);

                // Calculate risk score (higher = more risky)
                // Factors: downstream impact, time buffer, current status
                let riskScore = 0;
                riskScore += impact.criticalCount * 10;
                riskScore += impact.atRiskCount * 5;
                riskScore += downstreamCount * 2;

                if (daysToDeadline !== null) {
                    if (daysToDeadline <= 0) riskScore += 50; // Already overdue
                    else if (daysToDeadline <= 7) riskScore += 30; // Very tight
                    else if (daysToDeadline <= 14) riskScore += 15; // Tight
                }

                if (task.status === 'blocked') riskScore += 40;
                else if (task.status === 'new') riskScore += 10;

                return {
                    task,
                    downstreamCount,
                    daysToDeadline,
                    impact,
                    riskScore
                };
            });

            // Sort by risk score (highest first) and take top risks
            riskAnalysis.sort((a, b) => b.riskScore - a.riskScore);
            const topRisks = riskAnalysis.filter(r => r.riskScore > 0).slice(0, 8);

            if (topRisks.length === 0) {
                panel.classList.add('hidden');
                return;
            }

            panel.classList.remove('hidden');

            // Calculate summary stats
            const highRiskCount = topRisks.filter(r => r.riskScore >= 50).length;
            const mediumRiskCount = topRisks.filter(r => r.riskScore >= 20 && r.riskScore < 50).length;

            content.innerHTML = `
                <div class="grid md:grid-cols-3 gap-4 mb-6">
                    <div class="p-4" style="background: rgba(239, 68, 68, 0.1); border-radius: 8px; text-align: center;">
                        <div class="text-3xl font-bold" style="color: var(--danger);">${highRiskCount}</div>
                        <div class="text-sm" style="color: var(--text-secondary);">High Risk Tasks</div>
                    </div>
                    <div class="p-4" style="background: rgba(245, 158, 11, 0.1); border-radius: 8px; text-align: center;">
                        <div class="text-3xl font-bold" style="color: var(--warning);">${mediumRiskCount}</div>
                        <div class="text-sm" style="color: var(--text-secondary);">Medium Risk Tasks</div>
                    </div>
                    <div class="p-4" style="background: rgba(99, 102, 241, 0.1); border-radius: 8px; text-align: center;">
                        <div class="text-3xl font-bold" style="color: var(--accent);">${incompleteTasks.length}</div>
                        <div class="text-sm" style="color: var(--text-secondary);">Total Incomplete</div>
                    </div>
                </div>

                <h3 class="font-bold mb-3" style="color: var(--text-primary);">üî• Top Risk Areas</h3>
                <p class="text-xs mb-4" style="color: var(--text-muted);">
                    Showing impact of a simulated 3-day delay for each task
                </p>

                <div class="space-y-3">
                    ${topRisks.map((item, index) => {
                        const riskLevel = item.riskScore >= 50 ? 'high' : item.riskScore >= 20 ? 'medium' : 'low';
                        const riskColor = riskLevel === 'high' ? 'var(--danger)' : riskLevel === 'medium' ? 'var(--warning)' : 'var(--success)';
                        const riskIcon = riskLevel === 'high' ? 'üî¥' : riskLevel === 'medium' ? 'üü†' : 'üü¢';
                        const bgStyle = riskLevel === 'high' ? 'background: rgba(239, 68, 68, 0.08);' :
                                       riskLevel === 'medium' ? 'background: rgba(245, 158, 11, 0.08);' : '';

                        // Risk bar width (max 100px)
                        const maxScore = topRisks[0]?.riskScore || 100;
                        const barWidth = Math.round((item.riskScore / maxScore) * 100);

                        return `
                            <div class="p-4 risk-radar-item" data-task-id="${escapeHtml(item.task.id)}" style="border-radius: 8px; border-left: 4px solid ${riskColor}; ${bgStyle} background-color: var(--bg-secondary); cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='translateX(4px)'" onmouseout="this.style.transform='none'">
                                <div style="display: flex; justify-content: space-between; align-items: start; gap: 12px; flex-wrap: wrap;">
                                    <div style="flex: 1; min-width: 200px;">
                                        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                            <span style="font-size: 16px;">${riskIcon}</span>
                                            <span class="mono font-bold">${escapeHtml(item.task.id)}</span>
                                            <span class="px-2 py-0.5 rounded text-xs font-medium status-${item.task.status}">${item.task.status.toUpperCase()}</span>
                                            <span class="text-xs" style="color: var(--text-muted);">‚Üê click for details</span>
                                        </div>
                                        <p class="text-sm mt-1" style="color: var(--text-primary);">${escapeHtml(truncate(item.task.description, 50))}</p>
                                        ${item.task.owner ? `<p class="text-xs mt-1" style="color: var(--text-muted);">ÔøΩÔøΩÔøΩÔøΩ ${escapeHtml(item.task.owner)}</p>` : ''}
                                    </div>
                                    <div style="flex-shrink: 0; min-width: 180px;">
                                        <!-- Risk Score Bar -->
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                            <span class="text-xs" style="color: var(--text-muted); width: 70px;">Risk Score:</span>
                                            <div style="flex: 1; height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                                                <div style="width: ${barWidth}%; height: 100%; background: ${riskColor};"></div>
                                            </div>
                                            <span class="text-xs mono font-bold" style="color: ${riskColor};">${item.riskScore}</span>
                                        </div>
                                        <!-- Stats -->
                                        <div class="text-xs space-y-1">
                                            <div style="display: flex; justify-content: space-between;">
                                                <span style="color: var(--text-muted);">Downstream tasks:</span>
                                                <span class="mono font-medium">${item.downstreamCount}</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between;">
                                                <span style="color: var(--text-muted);">Days to deadline:</span>
                                                <span class="mono font-medium" style="color: ${item.daysToDeadline !== null && item.daysToDeadline <= 7 ? 'var(--danger)' : 'inherit'};">
                                                    ${item.daysToDeadline !== null ? item.daysToDeadline + 'd' : 'No date'}
                                                </span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <span style="color: var(--text-muted);">3-day delay impact:</span>
                                                <button class="impact-details-btn" data-task-id="${escapeHtml(item.task.id)}" style="background: none; border: none; cursor: pointer; padding: 2px 6px; border-radius: 4px; color: ${item.impact.criticalCount > 0 ? 'var(--danger)' : 'var(--text-secondary)'}; text-decoration: underline; font-size: inherit;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='none'">
                                                    ${item.impact.criticalCount > 0 ? `<strong>${item.impact.criticalCount} critical</strong>` : '0 critical'}${item.impact.atRiskCount > 0 ? `, ${item.impact.atRiskCount} at-risk` : ''} ‚Üí
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>

                <div class="mt-4 p-3" style="background: var(--bg-tertiary); border-radius: 6px;">
                    <p class="text-xs" style="color: var(--text-muted);">
                        <strong>How to read:</strong> Risk score combines: downstream impact (tasks that would be affected),
                        time buffer (days until deadline), and current status. Higher score = task delay would cause more damage.
                        Use the What-If Simulator in Gantt View to explore specific delay scenarios.
                    </p>
                </div>
            `;

            // Add click handlers to risk radar items
            content.querySelectorAll('.risk-radar-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    // Don't trigger if clicking on the impact details button
                    if (e.target.closest('.impact-details-btn')) return;

                    const taskId = item.getAttribute('data-task-id');
                    const task = projectData.find(t => t.id === taskId);
                    if (task) {
                        showTaskPopup(task);
                    }
                });
            });

            // Add click handlers to impact details buttons
            content.querySelectorAll('.impact-details-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const taskId = btn.getAttribute('data-task-id');
                    showImpactDetailsPopup(taskId, 3); // 3-day delay
                });
            });
        }

        function showImpactDetailsPopup(taskId, delayDays) {
            const taskMap = new Map(projectData.map(t => [t.id, t]));
            const sourceTask = taskMap.get(taskId);
            if (!sourceTask) return;

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Build reverse dependency map
            const reverseDeps = new Map();
            projectData.forEach(task => {
                task.dependencies.forEach(depId => {
                    if (!reverseDeps.has(depId)) {
                        reverseDeps.set(depId, []);
                    }
                    reverseDeps.get(depId).push(task.id);
                });
            });

            // Find all affected tasks with their impact details
            const affectedTasks = [];
            const visited = new Set([taskId]);

            function findAffectedTasks(currentId, delay) {
                const dependents = reverseDeps.get(currentId) || [];
                dependents.forEach(depId => {
                    if (visited.has(depId)) return;
                    visited.add(depId);

                    const depTask = taskMap.get(depId);
                    if (!depTask) return;

                    let severity = 'ok';
                    let originalWindow = 0;
                    let newWindow = 0;
                    let compressionPct = 0;

                    if (depTask.anticipatedEnd) {
                        originalWindow = Math.ceil((depTask.anticipatedEnd - today) / (1000 * 60 * 60 * 24));
                        newWindow = originalWindow - delay;
                        compressionPct = originalWindow > 0 ? Math.round((delay / originalWindow) * 100) : 100;

                        if (originalWindow <= 0 || newWindow <= 0 || compressionPct >= 50) {
                            severity = 'critical';
                        } else if (compressionPct >= 25 || newWindow <= 5) {
                            severity = 'at-risk';
                        }
                    }

                    affectedTasks.push({
                        task: depTask,
                        severity,
                        originalWindow,
                        newWindow,
                        compressionPct
                    });

                    findAffectedTasks(depId, delay);
                });
            }

            findAffectedTasks(taskId, delayDays);

            // Sort by severity
            const severityOrder = { 'critical': 0, 'at-risk': 1, 'ok': 2 };
            affectedTasks.sort((a, b) => severityOrder[a.severity] - severityOrder[b.severity]);

            // Remove any existing popup
            const existingPopup = document.getElementById('impact-popup');
            if (existingPopup) existingPopup.remove();
            const existingOverlay = document.getElementById('impact-popup-overlay');
            if (existingOverlay) existingOverlay.remove();

            const popup = document.createElement('div');
            popup.id = 'impact-popup';
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--bg-secondary);
                border: 1px solid var(--border);
                border-radius: 12px;
                padding: 20px;
                z-index: 1000;
                max-width: 550px;
                width: 95%;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            `;

            const criticalTasks = affectedTasks.filter(t => t.severity === 'critical');
            const atRiskTasks = affectedTasks.filter(t => t.severity === 'at-risk');
            const okTasks = affectedTasks.filter(t => t.severity === 'ok');

            popup.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                    <div>
                        <h3 class="font-bold text-lg" style="color: var(--text-primary);">üìä ${delayDays}-Day Delay Impact Analysis</h3>
                        <p class="text-sm mt-1" style="color: var(--text-muted);">
                            If <span class="mono font-medium" style="color: var(--accent);">${escapeHtml(taskId)}</span> is delayed by ${delayDays} days:
                        </p>
                    </div>
                    <button class="close-impact-popup" style="background: none; border: none; cursor: pointer; font-size: 20px; color: var(--text-muted); padding: 0 4px;">&times;</button>
                </div>

                <!-- Summary -->
                <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 80px; padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; text-align: center;">
                        <div class="text-2xl font-bold" style="color: var(--danger);">${criticalTasks.length}</div>
                        <div class="text-xs" style="color: var(--text-muted);">Critical</div>
                    </div>
                    <div style="flex: 1; min-width: 80px; padding: 12px; background: rgba(245, 158, 11, 0.1); border-radius: 8px; text-align: center;">
                        <div class="text-2xl font-bold" style="color: var(--warning);">${atRiskTasks.length}</div>
                        <div class="text-xs" style="color: var(--text-muted);">At Risk</div>
                    </div>
                    <div style="flex: 1; min-width: 80px; padding: 12px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; text-align: center;">
                        <div class="text-2xl font-bold" style="color: var(--success);">${okTasks.length}</div>
                        <div class="text-xs" style="color: var(--text-muted);">OK</div>
                    </div>
                </div>

                <!-- Critical Tasks -->
                ${criticalTasks.length > 0 ? `
                    <div class="mb-4">
                        <h4 class="font-bold text-sm mb-2" style="color: var(--danger);">üî¥ Critical - Would miss deadline or lose 50%+ time</h4>
                        <div class="space-y-2">
                            ${criticalTasks.map(item => `
                                <div class="p-2 impact-task-item" data-task-id="${escapeHtml(item.task.id)}" style="background: rgba(239, 68, 68, 0.08); border-radius: 6px; border-left: 3px solid var(--danger); cursor: pointer;" onmouseover="this.style.transform='translateX(2px)'" onmouseout="this.style.transform='none'">
                                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px;">
                                        <div>
                                            <span class="mono font-medium">${escapeHtml(item.task.id)}</span>
                                            <span class="text-xs" style="color: var(--text-muted);"> - ${escapeHtml(truncate(item.task.description, 35))}</span>
                                        </div>
                                        <span class="text-xs mono" style="color: var(--danger);">
                                            ${item.newWindow <= 0 ? 'No time left!' : `${item.originalWindow}d ‚Üí ${item.newWindow}d (‚àí${item.compressionPct}%)`}
                                        </span>
                                    </div>
                                    ${item.task.owner ? `<div class="text-xs mt-1" style="color: var(--text-muted);">üë§ ${escapeHtml(item.task.owner)}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}

                <!-- At Risk Tasks -->
                ${atRiskTasks.length > 0 ? `
                    <div class="mb-4">
                        <h4 class="font-bold text-sm mb-2" style="color: var(--warning);">üü† At Risk - Tight buffer remaining</h4>
                        <div class="space-y-2">
                            ${atRiskTasks.map(item => `
                                <div class="p-2 impact-task-item" data-task-id="${escapeHtml(item.task.id)}" style="background: rgba(245, 158, 11, 0.08); border-radius: 6px; border-left: 3px solid var(--warning); cursor: pointer;" onmouseover="this.style.transform='translateX(2px)'" onmouseout="this.style.transform='none'">
                                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px;">
                                        <div>
                                            <span class="mono font-medium">${escapeHtml(item.task.id)}</span>
                                            <span class="text-xs" style="color: var(--text-muted);"> - ${escapeHtml(truncate(item.task.description, 35))}</span>
                                        </div>
                                        <span class="text-xs mono" style="color: var(--warning);">
                                            ${item.originalWindow}d ‚Üí ${item.newWindow}d (‚àí${item.compressionPct}%)
                                        </span>
                                    </div>
                                    ${item.task.owner ? `<div class="text-xs mt-1" style="color: var(--text-muted);">üë§ ${escapeHtml(item.task.owner)}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}

                <!-- OK Tasks (collapsed by default if many) -->
                ${okTasks.length > 0 ? `
                    <div>
                        <h4 class="font-bold text-sm mb-2" style="color: var(--success);">üü¢ OK - Sufficient buffer (${okTasks.length} tasks)</h4>
                        ${okTasks.length <= 5 ? `
                            <div class="space-y-1">
                                ${okTasks.map(item => `
                                    <div class="p-2 impact-task-item" data-task-id="${escapeHtml(item.task.id)}" style="background: var(--bg-tertiary); border-radius: 4px; cursor: pointer; font-size: 12px;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='var(--bg-tertiary)'">
                                        <span class="mono">${escapeHtml(item.task.id)}</span>
                                        <span style="color: var(--text-muted);"> - ${escapeHtml(truncate(item.task.description, 40))}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <p class="text-xs" style="color: var(--text-muted);">These tasks have sufficient time buffer and won't be critically affected.</p>
                        `}
                    </div>
                ` : ''}

                ${affectedTasks.length === 0 ? `
                    <div class="p-4 text-center" style="background: rgba(16, 185, 129, 0.1); border-radius: 8px;">
                        <p style="color: var(--success);">‚úÖ No downstream tasks would be affected by this delay.</p>
                    </div>
                ` : ''}
            `;

            // Create overlay
            const overlay = document.createElement('div');
            overlay.id = 'impact-popup-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
            `;

            document.body.appendChild(overlay);
            document.body.appendChild(popup);

            // Close handlers
            const closePopup = () => {
                popup.remove();
                overlay.remove();
            };

            popup.querySelector('.close-impact-popup').addEventListener('click', closePopup);
            overlay.addEventListener('click', closePopup);

            // Add click handlers to task items in the popup
            popup.querySelectorAll('.impact-task-item').forEach(item => {
                item.addEventListener('click', () => {
                    const tid = item.getAttribute('data-task-id');
                    const task = projectData.find(t => t.id === tid);
                    if (task) {
                        closePopup();
                        showTaskPopup(task);
                    }
                });
            });

            // Close on Escape key
            const escHandler = (e) => {
                if (e.key === 'Escape') {
                    closePopup();
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);
        }

        // Generalized task popup (used by both Gantt and Risk Radar)
        function showTaskPopup(task) {
            // Remove any existing popup
            const existingPopup = document.getElementById('task-popup');
            if (existingPopup) existingPopup.remove();
            const existingOverlay = document.getElementById('task-popup-overlay');
            if (existingOverlay) existingOverlay.remove();

            // Find task issues
            const taskIssues = issues.find(i => i.task.id === task.id);
            let issueHtml = '';
            if (taskIssues && taskIssues.issues.length > 0) {
                issueHtml = `
                    <div class="mt-3 p-3" style="background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 3px solid var(--danger);">
                        <p class="font-semibold text-sm" style="color: var(--danger);">‚ö†Ô∏è Issues:</p>
                        <ul class="mt-1 text-sm space-y-1" style="color: var(--danger);">
                            ${taskIssues.issues.map(i => `<li>‚Ä¢ ${escapeHtml(i.message)}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            // Date moved info
            let dateMovedHtml = '';
            if (task.dateWasMoved) {
                const isPushed = task.dateMovedDays > 0;
                dateMovedHtml = `
                    <div class="mt-2 p-2" style="background: ${isPushed ? 'rgba(239, 68, 68, 0.1)' : 'rgba(16, 185, 129, 0.1)'}; border-radius: 6px;">
                        <span style="color: ${isPushed ? 'var(--danger)' : 'var(--success)'};">
                            ${isPushed ? '‚è©' : '‚è™'} Date moved ${isPushed ? '+' : ''}${task.dateMovedDays} days
                        </span>
                        <div class="text-xs mt-1" style="color: var(--text-muted);">
                            Original: <span style="text-decoration: line-through;">${formatDate(task.originalAnticipatedEnd)}</span>
                        </div>
                    </div>
                `;
            }

            const popup = document.createElement('div');
            popup.id = 'task-popup';
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--bg-secondary);
                border: 1px solid var(--border);
                border-radius: 12px;
                padding: 20px;
                z-index: 1000;
                max-width: 450px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            `;

            popup.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                    <div>
                        <span class="mono font-bold text-lg" style="color: var(--accent);">${escapeHtml(task.id)}</span>
                        <span class="px-2 py-1 rounded text-xs font-medium ml-2 status-${task.status}">${task.status.toUpperCase()}</span>
                    </div>
                    <button class="close-task-popup" style="background: none; border: none; cursor: pointer; font-size: 20px; color: var(--text-muted); padding: 0 4px;">&times;</button>
                </div>
                <h3 class="font-semibold mb-3" style="color: var(--text-primary);">${escapeHtml(task.description)}</h3>

                <div class="space-y-2 text-sm">
                    ${task.owner ? `
                        <div style="display: flex; gap: 8px;">
                            <span style="color: var(--text-muted); min-width: 100px;">üë§ Owner:</span>
                            <span style="color: var(--text-primary); font-weight: 500;">${escapeHtml(task.owner)}</span>
                        </div>
                    ` : ''}
                    ${task.performedBy ? `
                        <div style="display: flex; gap: 8px;">
                            <span style="color: var(--text-muted); min-width: 100px;">üîß Performed by:</span>
                            <span style="color: var(--text-primary);">${escapeHtml(task.performedBy)}</span>
                        </div>
                    ` : ''}
                    ${task.startDate ? `
                        <div style="display: flex; gap: 8px;">
                            <span style="color: var(--text-muted); min-width: 100px;">üìÖ Start:</span>
                            <span class="mono" style="color: var(--text-primary);">${formatDate(task.startDate)}</span>
                        </div>
                    ` : ''}
                    ${task.anticipatedEnd ? `
                        <div style="display: flex; gap: 8px;">
                            <span style="color: var(--text-muted); min-width: 100px;">üéØ Due:</span>
                            <span class="mono" style="color: var(--text-primary);">${formatDate(task.anticipatedEnd)}</span>
                        </div>
                    ` : ''}
                    ${task.actualEnd ? `
                        <div style="display: flex; gap: 8px;">
                            <span style="color: var(--text-muted); min-width: 100px;">‚úÖ Completed:</span>
                            <span class="mono" style="color: var(--success);">${formatDate(task.actualEnd)}</span>
                        </div>
                    ` : ''}
                    ${task.dependencies.length > 0 ? `
                        <div style="display: flex; gap: 8px;">
                            <span style="color: var(--text-muted); min-width: 100px;">üîó Depends on:</span>
                            <span class="mono" style="color: var(--text-primary);">${escapeHtml(task.dependencies.join(', '))}</span>
                        </div>
                    ` : ''}
                    ${task.comments ? `
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border);">
                            <span style="color: var(--text-muted);">üí¨ Comments:</span>
                            <p style="color: var(--text-secondary); margin-top: 4px;">${escapeHtml(task.comments)}</p>
                        </div>
                    ` : ''}
                </div>
                ${dateMovedHtml}
                ${issueHtml}
            `;

            // Create overlay
            const overlay = document.createElement('div');
            overlay.id = 'task-popup-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
            `;

            document.body.appendChild(overlay);
            document.body.appendChild(popup);

            // Close handlers
            const closePopup = () => {
                popup.remove();
                overlay.remove();
            };

            popup.querySelector('.close-task-popup').addEventListener('click', closePopup);
            overlay.addEventListener('click', closePopup);

            // Close on Escape key
            const escHandler = (e) => {
                if (e.key === 'Escape') {
                    closePopup();
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);
        }

        function runDelaySimulation() {
            const taskId = document.getElementById('simulator-task').value;
            const delayDays = parseInt(document.getElementById('simulator-days').value) || 0;

            if (!taskId) {
                showCustomAlert('Please select a task to simulate delay');
                return;
            }

            if (delayDays < 1) {
                showCustomAlert('Please enter a valid number of delay days');
                return;
            }

            const taskMap = new Map(projectData.map(t => [t.id, t]));
            const sourceTask = taskMap.get(taskId);

            if (!sourceTask) {
                showCustomAlert('Task not found');
                return;
            }

            // Find all tasks that depend on this task (directly or indirectly)
            const affectedTasks = [];
            const visited = new Set();

            // Build reverse dependency map (task -> tasks that depend on it)
            const reverseDeps = new Map();
            projectData.forEach(task => {
                task.dependencies.forEach(depId => {
                    if (!reverseDeps.has(depId)) {
                        reverseDeps.set(depId, []);
                    }
                    reverseDeps.get(depId).push(task.id);
                });
            });

            // BFS to find all affected tasks
            function findAffectedTasks(startTaskId, inheritedDelay) {
                const queue = [{ taskId: startTaskId, delay: inheritedDelay, depth: 0 }];

                while (queue.length > 0) {
                    const { taskId: currentId, delay, depth } = queue.shift();

                    const dependents = reverseDeps.get(currentId) || [];
                    dependents.forEach(depTaskId => {
                        if (visited.has(depTaskId)) return;
                        visited.add(depTaskId);

                        const depTask = taskMap.get(depTaskId);
                        if (!depTask) return;

                        // Calculate new projected end date
                        const originalEnd = depTask.anticipatedEnd;
                        let projectedEnd = null;
                        let taskDelay = delay;

                        if (originalEnd) {
                            projectedEnd = new Date(originalEnd);
                            projectedEnd.setDate(projectedEnd.getDate() + delay);
                        }

                        // Calculate window compression - how much working time is lost
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        let severity = 'ok';
                        let severityText = 'OK';
                        let originalWindow = 0;
                        let newWindow = 0;
                        let compressionPct = 0;

                        if (originalEnd) {
                            // Original window = days from today to deadline
                            originalWindow = Math.ceil((originalEnd - today) / (1000 * 60 * 60 * 24));
                            // New window = original window minus the delay absorbed
                            newWindow = originalWindow - delay;
                            // Compression percentage
                            compressionPct = originalWindow > 0 ? Math.round((delay / originalWindow) * 100) : 100;

                            if (originalWindow <= 0) {
                                // Task is already overdue
                                severity = 'critical';
                                severityText = `Already overdue! +${delay}d makes it worse`;
                            } else if (newWindow <= 0) {
                                // Would completely miss deadline
                                severity = 'critical';
                                severityText = `No time left! (was ${originalWindow}d)`;
                            } else if (compressionPct >= 50) {
                                // Losing 50%+ of available time is critical
                                severity = 'critical';
                                severityText = `${originalWindow}d ‚Üí ${newWindow}d (‚àí${compressionPct}%)`;
                            } else if (compressionPct >= 25 || newWindow <= 5) {
                                // Losing 25-50% or very tight window
                                severity = 'at-risk';
                                severityText = `${originalWindow}d ‚Üí ${newWindow}d (‚àí${compressionPct}%)`;
                            } else {
                                severity = 'ok';
                                severityText = `${originalWindow}d ‚Üí ${newWindow}d (‚àí${compressionPct}%)`;
                            }
                        }

                        affectedTasks.push({
                            task: depTask,
                            delay: taskDelay,
                            depth: depth + 1,
                            originalEnd: originalEnd,
                            projectedEnd: projectedEnd,
                            severity: severity,
                            severityText: severityText,
                            originalWindow: originalWindow,
                            newWindow: newWindow,
                            compressionPct: compressionPct
                        });

                        // Continue propagation
                        queue.push({ taskId: depTaskId, delay: taskDelay, depth: depth + 1 });
                    });
                }
            }

            visited.add(taskId);
            findAffectedTasks(taskId, delayDays);

            // Sort by severity then depth
            const severityOrder = { 'critical': 0, 'at-risk': 1, 'ok': 2 };
            affectedTasks.sort((a, b) => {
                if (severityOrder[a.severity] !== severityOrder[b.severity]) {
                    return severityOrder[a.severity] - severityOrder[b.severity];
                }
                return a.depth - b.depth;
            });

            // Calculate summary stats
            const criticalCount = affectedTasks.filter(t => t.severity === 'critical').length;
            const atRiskCount = affectedTasks.filter(t => t.severity === 'at-risk').length;
            const okCount = affectedTasks.filter(t => t.severity === 'ok').length;

            // Render results
            const resultsContainer = document.getElementById('simulator-results');
            resultsContainer.classList.remove('hidden');

            if (affectedTasks.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="p-4" style="background: rgba(16, 185, 129, 0.1); border-radius: 8px; border: 1px solid var(--success);">
                        <p class="font-bold" style="color: var(--success);">‚úÖ No Impact</p>
                        <p class="text-sm mt-1" style="color: var(--text-secondary);">
                            No other tasks depend on <strong>${escapeHtml(taskId)}</strong>.
                            Delaying this task by ${delayDays} days would not affect other tasks.
                        </p>
                    </div>
                `;
                return;
            }

            // Build severity summary
            let summaryClass = 'var(--success)';
            let summaryIcon = '‚úÖ';
            let summaryText = 'Low Impact';

            if (criticalCount > 0) {
                summaryClass = 'var(--danger)';
                summaryIcon = 'üö®';
                summaryText = 'Critical Impact';
            } else if (atRiskCount > 0) {
                summaryClass = 'var(--warning)';
                summaryIcon = '‚ö†Ô∏è';
                summaryText = 'Moderate Impact';
            }

            // Calculate new source task end date
            const sourceNewEnd = new Date(sourceTask.anticipatedEnd);
            sourceNewEnd.setDate(sourceNewEnd.getDate() + delayDays);

            resultsContainer.innerHTML = `
                <div class="p-4 mb-4" style="background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid ${summaryClass};">
                    <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 12px;">
                        <div>
                            <h4 class="font-bold text-lg" style="color: ${summaryClass};">${summaryIcon} ${summaryText}</h4>
                            <p class="text-sm mt-1" style="color: var(--text-secondary);">
                                Simulating: <strong class="mono">${escapeHtml(taskId)}</strong> delayed by <strong>+${delayDays} days</strong>
                            </p>
                            <p class="text-xs mt-1 mono" style="color: var(--text-muted);">
                                ${formatDate(sourceTask.anticipatedEnd)} ‚Üí ${formatDate(sourceNewEnd)}
                            </p>
                        </div>
                        <div style="display: flex; gap: 16px; text-align: center;">
                            <div>
                                <div class="text-2xl font-bold" style="color: var(--danger);">${criticalCount}</div>
                                <div class="text-xs" style="color: var(--text-muted);">Critical</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold" style="color: var(--warning);">${atRiskCount}</div>
                                <div class="text-xs" style="color: var(--text-muted);">At Risk</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold" style="color: var(--success);">${okCount}</div>
                                <div class="text-xs" style="color: var(--text-muted);">OK</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-2" style="max-height: 400px; overflow-y: auto;">
                    <p class="text-sm font-medium mb-2" style="color: var(--text-secondary);">üìã Affected Tasks (${affectedTasks.length}) - Time Window Impact</p>
                    ${affectedTasks.map(item => {
                        const severityColor = item.severity === 'critical' ? 'var(--danger)' :
                                              item.severity === 'at-risk' ? 'var(--warning)' : 'var(--success)';
                        const severityIcon = item.severity === 'critical' ? 'üî¥' :
                                             item.severity === 'at-risk' ? 'üü†' : 'üü¢';
                        const bgStyle = item.severity === 'critical' ? 'background: rgba(239, 68, 68, 0.08);' :
                                        item.severity === 'at-risk' ? 'background: rgba(245, 158, 11, 0.08);' : '';

                        // Calculate bar widths for visual representation
                        const maxBarWidth = 120;
                        const originalBarWidth = Math.min(maxBarWidth, Math.max(20, item.originalWindow * 4));
                        const newBarWidth = item.newWindow > 0 ? Math.min(maxBarWidth, Math.max(10, item.newWindow * 4)) : 0;
                        const lostWidth = originalBarWidth - newBarWidth;

                        return `
                            <div class="p-3" style="border-radius: 6px; border-left: 3px solid ${severityColor}; ${bgStyle} background-color: var(--bg-secondary);">
                                <div style="display: flex; justify-content: space-between; align-items: start; gap: 12px; flex-wrap: wrap;">
                                    <div style="flex: 1; min-width: 180px;">
                                        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                            <span class="mono font-medium">${escapeHtml(item.task.id)}</span>
                                            <span class="px-2 py-0.5 rounded text-xs font-medium status-${item.task.status}">${item.task.status.toUpperCase()}</span>
                                        </div>
                                        <p class="text-sm mt-1" style="color: var(--text-secondary);">${escapeHtml(truncate(item.task.description, 45))}</p>
                                        ${item.task.owner ? `<p class="text-xs mt-1" style="color: var(--text-muted);">üë§ ${escapeHtml(item.task.owner)}</p>` : ''}
                                    </div>
                                    <div style="flex-shrink: 0; min-width: 200px;">
                                        <!-- Time window visualization -->
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                            <span class="text-xs" style="color: var(--text-muted); width: 45px;">Before:</span>
                                            <div style="width: ${originalBarWidth}px; height: 12px; background: var(--text-muted); border-radius: 2px; opacity: 0.4;"></div>
                                            <span class="text-xs mono" style="color: var(--text-muted);">${item.originalWindow}d</span>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <span class="text-xs" style="color: var(--text-muted); width: 45px;">After:</span>
                                            <div style="display: flex; height: 12px;">
                                                ${item.newWindow > 0 ? `<div style="width: ${newBarWidth}px; height: 12px; background: ${severityColor}; border-radius: 2px 0 0 2px;"></div>` : ''}
                                                <div style="width: ${lostWidth}px; height: 12px; background: repeating-linear-gradient(45deg, ${severityColor}, ${severityColor} 2px, transparent 2px, transparent 4px); opacity: 0.5; border-radius: ${item.newWindow <= 0 ? '2px' : '0 2px 2px 0'};"></div>
                                            </div>
                                            <span class="text-xs mono font-bold" style="color: ${severityColor};">${item.newWindow > 0 ? item.newWindow + 'd' : '0d!'}</span>
                                        </div>
                                        <!-- Compression indicator -->
                                        <div style="display: flex; align-items: center; gap: 6px; margin-top: 6px;">
                                            <span>${severityIcon}</span>
                                            <span class="text-xs font-medium" style="color: ${severityColor};">
                                                ${item.compressionPct > 0 ? `‚àí${item.compressionPct}% time` : 'No change'}
                                                ${item.newWindow <= 0 ? ' ¬∑ Would miss deadline!' : ''}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderTable() {
            const container = document.getElementById('table-container');

            const rows = projectData.map(task => `
                <tr class="${task.hasIssue ? 'issue-card' : ''}" style="border-bottom: 1px solid var(--border);">
                    <td class="mono px-4 py-3 whitespace-nowrap font-medium">${task.hasIssue ? '‚ö†Ô∏è ' : ''}${escapeHtml(task.id)}</td>
                    <td class="px-4 py-3" style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(truncate(task.description, 80))}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded text-xs font-medium status-${task.status}">${task.status.toUpperCase()}</span>
                    </td>
                    <td class="px-4 py-3 text-sm">${escapeHtml(task.owner) || '-'}</td>
                    <td class="mono px-4 py-3 text-sm">${task.dependencies.length ? escapeHtml(task.dependencies.join(', ')) : '-'}</td>
                    <td class="mono px-4 py-3 text-sm">${task.startDate ? formatDate(task.startDate) : '-'}</td>
                    <td class="mono px-4 py-3 text-sm">${task.anticipatedEnd ? formatDate(task.anticipatedEnd) : '-'}</td>
                </tr>
            `).join('');

            container.innerHTML = `
                <table class="w-full text-sm" style="min-width: 900px;">
                    <thead>
                        <tr style="background: var(--bg-tertiary); border-bottom: 2px solid var(--border);">
                            <th class="px-4 py-3 text-left font-semibold">Task #</th>
                            <th class="px-4 py-3 text-left font-semibold">Description</th>
                            <th class="px-4 py-3 text-left font-semibold">Status</th>
                            <th class="px-4 py-3 text-left font-semibold">Owner</th>
                            <th class="px-4 py-3 text-left font-semibold">Dependencies</th>
                            <th class="px-4 py-3 text-left font-semibold">Start</th>
                            <th class="px-4 py-3 text-left font-semibold">Due</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
        }

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                const tab = btn.dataset.tab;
                document.querySelectorAll('[id^="tab-"]').forEach(t => t.classList.add('hidden'));
                document.getElementById('tab-' + tab).classList.remove('hidden');

                // Re-render graph on tab switch to fix sizing
                if (tab === 'graph') {
                    setTimeout(renderGraph, 100);
                }
            });
        });

        // Utilities
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function formatDate(date) {
            if (!date) return '';
            return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        }

        function truncate(str, len) {
            if (!str) return '';
            return str.length > len ? str.substring(0, len) + '...' : str;
        }

        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function resetApp() {
            workbook = null;
            projectData = [];
            issues = [];
            fileInfo.classList.add('hidden');
            sheetSection.classList.add('hidden');
            resultsSection.classList.add('hidden');
            fileInput.value = '';
        }

        function showCustomAlert(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 flex items-center justify-center z-50';
            modal.style.background = 'rgba(0,0,0,0.5)';
            modal.innerHTML = `
                <div class="card p-6 mx-4 max-w-sm w-full">
                    <p style="color: var(--text-primary);" class="mb-4">${escapeHtml(message)}</p>
                    <button class="w-full px-4 py-2 rounded-lg font-medium" style="background: var(--accent); color: white;" onclick="this.closest('.fixed').remove()">OK</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // === Inline Summary Panel Functions ===

        let summaryExpanded = false;

        function populateSummaryPanel() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const weekFromNow = new Date(today);
            weekFromNow.setDate(weekFromNow.getDate() + 7);

            // Set date
            document.getElementById('summary-date').textContent =
                `‚Ä¢ ${today.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })}`;

            // Calculate data
            const totalTasks = projectData.length;
            const completedTasks = projectData.filter(t => t.status === 'done').length;
            const completionPct = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

            const overdueTasks = projectData.filter(t => {
                if (t.status === 'done' || t.status === 'postmvp') return false;
                if (!t.anticipatedEnd) return false;
                return t.anticipatedEnd < today;
            }).sort((a, b) => a.anticipatedEnd - b.anticipatedEnd);

            const tasksDueThisWeek = projectData.filter(t => {
                if (t.status === 'done' || t.status === 'postmvp') return false;
                if (!t.anticipatedEnd) return false;
                return t.anticipatedEnd >= today && t.anticipatedEnd <= weekFromNow;
            }).sort((a, b) => a.anticipatedEnd - b.anticipatedEnd);

            const blockedTasks = projectData.filter(t => t.status === 'blocked');
            const slippedTasks = projectData.filter(t => t.dateWasMoved && t.dateMovedDays > 0)
                .sort((a, b) => b.dateMovedDays - a.dateMovedDays);

            const topRisks = getTopRiskTasks(3);

            // Build main summary content
            const summaryContent = document.getElementById('summary-content');
            let mainHtml = '';

            // Progress bar
            mainHtml += `
                <div class="md:col-span-2 mb-2">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium" style="color: var(--text-secondary);">Overall Progress</span>
                        <span class="text-sm font-bold" style="color: var(--accent);">${completionPct}%</span>
                    </div>
                    <div style="height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                        <div style="height: 100%; width: ${completionPct}%; background: linear-gradient(90deg, var(--accent), var(--success)); border-radius: 4px; transition: width 0.5s;"></div>
                    </div>
                </div>
            `;

            // Critical Alerts (if any)
            if (overdueTasks.length > 0 || blockedTasks.length > 0) {
                mainHtml += `
                    <div class="p-3 rounded-lg" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3);">
                        <h4 class="font-bold text-sm mb-2" style="color: var(--danger);">üö® Critical Alerts</h4>
                        <ul class="space-y-1 text-sm" style="color: var(--text-secondary);">
                            ${overdueTasks.length > 0 ? `<li class="flex items-center gap-2 cursor-pointer summary-task-link" data-task-id="${overdueTasks[0].id}">
                                <span style="color: var(--danger);">‚è∞</span>
                                <span><strong>${overdueTasks.length}</strong> overdue task${overdueTasks.length > 1 ? 's' : ''}</span>
                            </li>` : ''}
                            ${blockedTasks.length > 0 ? `<li class="flex items-center gap-2 cursor-pointer summary-task-link" data-task-id="${blockedTasks[0].id}">
                                <span style="color: var(--danger);">üõë</span>
                                <span><strong>${blockedTasks.length}</strong> blocked task${blockedTasks.length > 1 ? 's' : ''}</span>
                            </li>` : ''}
                        </ul>
                    </div>
                `;
            }

            // This Week's Focus
            if (tasksDueThisWeek.length > 0) {
                mainHtml += `
                    <div class="p-3 rounded-lg" style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3);">
                        <h4 class="font-bold text-sm mb-2" style="color: var(--info);">üìÖ Due This Week (${tasksDueThisWeek.length})</h4>
                        <ul class="space-y-1 text-sm">
                            ${tasksDueThisWeek.slice(0, 3).map(t => `
                                <li class="flex items-center gap-2 cursor-pointer summary-task-link" data-task-id="${escapeHtml(t.id)}" style="color: var(--text-secondary);">
                                    <span class="mono text-xs" style="color: var(--info);">${escapeHtml(t.id)}</span>
                                    <span class="truncate">${escapeHtml(truncate(t.description, 30))}</span>
                                </li>
                            `).join('')}
                            ${tasksDueThisWeek.length > 3 ? `<li class="text-xs" style="color: var(--text-muted);">+${tasksDueThisWeek.length - 3} more...</li>` : ''}
                        </ul>
                    </div>
                `;
            }

            // Top Risks (if no critical alerts, show in main view)
            if (overdueTasks.length === 0 && blockedTasks.length === 0 && topRisks.length > 0) {
                mainHtml += `
                    <div class="p-3 rounded-lg" style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3);">
                        <h4 class="font-bold text-sm mb-2" style="color: var(--warning);">üéØ Top Risks</h4>
                        <ul class="space-y-1 text-sm">
                            ${topRisks.slice(0, 3).map(r => `
                                <li class="flex items-center gap-2 cursor-pointer summary-task-link" data-task-id="${escapeHtml(r.task.id)}" style="color: var(--text-secondary);">
                                    <span class="mono text-xs" style="color: var(--warning);">${escapeHtml(r.task.id)}</span>
                                    <span class="truncate">${escapeHtml(truncate(r.task.description, 28))}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            }

            // If everything looks good
            if (overdueTasks.length === 0 && blockedTasks.length === 0 && tasksDueThisWeek.length === 0) {
                mainHtml += `
                    <div class="p-3 rounded-lg" style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3);">
                        <h4 class="font-bold text-sm mb-2" style="color: var(--success);">‚úÖ Looking Good!</h4>
                        <p class="text-sm" style="color: var(--text-secondary);">No overdue or blocked tasks. No items due this week.</p>
                    </div>
                `;
            }

            summaryContent.innerHTML = mainHtml;

            // Build expanded content
            const expandedContent = document.getElementById('summary-expanded-content');
            let expandedHtml = '';

            // Top Risks (always show in expanded if there are risks)
            if (topRisks.length > 0 && (overdueTasks.length > 0 || blockedTasks.length > 0)) {
                expandedHtml += `
                    <div class="p-3 rounded-lg" style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3);">
                        <h4 class="font-bold text-sm mb-2" style="color: var(--warning);">üéØ Top Risk Areas</h4>
                        <ul class="space-y-1 text-sm">
                            ${topRisks.map(r => `
                                <li class="flex items-center justify-between cursor-pointer summary-task-link" data-task-id="${escapeHtml(r.task.id)}" style="color: var(--text-secondary);">
                                    <span>
                                        <span class="mono text-xs" style="color: var(--warning);">${escapeHtml(r.task.id)}</span>
                                        ${escapeHtml(truncate(r.task.description, 25))}
                                    </span>
                                    <span class="text-xs mono" style="color: var(--warning);">Score: ${r.riskScore}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            }

            // Schedule Slippage
            if (slippedTasks.length > 0) {
                expandedHtml += `
                    <div class="p-3 rounded-lg" style="background: var(--bg-tertiary);">
                        <h4 class="font-bold text-sm mb-2" style="color: var(--text-primary);">‚è© Schedule Slippage (${slippedTasks.length})</h4>
                        <ul class="space-y-1 text-sm">
                            ${slippedTasks.slice(0, 4).map(t => `
                                <li class="flex items-center justify-between cursor-pointer summary-task-link" data-task-id="${escapeHtml(t.id)}" style="color: var(--text-secondary);">
                                    <span class="mono text-xs">${escapeHtml(t.id)}</span>
                                    <span style="color: var(--danger);">+${t.dateMovedDays}d</span>
                                </li>
                            `).join('')}
                            ${slippedTasks.length > 4 ? `<li class="text-xs" style="color: var(--text-muted);">+${slippedTasks.length - 4} more...</li>` : ''}
                        </ul>
                    </div>
                `;
            }

            // Overdue task details (if any)
            if (overdueTasks.length > 0) {
                expandedHtml += `
                    <div class="p-3 rounded-lg" style="background: rgba(239, 68, 68, 0.05);">
                        <h4 class="font-bold text-sm mb-2" style="color: var(--danger);">‚è∞ Overdue Details</h4>
                        <ul class="space-y-1 text-sm">
                            ${overdueTasks.slice(0, 5).map(t => {
                                const daysOverdue = Math.ceil((today - t.anticipatedEnd) / (1000 * 60 * 60 * 24));
                                return `
                                    <li class="flex items-center justify-between cursor-pointer summary-task-link" data-task-id="${escapeHtml(t.id)}" style="color: var(--text-secondary);">
                                        <span><span class="mono text-xs">${escapeHtml(t.id)}</span> ${escapeHtml(truncate(t.description, 20))}</span>
                                        <span class="text-xs" style="color: var(--danger);">${daysOverdue}d overdue</span>
                                    </li>
                                `;
                            }).join('')}
                            ${overdueTasks.length > 5 ? `<li class="text-xs" style="color: var(--text-muted);">+${overdueTasks.length - 5} more...</li>` : ''}
                        </ul>
                    </div>
                `;
            }

            // Blocked task details (if any)
            if (blockedTasks.length > 0) {
                expandedHtml += `
                    <div class="p-3 rounded-lg" style="background: rgba(239, 68, 68, 0.05);">
                        <h4 class="font-bold text-sm mb-2" style="color: var(--danger);">üõë Blocked Details</h4>
                        <ul class="space-y-1 text-sm">
                            ${blockedTasks.slice(0, 5).map(t => `
                                <li class="flex items-center gap-2 cursor-pointer summary-task-link" data-task-id="${escapeHtml(t.id)}" style="color: var(--text-secondary);">
                                    <span class="mono text-xs">${escapeHtml(t.id)}</span>
                                    <span class="truncate">${escapeHtml(truncate(t.description, 30))}</span>
                                </li>
                            `).join('')}
                            ${blockedTasks.length > 5 ? `<li class="text-xs" style="color: var(--text-muted);">+${blockedTasks.length - 5} more...</li>` : ''}
                        </ul>
                    </div>
                `;
            }

            expandedContent.innerHTML = expandedHtml;

            // Hide toggle if nothing to expand
            const toggleBtn = document.getElementById('summary-toggle-btn');
            if (expandedHtml.trim() === '') {
                toggleBtn.parentElement.classList.add('hidden');
            } else {
                toggleBtn.parentElement.classList.remove('hidden');
            }

            // Add click handlers for task links
            document.querySelectorAll('.summary-task-link').forEach(link => {
                link.addEventListener('click', () => {
                    const taskId = link.getAttribute('data-task-id');
                    const task = projectData.find(t => t.id === taskId);
                    if (task) showTaskPopup(task);
                });
            });
        }

        function toggleSummaryExpand() {
            summaryExpanded = !summaryExpanded;
            const expanded = document.getElementById('summary-expanded');
            const btn = document.getElementById('summary-toggle-btn');

            if (summaryExpanded) {
                expanded.classList.remove('hidden');
                btn.textContent = '‚ñ≤ Show less';
            } else {
                expanded.classList.add('hidden');
                btn.textContent = '‚ñº Show more details';
            }
        }

        async function copySummaryToClipboard() {
            const md = generateSummaryContent();
            try {
                await navigator.clipboard.writeText(md);
                // Show brief feedback
                const btn = event.target.closest('button');
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚úÖ Copied!';
                btn.style.color = 'var(--success)';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.color = '';
                }, 1500);
            } catch (err) {
                showCustomAlert('Could not copy to clipboard');
            }
        }

        function printSummary() {
            const md = generateSummaryContent();
            const htmlContent = convertMarkdownToHtml(md);
            const printWindow = window.open('', '_blank');

            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Project Summary</title>
                    <style>
                        body {
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                            max-width: 800px;
                            margin: 0 auto;
                            padding: 40px 20px;
                            line-height: 1.6;
                            color: #1a1a1a;
                        }
                        h1 { font-size: 24px; margin-bottom: 8px; }
                        h2 { font-size: 18px; margin-top: 24px; margin-bottom: 12px; border-bottom: 1px solid #ddd; padding-bottom: 4px; }
                        h3 { font-size: 15px; margin-top: 16px; margin-bottom: 8px; }
                        table { border-collapse: collapse; width: 100%; margin: 12px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px 12px; text-align: left; }
                        th { background: #f5f5f5; }
                        ul { margin: 8px 0; padding-left: 24px; }
                        li { margin: 4px 0; }
                        strong { font-weight: 600; }
                        em { font-style: italic; color: #666; }
                        hr { border: none; border-top: 1px solid #ddd; margin: 24px 0; }
                        @media print { body { padding: 20px; } }
                    </style>
                </head>
                <body>${htmlContent}</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => printWindow.print(), 250);
        }

        // === Summary Generation Functions (for Markdown export) ===

        function generateSummaryContent() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const weekFromNow = new Date(today);
            weekFromNow.setDate(weekFromNow.getDate() + 7);

            // Basic stats
            const totalTasks = projectData.length;
            const completedTasks = projectData.filter(t => t.status === 'done').length;
            const wipTasks = projectData.filter(t => t.status === 'wip').length;
            const blockedTasks = projectData.filter(t => t.status === 'blocked').length;
            const newTasks = projectData.filter(t => t.status === 'new').length;
            const issueCount = issues.reduce((sum, i) => sum + i.issues.length, 0);
            const completionPct = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

            // Tasks due this week
            const tasksDueThisWeek = projectData.filter(t => {
                if (t.status === 'done' || t.status === 'postmvp') return false;
                if (!t.anticipatedEnd) return false;
                return t.anticipatedEnd >= today && t.anticipatedEnd <= weekFromNow;
            }).sort((a, b) => a.anticipatedEnd - b.anticipatedEnd);

            // Overdue tasks
            const overdueTasks = projectData.filter(t => {
                if (t.status === 'done' || t.status === 'postmvp') return false;
                if (!t.anticipatedEnd) return false;
                return t.anticipatedEnd < today;
            }).sort((a, b) => a.anticipatedEnd - b.anticipatedEnd);

            // Tasks with date slippage
            const slippedTasks = projectData.filter(t => t.dateWasMoved && t.dateMovedDays > 0)
                .sort((a, b) => b.dateMovedDays - a.dateMovedDays);

            // Get risk radar data (top risks)
            const topRisks = getTopRiskTasks(5);

            // Critical dependency issues
            const criticalIssues = issues.filter(i =>
                i.issues.some(iss => iss.type === 'incomplete_dependency_past_due')
            );

            // Build Markdown summary
            let md = '';

            // Header
            const sheetName = document.getElementById('sheet-select').value || 'Project';
            md += `# üìä Project Status Summary\n\n`;
            md += `**${sheetName}** | Generated: ${today.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}\n\n`;

            // Executive Summary
            md += `## üìà Executive Summary\n\n`;
            md += `| Metric | Value |\n`;
            md += `|--------|-------|\n`;
            md += `| Progress | **${completionPct}%** (${completedTasks}/${totalTasks} tasks) |\n`;
            md += `| In Progress | ${wipTasks} tasks |\n`;
            md += `| Blocked | ${blockedTasks} tasks |\n`;
            md += `| Not Started | ${newTasks} tasks |\n`;
            md += `| Issues Found | ${issueCount} |\n\n`;

            // Critical Alerts (if any)
            if (overdueTasks.length > 0 || blockedTasks > 0 || criticalIssues.length > 0) {
                md += `## üö® Critical Alerts\n\n`;

                if (overdueTasks.length > 0) {
                    md += `### ‚è∞ Overdue Tasks (${overdueTasks.length})\n`;
                    overdueTasks.slice(0, 5).forEach(t => {
                        const daysOverdue = Math.ceil((today - t.anticipatedEnd) / (1000 * 60 * 60 * 24));
                        md += `- **${t.id}**: ${t.description.substring(0, 60)}${t.description.length > 60 ? '...' : ''} *(${daysOverdue}d overdue)*${t.owner ? ` ‚Äî ${t.owner}` : ''}\n`;
                    });
                    if (overdueTasks.length > 5) {
                        md += `- *...and ${overdueTasks.length - 5} more overdue tasks*\n`;
                    }
                    md += '\n';
                }

                if (blockedTasks > 0) {
                    const blocked = projectData.filter(t => t.status === 'blocked');
                    md += `### üõë Blocked Tasks (${blockedTasks})\n`;
                    blocked.slice(0, 5).forEach(t => {
                        md += `- **${t.id}**: ${t.description.substring(0, 60)}${t.description.length > 60 ? '...' : ''}${t.owner ? ` ‚Äî ${t.owner}` : ''}\n`;
                    });
                    if (blocked.length > 5) {
                        md += `- *...and ${blocked.length - 5} more blocked tasks*\n`;
                    }
                    md += '\n';
                }

                if (criticalIssues.length > 0) {
                    md += `### ‚ö†Ô∏è Dependency Issues (${criticalIssues.length})\n`;
                    criticalIssues.slice(0, 5).forEach(item => {
                        md += `- **${item.task.id}** depends on incomplete tasks past due date\n`;
                    });
                    if (criticalIssues.length > 5) {
                        md += `- *...and ${criticalIssues.length - 5} more dependency issues*\n`;
                    }
                    md += '\n';
                }
            }

            // This Week's Focus
            if (tasksDueThisWeek.length > 0) {
                md += `## üìÖ This Week's Focus (Due by ${weekFromNow.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })})\n\n`;
                tasksDueThisWeek.slice(0, 10).forEach(t => {
                    const statusIcon = t.status === 'wip' ? 'üîÑ' : t.status === 'new' ? 'üÜï' : t.status === 'blocked' ? 'üõë' : 'üìã';
                    const dueStr = formatDate(t.anticipatedEnd);
                    md += `- ${statusIcon} **${t.id}**: ${t.description.substring(0, 50)}${t.description.length > 50 ? '...' : ''} *(due ${dueStr})*${t.owner ? ` ‚Äî ${t.owner}` : ''}\n`;
                });
                if (tasksDueThisWeek.length > 10) {
                    md += `- *...and ${tasksDueThisWeek.length - 10} more tasks due this week*\n`;
                }
                md += '\n';
            }

            // Schedule Slippage
            if (slippedTasks.length > 0) {
                md += `## ‚è© Schedule Slippage\n\n`;
                md += `${slippedTasks.length} task(s) have been pushed back from their original dates:\n\n`;
                slippedTasks.slice(0, 5).forEach(t => {
                    md += `- **${t.id}**: +${t.dateMovedDays} days (now due ${formatDate(t.anticipatedEnd)})\n`;
                });
                if (slippedTasks.length > 5) {
                    md += `- *...and ${slippedTasks.length - 5} more tasks with date changes*\n`;
                }
                md += '\n';
            }

            // Top Risk Areas
            if (topRisks.length > 0) {
                md += `## üéØ Top Risk Areas\n\n`;
                md += `Tasks with highest downstream impact if delayed:\n\n`;
                topRisks.forEach((r, i) => {
                    md += `${i + 1}. **${r.task.id}** (Risk Score: ${r.riskScore}) ‚Äî ${r.task.description.substring(0, 40)}${r.task.description.length > 40 ? '...' : ''}\n`;
                    md += `   - ${r.downstreamCount} downstream tasks, ${r.criticalCount} critical if 3-day delay\n`;
                });
                md += '\n';
            }

            // Action Items
            md += `## ‚úÖ Recommended Actions\n\n`;

            if (overdueTasks.length > 0) {
                md += `1. **Address ${overdueTasks.length} overdue task(s)** - Prioritize completing or re-scheduling\n`;
            }
            if (blockedTasks > 0) {
                md += `${overdueTasks.length > 0 ? '2' : '1'}. **Unblock ${blockedTasks} blocked task(s)** - Identify and remove blockers\n`;
            }
            if (topRisks.length > 0) {
                const num = (overdueTasks.length > 0 ? 1 : 0) + (blockedTasks > 0 ? 1 : 0) + 1;
                md += `${num}. **Monitor high-risk tasks** - Keep close watch on: ${topRisks.slice(0, 3).map(r => r.task.id).join(', ')}\n`;
            }
            if (tasksDueThisWeek.length > 0) {
                const num = (overdueTasks.length > 0 ? 1 : 0) + (blockedTasks > 0 ? 1 : 0) + (topRisks.length > 0 ? 1 : 0) + 1;
                md += `${num}. **Focus on this week's ${tasksDueThisWeek.length} deliverables**\n`;
            }

            if (overdueTasks.length === 0 && blockedTasks === 0 && topRisks.length === 0 && tasksDueThisWeek.length === 0) {
                md += `- Project appears on track! Continue monitoring progress.\n`;
            }

            md += '\n---\n*Generated by Project Plan Analyzer*\n';

            return md;
        }

        function getTopRiskTasks(limit) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const taskMap = new Map(projectData.map(t => [t.id, t]));

            // Build reverse dependency map
            const reverseDeps = new Map();
            projectData.forEach(task => {
                task.dependencies.forEach(depId => {
                    if (!reverseDeps.has(depId)) {
                        reverseDeps.set(depId, []);
                    }
                    reverseDeps.get(depId).push(task.id);
                });
            });

            // Find all downstream tasks
            function countDownstream(taskId) {
                const visited = new Set([taskId]);
                const queue = [taskId];
                let count = 0;
                let criticalCount = 0;
                let atRiskCount = 0;

                while (queue.length > 0) {
                    const currentId = queue.shift();
                    const dependents = reverseDeps.get(currentId) || [];

                    dependents.forEach(depId => {
                        if (visited.has(depId)) return;
                        visited.add(depId);
                        count++;

                        const depTask = taskMap.get(depId);
                        if (depTask && depTask.anticipatedEnd) {
                            const daysToDeadline = Math.ceil((depTask.anticipatedEnd - today) / (1000 * 60 * 60 * 24));
                            const newWindow = daysToDeadline - 3; // 3-day delay simulation
                            const compressionPct = daysToDeadline > 0 ? Math.round((3 / daysToDeadline) * 100) : 100;

                            if (daysToDeadline <= 0 || newWindow <= 0 || compressionPct >= 50) {
                                criticalCount++;
                            } else if (compressionPct >= 25 || newWindow <= 5) {
                                atRiskCount++;
                            }
                        }

                        queue.push(depId);
                    });
                }

                return { count, criticalCount, atRiskCount };
            }

            // Analyze incomplete tasks
            const riskData = projectData
                .filter(t => t.status !== 'done' && t.status !== 'postmvp')
                .map(task => {
                    const downstream = countDownstream(task.id);

                    let riskScore = 0;
                    riskScore += downstream.criticalCount * 10;
                    riskScore += downstream.atRiskCount * 5;
                    riskScore += downstream.count * 2;

                    if (task.anticipatedEnd) {
                        const daysToDeadline = Math.ceil((task.anticipatedEnd - today) / (1000 * 60 * 60 * 24));
                        if (daysToDeadline <= 0) riskScore += 50;
                        else if (daysToDeadline <= 7) riskScore += 30;
                        else if (daysToDeadline <= 14) riskScore += 15;
                    }

                    if (task.status === 'blocked') riskScore += 40;
                    else if (task.status === 'new') riskScore += 10;

                    return {
                        task,
                        riskScore,
                        downstreamCount: downstream.count,
                        criticalCount: downstream.criticalCount,
                        atRiskCount: downstream.atRiskCount
                    };
                })
                .filter(r => r.riskScore > 0)
                .sort((a, b) => b.riskScore - a.riskScore);

            return riskData.slice(0, limit);
        }

        function showSummaryModal() {
            const summaryContent = generateSummaryContent();

            // Remove any existing modal
            const existingModal = document.getElementById('summary-modal');
            if (existingModal) existingModal.remove();
            const existingOverlay = document.getElementById('summary-modal-overlay');
            if (existingOverlay) existingOverlay.remove();

            const overlay = document.createElement('div');
            overlay.id = 'summary-modal-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.6);
                z-index: 999;
            `;

            const modal = document.createElement('div');
            modal.id = 'summary-modal';
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--bg-secondary);
                border: 1px solid var(--border);
                border-radius: 12px;
                padding: 24px;
                z-index: 1000;
                max-width: 700px;
                width: 95%;
                max-height: 85vh;
                display: flex;
                flex-direction: column;
                box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            `;

            modal.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <div>
                        <h2 class="text-xl font-bold" style="color: var(--accent);">üìã Project Summary</h2>
                        <p class="text-sm mt-1" style="color: var(--text-muted);">Markdown format ‚Äî ready to copy, paste, or print</p>
                    </div>
                    <button id="close-summary-modal" style="background: none; border: none; cursor: pointer; font-size: 24px; color: var(--text-muted); padding: 0 8px;">&times;</button>
                </div>

                <div style="flex: 1; overflow-y: auto; margin-bottom: 16px;">
                    <textarea id="summary-textarea" readonly style="
                        width: 100%;
                        min-height: 400px;
                        padding: 16px;
                        font-family: 'JetBrains Mono', monospace;
                        font-size: 13px;
                        line-height: 1.6;
                        background: var(--bg-tertiary);
                        color: var(--text-primary);
                        border: 1px solid var(--border);
                        border-radius: 8px;
                        resize: vertical;
                    ">${escapeHtml(summaryContent)}</textarea>
                </div>

                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button id="copy-summary-btn" class="px-5 py-2 rounded-lg font-medium" style="background: var(--accent); color: white; flex: 1; min-width: 150px;">
                        üìã Copy to Clipboard
                    </button>
                    <button id="print-summary-btn" class="px-5 py-2 rounded-lg font-medium" style="background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border); flex: 1; min-width: 150px;">
                        üñ®Ô∏è Print Summary
                    </button>
                </div>

                <p id="copy-feedback" class="text-sm mt-3 text-center hidden" style="color: var(--success);">‚úÖ Copied to clipboard!</p>
            `;

            document.body.appendChild(overlay);
            document.body.appendChild(modal);

            // Event handlers
            const closeModal = () => {
                modal.remove();
                overlay.remove();
            };

            modal.querySelector('#close-summary-modal').addEventListener('click', closeModal);
            overlay.addEventListener('click', closeModal);

            // Copy to clipboard
            modal.querySelector('#copy-summary-btn').addEventListener('click', async () => {
                const textarea = modal.querySelector('#summary-textarea');
                const feedback = modal.querySelector('#copy-feedback');

                try {
                    await navigator.clipboard.writeText(textarea.value);
                    feedback.classList.remove('hidden');
                    setTimeout(() => feedback.classList.add('hidden'), 2000);
                } catch (err) {
                    // Fallback for older browsers
                    textarea.select();
                    document.execCommand('copy');
                    feedback.classList.remove('hidden');
                    setTimeout(() => feedback.classList.add('hidden'), 2000);
                }
            });

            // Print summary
            modal.querySelector('#print-summary-btn').addEventListener('click', () => {
                const textarea = modal.querySelector('#summary-textarea');
                const printWindow = window.open('', '_blank');

                // Convert markdown to simple HTML for printing
                const htmlContent = convertMarkdownToHtml(textarea.value);

                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Project Summary</title>
                        <style>
                            body {
                                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                                max-width: 800px;
                                margin: 0 auto;
                                padding: 40px 20px;
                                line-height: 1.6;
                                color: #1a1a1a;
                            }
                            h1 { font-size: 24px; margin-bottom: 8px; }
                            h2 { font-size: 18px; margin-top: 24px; margin-bottom: 12px; border-bottom: 1px solid #ddd; padding-bottom: 4px; }
                            h3 { font-size: 15px; margin-top: 16px; margin-bottom: 8px; }
                            table { border-collapse: collapse; width: 100%; margin: 12px 0; }
                            th, td { border: 1px solid #ddd; padding: 8px 12px; text-align: left; }
                            th { background: #f5f5f5; }
                            ul { margin: 8px 0; padding-left: 24px; }
                            li { margin: 4px 0; }
                            strong { font-weight: 600; }
                            em { font-style: italic; color: #666; }
                            hr { border: none; border-top: 1px solid #ddd; margin: 24px 0; }
                            @media print {
                                body { padding: 20px; }
                            }
                        </style>
                    </head>
                    <body>${htmlContent}</body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.focus();

                // Trigger print after content loads
                setTimeout(() => {
                    printWindow.print();
                }, 250);
            });

            // Close on Escape key
            const escHandler = (e) => {
                if (e.key === 'Escape') {
                    closeModal();
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);
        }

        function convertMarkdownToHtml(markdown) {
            // Simple markdown to HTML conversion for printing
            let html = markdown;

            // Headers
            html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
            html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
            html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');

            // Bold
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

            // Italic
            html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');

            // Horizontal rule
            html = html.replace(/^---$/gm, '<hr>');

            // Tables
            const tableRegex = /\|(.+)\|\n\|[-| ]+\|\n((?:\|.+\|\n?)+)/g;
            html = html.replace(tableRegex, (match, headerRow, bodyRows) => {
                const headers = headerRow.split('|').filter(h => h.trim()).map(h => `<th>${h.trim()}</th>`).join('');
                const rows = bodyRows.trim().split('\n').map(row => {
                    const cells = row.split('|').filter(c => c.trim()).map(c => `<td>${c.trim()}</td>`).join('');
                    return `<tr>${cells}</tr>`;
                }).join('');
                return `<table><thead><tr>${headers}</tr></thead><tbody>${rows}</tbody></table>`;
            });

            // List items
            html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
            html = html.replace(/^(\d+)\. (.+)$/gm, '<li>$2</li>');

            // Wrap consecutive <li> in <ul>
            html = html.replace(/((?:<li>.+<\/li>\n?)+)/g, '<ul>$1</ul>');

            // Paragraphs (lines that aren't already wrapped)
            html = html.split('\n').map(line => {
                if (line.trim() && !line.startsWith('<')) {
                    return `<p>${line}</p>`;
                }
                return line;
            }).join('\n');

            return html;
        }

        // Resize handler
        window.addEventListener('resize', () => {
            if (projectData.length > 0) {
                const activeTab = document.querySelector('.tab-btn.active');
                if (activeTab && activeTab.dataset.tab === 'graph') {
                    renderGraph();
                }
            }
        });
    </script>
</body>
</html>
