<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Manager with Metadata</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/marked@4.2.2/marked.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    },
                },
            },
        };
    </script>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen transition-colors duration-200">
    <!-- Check for dark mode -->
    <script>
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>

    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-center text-primary">File Manager</h1>
            <div class="flex gap-2">
                <button id="apiHelpBtn" class="flex items-center bg-blue-100 dark:bg-blue-800 hover:bg-blue-200 dark:hover:bg-blue-700 rounded-lg px-3 py-2 text-sm transition-colors duration-200 text-blue-800 dark:text-blue-100">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    API Help
                </button>
                <button id="diagnosticsBtn" class="flex items-center bg-yellow-100 dark:bg-yellow-800 hover:bg-yellow-200 dark:hover:bg-yellow-700 rounded-lg px-3 py-2 text-sm transition-colors duration-200 text-yellow-800 dark:text-yellow-100">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    Diagnostics
                </button>
                <button id="settingsBtn" class="flex items-center bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg px-3 py-2 text-sm transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    Settings
                </button>
            </div>
        </div>
        
        <!-- Diagnostic Banner (conditionally shown) -->
        <div id="diagnosticBanner" class="hidden bg-yellow-50 dark:bg-yellow-900 border-l-4 border-yellow-400 p-4 mb-6 rounded">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-yellow-800 dark:text-yellow-100">
                        <strong>Connection issues detected.</strong> Use the diagnostics tool to troubleshoot connectivity problems.
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <!-- Download by SKU Section -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Download by SKU</h2>
            <div class="flex gap-2">
                <input type="text" id="downloadSkuInput" 
                    class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md 
                    bg-white dark:bg-gray-700 text-base" 
                    placeholder="Enter product SKU" />
                <button id="downloadSkuBtn" 
                    class="bg-primary hover:bg-opacity-90 text-white font-medium py-2 px-4 
                    rounded-md transition-colors duration-200">
                    Download
                </button>
            </div>
            <div id="skuDownloadStatus" class="mt-3 text-sm hidden"></div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Upload Section -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">Upload File</h2>
                
                <form id="uploadForm" class="space-y-4">
                    <!-- File Input -->
                    <div>
                        <label class="block text-sm font-medium mb-1">File</label>
                        <div class="relative">
                            <input type="file" id="fileInput" 
                                class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" 
                                required />
                            <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 text-center">
                                <span id="fileNameDisplay" class="text-gray-500 dark:text-gray-400">
                                    Click or drag file here
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Metadata Fields -->
                    <div>
                        <label for="title" class="block text-sm font-medium mb-1">Title</label>
                        <input type="text" id="title" name="title" 
                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md 
                            bg-white dark:bg-gray-700 text-base" 
                            placeholder="File title" />
                    </div>
                    
                    <div>
                        <label for="description" class="block text-sm font-medium mb-1">Description</label>
                        <textarea id="description" name="description" rows="2" 
                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md 
                            bg-white dark:bg-gray-700 text-base" 
                            placeholder="File description"></textarea>
                    </div>
                    
                    <div>
                        <label for="sku" class="block text-sm font-medium mb-1">SKU</label>
                        <input type="text" id="sku" name="sku" 
                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md 
                            bg-white dark:bg-gray-700 text-base" 
                            placeholder="Enter product SKU" />
                    </div>
                    
                    <div>
                        <label for="customerName" class="block text-sm font-medium mb-1">Customer Name</label>
                        <input type="text" id="customerName" name="customerName" 
                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md 
                            bg-white dark:bg-gray-700 text-base" 
                            placeholder="Enter customer name" />
                    </div>
                    
                    <div>
                        <label for="tags" class="block text-sm font-medium mb-1">Tags (comma separated)</label>
                        <input type="text" id="tags" name="tags" 
                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md 
                            bg-white dark:bg-gray-700 text-base" 
                            placeholder="tag1, tag2, tag3" />
                    </div>
                    
                    <button type="submit" 
                        class="w-full bg-primary hover:bg-opacity-90 text-white font-medium py-2 px-4 
                        rounded-md transition-colors duration-200">
                        Upload File
                    </button>
                </form>
            </div>
            
            <!-- Files List with Search -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">Files</h2>
                
                <!-- Search Bar -->
                <div class="mb-4">
                    <div class="relative">
                        <input type="text" id="searchInput" 
                            class="w-full px-3 py-2 pl-10 border border-gray-300 dark:border-gray-600 rounded-md 
                            bg-white dark:bg-gray-700 text-base" 
                            placeholder="Search files..." />
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </div>
                        <button id="searchButton" 
                            class="absolute inset-y-0 right-0 flex items-center px-3 rounded-r-md bg-primary text-white hover:bg-opacity-90">
                            Search
                        </button>
                    </div>
                </div>
                
                <div class="flex items-center justify-between mb-3">
                    <div class="text-sm text-gray-500 dark:text-gray-400" id="searchResultsInfo"></div>
                    <div class="flex gap-2">
                        <button id="clearSearchBtn" class="text-sm text-primary hover:underline hidden">
                            Clear Search
                        </button>
                        <button id="refreshFilesBtn" class="text-sm text-primary hover:underline">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            Refresh
                        </button>
                    </div>
                </div>
                
                <div id="filesList" class="space-y-3 max-h-[55vh] overflow-y-auto">
                    <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                        No files found
                    </div>
                </div>
            </div>
        </div>
        
        <!-- File Preview Modal -->
        <div id="filePreviewModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="previewTitle" class="text-xl font-semibold"></h3>
                        <button id="closePreviewBtn" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    
                    <div id="previewContent" class="mb-4">
                        <!-- File content will be displayed here -->
                    </div>
                    
                    <div id="previewMetadata" class="mb-4 border-t pt-4 dark:border-gray-700">
                        <!-- Metadata will be displayed here -->
                    </div>
                    
                    <div class="flex justify-end gap-2">
                        <button id="downloadBtn" class="bg-primary hover:bg-opacity-90 text-white font-medium py-2 px-4 rounded-md transition-colors duration-200">
                            Save File
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Settings Modal -->
        <div id="settingsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">API Settings</h3>
                        <button id="closeSettingsBtn" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    
                    <form id="settingsForm" class="space-y-4">
                        <div>
                            <label for="apiUrl" class="block text-sm font-medium mb-1">API URL</label>
                            <input type="url" id="apiUrl" name="apiUrl" 
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md 
                                bg-white dark:bg-gray-700 text-base" 
                                placeholder="https://your-worker.workers.dev" />
                        </div>
                        
                        <div>
                            <label for="username" class="block text-sm font-medium mb-1">Username</label>
                            <input type="text" id="username" name="username" 
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md 
                                bg-white dark:bg-gray-700 text-base" 
                                placeholder="admin" />
                        </div>
                        
                        <div>
                            <label for="password" class="block text-sm font-medium mb-1">Password</label>
                            <input type="password" id="password" name="password" 
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md 
                                bg-white dark:bg-gray-700 text-base" 
                                placeholder="your-secure-password" />
                        </div>
                        
                        <button type="submit" 
                            class="w-full bg-primary hover:bg-opacity-90 text-white font-medium py-2 px-4 
                            rounded-md transition-colors duration-200">
                            Save Settings
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Diagnostics Modal -->
        <div id="diagnosticsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-3xl w-full">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">Connection Diagnostics</h3>
                        <button id="closeDiagnosticsBtn" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    
                    <div class="mb-4">
                        <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">
                            This tool helps diagnose connection issues with your Cloudflare Worker. Run the tests to identify potential problems.
                        </p>
                        
                        <div class="flex gap-2 mb-6">
                            <button id="runDiagnosticsBtn" class="bg-primary hover:bg-opacity-90 text-white font-medium py-2 px-4 rounded-md transition-colors duration-200">
                                Run Diagnostics
                            </button>
                            <button id="testAlternativesBtn" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 font-medium py-2 px-4 rounded-md transition-colors duration-200">
                                Try Alternative Upload
                            </button>
                        </div>
                        
                        <div id="diagnosticsResults" class="space-y-4 max-h-[60vh] overflow-y-auto">
                            <!-- Diagnostics results will appear here -->
                            <div class="text-center text-gray-500 dark:text-gray-400">
                                Click "Run Diagnostics" to start testing your connection
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- API Help Modal -->
        <div id="apiHelpModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">API Usage Examples with cURL</h3>
                        <button id="closeApiHelpBtn" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    
                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">
                        Below are examples of how to interact with the Cloudflare Worker API using cURL commands for uploading, downloading, and searching files.
                    </p>
                    
                    <div class="space-y-6 max-h-[70vh] overflow-y-auto">
                        <!-- Upload File Example -->
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <h4 class="font-medium text-lg mb-2">Upload File</h4>
                            <p class="text-sm mb-2">This example shows how to upload a file with metadata using cURL:</p>
                            <div class="bg-gray-100 dark:bg-gray-800 p-3 rounded-md overflow-x-auto text-sm">
                                <pre><code class="language-bash">curl -X POST "https://your-worker.workers.dev/upload" \
    -u "username:password" \
    -F "file=@/path/to/your/file.jpg" \
    -F "title=My File Title" \
    -F "description=This is a description of my file" \
    -F "sku=PROD12345" \
    -F "customerName=ACME Corp" \
    -F "tags=tag1,tag2,tag3"</code></pre>
                            </div>
                            <p class="text-sm mt-2">
                                <strong>Note:</strong> Replace <code>your-worker.workers.dev</code>, <code>username</code>, <code>password</code>, and the file path with your actual values.
                            </p>
                        </div>
                        
                        <!-- Download File Example -->
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <h4 class="font-medium text-lg mb-2">Download File</h4>
                            <p class="text-sm mb-2">To download a file using its filename:</p>
                            <div class="bg-gray-100 dark:bg-gray-800 p-3 rounded-md overflow-x-auto text-sm">
                                <pre><code class="language-bash">curl -X GET "https://your-worker.workers.dev/images/filename.jpg" \
    -u "username:password" \
    --output downloaded_file.jpg</code></pre>
                            </div>
                            <p class="text-sm mt-2">
                                <strong>Note:</strong> Replace <code>filename.jpg</code> with the actual filename returned when you uploaded the file.
                            </p>
                        </div>
                        
                        <!-- Fetch File Metadata Example -->
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <h4 class="font-medium text-lg mb-2">Fetch File Metadata</h4>
                            <p class="text-sm mb-2">To get only the metadata for a file:</p>
                            <div class="bg-gray-100 dark:bg-gray-800 p-3 rounded-md overflow-x-auto text-sm">
                                <pre><code class="language-bash">curl -X GET "https://your-worker.workers.dev/images/filename.jpg?metadata=true" \
    -u "username:password"</code></pre>
                            </div>
                            <p class="text-sm mt-2">
                                This returns a JSON object containing the file's metadata without downloading the file content.
                            </p>
                        </div>
                        
                        <!-- Search Files Example -->
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <h4 class="font-medium text-lg mb-2">Search Files</h4>
                            <p class="text-sm mb-2">To search for files by keyword or metadata:</p>
                            <div class="bg-gray-100 dark:bg-gray-800 p-3 rounded-md overflow-x-auto text-sm">
                                <pre><code class="language-bash">curl -X GET "https://your-worker.workers.dev/search?q=searchterm" \
    -u "username:password"</code></pre>
                            </div>
                            <p class="text-sm mt-2">
                                <strong>Note:</strong> Replace <code>searchterm</code> with your search term. This will search in titles, descriptions, tags, and other metadata fields.
                            </p>
                        </div>
                        
                        <!-- Search by Customer Example -->
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <h4 class="font-medium text-lg mb-2">Search by Customer</h4>
                            <p class="text-sm mb-2">To search for files associated with a specific customer:</p>
                            <div class="bg-gray-100 dark:bg-gray-800 p-3 rounded-md overflow-x-auto text-sm">
                                <pre><code class="language-bash">curl -X GET "https://your-worker.workers.dev/search?q=customerName:ACME%20Corp" \
    -u "username:password"</code></pre>
                            </div>
                            <p class="text-sm mt-2">
                                This example shows how to search for files with a specific customer name. You can also search by SKU and other fields.
                            </p>
                        </div>
                        
                        <!-- Download by SKU Example -->
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <h4 class="font-medium text-lg mb-2">Download by SKU</h4>
                            <p class="text-sm mb-2">To download all files associated with a specific SKU:</p>
                            <div class="bg-gray-100 dark:bg-gray-800 p-3 rounded-md overflow-x-auto text-sm">
                                <pre><code class="language-bash">curl -X GET "https://your-worker.workers.dev/downloadBySKU?sku=PROD12345" \
    -u "username:password" \
    --output products_PROD12345.zip</code></pre>
                            </div>
                            <p class="text-sm mt-2">
                                This endpoint packages all files with the specified SKU into a zip archive and returns it for download.
                                Replace <code>PROD12345</code> with your actual product SKU.
                            </p>
                        </div>
                        
                        <!-- Authentication Tips -->
                        <div class="bg-blue-50 dark:bg-blue-900 border-l-4 border-blue-500 p-4 rounded-r-md">
                            <h4 class="font-medium text-lg mb-2">Authentication Notes</h4>
                            <p class="text-sm">
                                The API uses Basic Authentication. The <code>-u "username:password"</code> parameter in the examples above sends your credentials. 
                                Alternatively, you can use a Basic Auth header:
                            </p>
                            <div class="bg-gray-100 dark:bg-gray-800 p-3 rounded-md overflow-x-auto text-sm mt-2">
                                <pre><code class="language-bash">curl -X GET "https://your-worker.workers.dev/images/file.jpg" \
    -H "Authorization: Basic $(echo -n 'username:password' | base64)"</code></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Alternative Upload Modal -->
        <div id="altUploadModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">Alternative Upload Method</h3>
                        <button id="closeAltUploadBtn" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    
                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">
                        Try this simpler upload method with no metadata to see if the issue is with the file upload process itself.
                    </p>
                    
                    <form id="altUploadForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">File</label>
                            <div class="relative">
                                <input type="file" id="altFileInput" 
                                    class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" 
                                    required />
                                <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 text-center">
                                    <span id="altFileNameDisplay" class="text-gray-500 dark:text-gray-400">
                                        Click or drag file here
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <div id="altUploadStatus" class="text-sm"></div>
                        
                        <button type="submit" 
                            class="w-full bg-primary hover:bg-opacity-90 text-white font-medium py-2 px-4 
                            rounded-md transition-colors duration-200">
                            Upload File (Simple Mode)
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Default configuration for the Cloudflare Worker
        let apiSettings = {
            apiUrl: "https://image-uploader.philipp-koch.workers.dev",
            username: "",
            password: ""
        };
        
        // App state
        let uploadedFiles = [];
        let selectedFile = null;
        let settingsConfigured = false;
        let altSelectedFile = null;
        
        // Initialize diagnostic banner (hidden by default)
        const diagnosticBanner = document.getElementById('diagnosticBanner');
        
        // Function to check connection and show diagnostic banner only if needed
        // (We'll define this function now but use it after DOM elements are initialized)
        async function checkConnection() {
            // Only check if settings are configured
            if (!settingsConfigured) {
                return; // Don't show warning if settings aren't configured yet
            }
            
            try {
                // Try a simple OPTIONS request to check connectivity
                const response = await fetch(apiSettings.apiUrl, {
                    method: 'OPTIONS',
                    headers: {
                        'Authorization': 'Basic ' + btoa(`${apiSettings.username}:${apiSettings.password}`)
                    }
                });
                
                // If we get here, connection is working, keep banner hidden
                diagnosticBanner.classList.add('hidden');
            } catch (error) {
                // Connection issue detected, show the banner
                console.warn('Connection issue detected:', error);
                diagnosticBanner.classList.remove('hidden');
            }
        }
        
        // DOM elements
        const uploadForm = document.getElementById('uploadForm');
        const fileInput = document.getElementById('fileInput');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const filesList = document.getElementById('filesList');
        const filePreviewModal = document.getElementById('filePreviewModal');
        const previewTitle = document.getElementById('previewTitle');
        const previewContent = document.getElementById('previewContent');
        const previewMetadata = document.getElementById('previewMetadata');
        const closePreviewBtn = document.getElementById('closePreviewBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        
        // Download by SKU elements
        const downloadSkuInput = document.getElementById('downloadSkuInput');
        const downloadSkuBtn = document.getElementById('downloadSkuBtn');
        const skuDownloadStatus = document.getElementById('skuDownloadStatus');
        
        // Download by SKU event listener
        downloadSkuBtn.addEventListener('click', handleSkuDownload);
        
        // Handle download by SKU
        async function handleSkuDownload() {
            const sku = downloadSkuInput.value.trim();
            
            if (!sku) {
                alert('Please enter a SKU');
                return;
            }
            
            // Check if settings are configured
            if (!checkSettings()) {
                return;
            }
            
            // Show loading state
            skuDownloadStatus.innerHTML = `
                <div class="flex items-center text-gray-600 dark:text-gray-300">
                    <div class="inline-block animate-spin rounded-full h-4 w-4 border-t-2 border-b-2 border-primary mr-2"></div>
                    Downloading files for SKU: ${sku}...
                </div>
            `;
            skuDownloadStatus.classList.remove('hidden');
            
            try {
                // Create the download link
                const downloadUrl = `${apiSettings.apiUrl}/downloadBySKU?sku=${encodeURIComponent(sku)}`;
                
                // Open in new tab
                window.open(downloadUrl, '_blank');
                
                // Show success message
                skuDownloadStatus.innerHTML = `
                    <div class="flex items-center text-green-600 dark:text-green-400">
                        <svg class="h-5 w-5 mr-1 text-green-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                        </svg>
                        Download initiated. If prompted, please allow the download.
                    </div>
                `;
                
                // After 5 seconds, hide the status
                setTimeout(() => {
                    skuDownloadStatus.classList.add('hidden');
                }, 5000);
                
            } catch (error) {
                console.error('SKU download error:', error);
                
                // Show error
                skuDownloadStatus.innerHTML = `
                    <div class="flex items-start text-red-600 dark:text-red-400">
                        <svg class="h-5 w-5 mr-1 text-red-500 flex-shrink-0 mt-0.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                        </svg>
                        <div>
                            Download failed: ${error.message}
                        </div>
                    </div>
                `;
            }
        }
        
        // API Help elements
        const apiHelpBtn = document.getElementById('apiHelpBtn');
        const apiHelpModal = document.getElementById('apiHelpModal');
        const closeApiHelpBtn = document.getElementById('closeApiHelpBtn');
        
        // API Help modal event listeners
        apiHelpBtn.addEventListener('click', openApiHelp);
        closeApiHelpBtn.addEventListener('click', closeApiHelp);
        apiHelpModal.addEventListener('click', (e) => {
            if (e.target === apiHelpModal) {
                closeApiHelp();
            }
        });
        
        // Open API Help modal
        function openApiHelp() {
            apiHelpModal.classList.remove('hidden');
        }
        
        // Close API Help modal
        function closeApiHelp() {
            apiHelpModal.classList.add('hidden');
        }
        
        // Settings modal elements
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const settingsForm = document.getElementById('settingsForm');
        const closeSettingsBtn = document.getElementById('closeSettingsBtn');
        const apiUrlInput = document.getElementById('apiUrl');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        
        // Search elements
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const clearSearchBtn = document.getElementById('clearSearchBtn');
        const refreshFilesBtn = document.getElementById('refreshFilesBtn');
        const searchResultsInfo = document.getElementById('searchResultsInfo');
        
        // Diagnostics elements
        const diagnosticsBtn = document.getElementById('diagnosticsBtn');
        const diagnosticsModal = document.getElementById('diagnosticsModal');
        const closeDiagnosticsBtn = document.getElementById('closeDiagnosticsBtn');
        const runDiagnosticsBtn = document.getElementById('runDiagnosticsBtn');
        const testAlternativesBtn = document.getElementById('testAlternativesBtn');
        const diagnosticsResults = document.getElementById('diagnosticsResults');
        
        // Alternative upload elements
        const altUploadModal = document.getElementById('altUploadModal');
        const closeAltUploadBtn = document.getElementById('closeAltUploadBtn');
        const altUploadForm = document.getElementById('altUploadForm');
        const altFileInput = document.getElementById('altFileInput');
        const altFileNameDisplay = document.getElementById('altFileNameDisplay');
        const altUploadStatus = document.getElementById('altUploadStatus');
        
        // Event listeners
        fileInput.addEventListener('change', handleFileSelect);
        uploadForm.addEventListener('submit', handleUpload);
        closePreviewBtn.addEventListener('click', closePreview);
        downloadBtn.addEventListener('click', downloadFile);
        
        // Settings event listeners
        settingsBtn.addEventListener('click', openSettings);
        closeSettingsBtn.addEventListener('click', closeSettings);
        settingsForm.addEventListener('submit', saveSettings);
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                closeSettings();
            }
        });
        
        // Search event listeners
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
        searchButton.addEventListener('click', performSearch);
        clearSearchBtn.addEventListener('click', clearSearch);
        refreshFilesBtn.addEventListener('click', loadFiles);
        
        // Diagnostics event listeners
        diagnosticsBtn.addEventListener('click', openDiagnostics);
        closeDiagnosticsBtn.addEventListener('click', closeDiagnostics);
        runDiagnosticsBtn.addEventListener('click', runDiagnostics);
        testAlternativesBtn.addEventListener('click', openAltUpload);
        diagnosticsModal.addEventListener('click', (e) => {
            if (e.target === diagnosticsModal) {
                closeDiagnostics();
            }
        });
        
        // Alternative upload event listeners
        altFileInput.addEventListener('change', handleAltFileSelect);
        altUploadForm.addEventListener('submit', handleAltUpload);
        closeAltUploadBtn.addEventListener('click', closeAltUpload);
        altUploadModal.addEventListener('click', (e) => {
            if (e.target === altUploadModal) {
                closeAltUpload();
            }
        });
        
        // Update file name display when a file is selected
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                fileNameDisplay.textContent = file.name;
                selectedFile = file;
            } else {
                fileNameDisplay.textContent = 'Click or drag file here';
                selectedFile = null;
            }
        }
        
        // Settings functions
        function openSettings() {
            // Pre-fill the form with current settings
            apiUrlInput.value = apiSettings.apiUrl;
            usernameInput.value = apiSettings.username;
            passwordInput.value = apiSettings.password;
            
            // Show modal
            settingsModal.classList.remove('hidden');
        }
        
        function closeSettings() {
            settingsModal.classList.add('hidden');
        }
        
        function saveSettings(e) {
            e.preventDefault();
            
            // Get form values
            const newApiUrl = apiUrlInput.value.trim();
            const newUsername = usernameInput.value.trim();
            const newPassword = passwordInput.value;
            
            // Validate required fields
            if (!newApiUrl) {
                alert('API URL is required');
                return;
            }
            
            if (!newUsername) {
                alert('Username is required');
                return;
            }
            
            if (!newPassword) {
                alert('Password is required');
                return;
            }
            
            // Save settings
            apiSettings = {
                apiUrl: newApiUrl,
                username: newUsername,
                password: newPassword
            };
            
            settingsConfigured = true;
            
            // Close modal
            closeSettings();
            
            // Show confirmation
            alert('Settings saved successfully!');
            
            // Check the connection status after saving settings
            // Short delay to ensure the settings have been applied
            setTimeout(checkConnection, 500);
        }
        
        // Check if settings are configured
        function checkSettings() {
            if (!settingsConfigured) {
                alert('Please configure your API settings first');
                openSettings();
                return false;
            }
            return true;
        }
        
        // Handle file upload
        async function handleUpload(e) {
            e.preventDefault();
            
            // Check if settings are configured
            if (!checkSettings()) {
                return;
            }
            
            if (!selectedFile) {
                alert('Please select a file to upload');
                return;
            }
            
            // Get metadata from form
            const title = document.getElementById('title').value || selectedFile.name;
            const description = document.getElementById('description').value || '';
            const tagsString = document.getElementById('tags').value || '';
            const tags = tagsString.split(',').map(tag => tag.trim()).filter(Boolean);
            
            // Update UI to show upload in progress
            const submitBtn = uploadForm.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.textContent;
            submitBtn.textContent = 'Uploading...';
            submitBtn.disabled = true;
            
            try {
                // Log API details for debugging (without password)
                console.log(`Attempting to upload to: ${apiSettings.apiUrl}/upload`);
                console.log(`File size: ${formatFileSize(selectedFile.size)}, Type: ${selectedFile.type}`);
                
                // Create FormData for the upload
                const formData = new FormData();
                formData.append('file', selectedFile);
                formData.append('title', title);
                formData.append('description', description);
                
                // Add SKU metadata
                const sku = document.getElementById('sku').value.trim();
                if (sku) {
                    formData.append('sku', sku);
                }
                
                // Add customer name metadata
                const customerName = document.getElementById('customerName').value.trim();
                if (customerName) {
                    formData.append('customerName', customerName);
                }
                
                // Add tags as separate metadata fields
                if (tags.length > 0) {
                    formData.append('tags', tags.join(','));
                }
                
                // Enhanced error handling for the fetch operation
                let response;
                try {
                    // Upload to Cloudflare Worker using stored settings
                    response = await fetch(`${apiSettings.apiUrl}/upload`, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'Authorization': 'Basic ' + btoa(`${apiSettings.username}:${apiSettings.password}`)
                        },
                        // Adding longer timeout
                        timeout: 30000
                    });
                } catch (fetchError) {
                    console.error('Network error details:', fetchError);
                    
                    // Provide more specific error messages based on common issues
                    if (!navigator.onLine) {
                        throw new Error('You appear to be offline. Please check your internet connection.');
                    }
                    
                    // Check if URL is valid
                    try {
                        new URL(apiSettings.apiUrl);
                    } catch (urlError) {
                        throw new Error(`Invalid API URL: ${apiSettings.apiUrl}. Please check your settings.`);
                    }
                    
                    // If it's a CORS error, provide a helpful message
                    if (fetchError.message.includes('CORS') || fetchError.message.includes('cross-origin')) {
                        throw new Error('Cross-origin request blocked. The server may not allow requests from this domain.');
                    }
                    
                    // Generic network error with troubleshooting steps
                    throw new Error(`Network error: ${fetchError.message}. 
                    
Troubleshooting steps:
1. Verify the API URL in settings
2. Check if the server is running
3. Ensure no firewall is blocking the connection
4. Try again in a few minutes`);
                }
                
                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('Authentication failed. Please check your username and password in settings.');
                    } else if (response.status === 404) {
                        throw new Error('API endpoint not found. Please verify the API URL in settings.');
                    } else {
                        const errorText = await response.text();
                        throw new Error(`HTTP error ${response.status}: ${errorText}`);
                    }
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error('Upload failed on server');
                }
                
                // Add file to our list with the server data
                const fileObject = {
                    file: selectedFile,
                    filename: result.filename,
                    url: result.url,
                    type: selectedFile.type,
                    size: selectedFile.size,
                    uploadedAt: new Date().toISOString(),
                    metadata: result.metadata
                };
                
                // Add to our local list
                uploadedFiles.push(fileObject);
                
                // Update UI
                loadFiles(); // Fetch the full list from server
                resetUploadForm();
                
                // Show success message
                alert('File uploaded successfully!');
            } catch (error) {
                console.error('Upload error:', error);
                alert(`Upload failed: ${error.message}`);
            } finally {
                // Restore button state
                submitBtn.textContent = originalBtnText;
                submitBtn.disabled = false;
            }
        }
        
        // Reset upload form after successful upload
        function resetUploadForm() {
            uploadForm.reset();
            fileNameDisplay.textContent = 'Click or drag file here';
            selectedFile = null;
        }
        
        // Render the list of uploaded files
        function renderFilesList() {
            if (uploadedFiles.length === 0) {
                filesList.innerHTML = `
                    <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                        No files uploaded yet
                    </div>
                `;
                return;
            }
            
            filesList.innerHTML = '';
            
            uploadedFiles.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'bg-gray-50 dark:bg-gray-700 rounded-md p-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors duration-200';
                fileItem.innerHTML = `
                    <div class="flex items-center">
                        <div class="flex-shrink-0 text-gray-500 dark:text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                        </div>
                        <div class="ml-3 flex-1 overflow-hidden">
                            <div class="font-medium truncate">${file.metadata.title}</div>
                            <div class="text-sm text-gray-500 dark:text-gray-400 truncate">
                                ${formatFileSize(file.size)} • ${new Date(file.uploadedAt).toLocaleString()}
                            </div>
                        </div>
                    </div>
                `;
                fileItem.addEventListener('click', () => openPreview(file));
                filesList.appendChild(fileItem);
            });
        }
        
        // Load files from the server
        async function loadFiles() {
            filesList.innerHTML = `
                <div class="text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary"></div>
                    <div class="mt-2 text-gray-500 dark:text-gray-400">Loading files...</div>
                </div>
            `;
            
            // Clear search info
            searchResultsInfo.textContent = '';
            clearSearchBtn.classList.add('hidden');
            searchInput.value = '';
            
            try {
                // For demonstration purposes, we'll use our local list
                // In a production app, we would fetch from the server using a list endpoint
                // which is not provided in the current worker implementation
                renderFilesList();
            } catch (error) {
                console.error('Error loading files:', error);
                filesList.innerHTML = `
                    <div class="text-center text-red-500 dark:text-red-400 py-8">
                        Error loading files: ${error.message}
                    </div>
                `;
            }
        }
        
        // Search files
        async function performSearch() {
            const query = searchInput.value.trim();
            
            if (!query) {
                alert('Please enter a search term');
                return;
            }
            
            // Check if settings are configured
            if (!checkSettings()) {
                return;
            }
            
            // Show loading state
            filesList.innerHTML = `
                <div class="text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary"></div>
                    <div class="mt-2 text-gray-500 dark:text-gray-400">Searching...</div>
                </div>
            `;
            
            try {
                // Make request to search endpoint
                const response = await fetch(`${apiSettings.apiUrl}/search?q=${encodeURIComponent(query)}`, {
                    headers: {
                        'Authorization': 'Basic ' + btoa(`${apiSettings.username}:${apiSettings.password}`)
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('Authentication failed. Please check your username and password in settings.');
                    } else {
                        const errorText = await response.text();
                        throw new Error(`HTTP error ${response.status}: ${errorText}`);
                    }
                }
                
                const result = await response.json();
                const files = result.results || [];
                
                // Update UI with search results
                if (files.length === 0) {
                    filesList.innerHTML = `
                        <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                            No files found matching "${query}"
                        </div>
                    `;
                } else {
                    filesList.innerHTML = '';
                    
                    // Create a file item for each result
                    files.forEach(file => {
                        const fileItem = document.createElement('div');
                        fileItem.className = 'bg-gray-50 dark:bg-gray-700 rounded-md p-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors duration-200';
                        
                        // Get the title from metadata, or fall back to filename
                        const title = file.metadata.title || file.filename;
                        
                        // Get uploaded date and file size
                        const uploadedDate = file.metadata.uploadedAt 
                            ? new Date(file.metadata.uploadedAt).toLocaleString() 
                            : 'Unknown date';
                        
                        const fileSize = file.metadata.size 
                            ? formatFileSize(file.metadata.size) 
                            : 'Unknown size';
                        
                        fileItem.innerHTML = `
                            <div class="flex items-center">
                                <div class="flex-shrink-0 text-gray-500 dark:text-gray-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                </div>
                                <div class="ml-3 flex-1 overflow-hidden">
                                    <div class="font-medium truncate">${title}</div>
                                    <div class="text-sm text-gray-500 dark:text-gray-400 truncate">
                                        ${fileSize} • ${uploadedDate}
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // Create a file object that matches the structure our openPreview function expects
                        const fileObject = {
                            filename: file.filename,
                            url: file.url,
                            type: file.metadata.contentType || 'application/octet-stream',
                            size: file.metadata.size || 0,
                            uploadedAt: file.metadata.uploadedAt || new Date().toISOString(),
                            metadata: file.metadata,
                            serverMetadataFetched: true  // We already have the full metadata from the search
                        };
                        
                        fileItem.addEventListener('click', () => openPreview(fileObject));
                        filesList.appendChild(fileItem);
                    });
                }
                
                // Update search results info
                searchResultsInfo.textContent = `Found ${files.length} file${files.length !== 1 ? 's' : ''} matching "${query}"`;
                clearSearchBtn.classList.remove('hidden');
                
            } catch (error) {
                console.error('Search error:', error);
                filesList.innerHTML = `
                    <div class="text-center text-red-500 dark:text-red-400 py-8">
                        Error searching files: ${error.message}
                    </div>
                `;
                searchResultsInfo.textContent = '';
            }
        }
        
        // Clear search results and return to the regular file list
        function clearSearch() {
            loadFiles();
        }
        
        // Open file preview modal
        async function openPreview(file) {
            previewTitle.textContent = file.metadata.title || file.filename;
            
            // Show loading state
            previewContent.innerHTML = `
                <div class="text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary"></div>
                    <div class="mt-2 text-gray-500 dark:text-gray-400">Loading content...</div>
                </div>
            `;
            
            // Fetch metadata from server if we don't have full details
            try {
                let fileMetadata = file.metadata;
                let fileUrl;
                
                // If we don't have complete metadata or the file was just uploaded, fetch it
                if (!file.serverMetadataFetched && settingsConfigured) {
                    try {
                        const metadataResponse = await fetch(`${apiSettings.apiUrl}/images/${file.filename}?metadata=true`, {
                            headers: {
                                'Authorization': 'Basic ' + btoa(`${apiSettings.username}:${apiSettings.password}`)
                            }
                        });
                        
                        if (metadataResponse.ok) {
                            const metadataResult = await metadataResponse.json();
                            fileMetadata = metadataResult.metadata;
                            file.serverMetadataFetched = true;
                            file.metadata = fileMetadata;
                        }
                    } catch (metadataError) {
                        console.warn('Could not fetch metadata, using local data:', metadataError);
                    }
                }
                
                // Get full URL to file based on current settings
                fileUrl = `${apiSettings.apiUrl}/images/${file.filename}`;
                
                // Display file content based on type
                if (file.type.startsWith('image/')) {
                    previewContent.innerHTML = `
                        <img src="${fileUrl}" alt="${fileMetadata.title || file.filename}" 
                            class="max-w-full h-auto rounded-md" />
                    `;
                } else if (file.type.startsWith('video/')) {
                    previewContent.innerHTML = `
                        <video src="${fileUrl}" controls class="max-w-full h-auto rounded-md"></video>
                    `;
                } else if (file.type.startsWith('audio/')) {
                    previewContent.innerHTML = `
                        <audio src="${fileUrl}" controls class="w-full"></audio>
                    `;
                } else {
                    previewContent.innerHTML = `
                        <div class="bg-gray-100 dark:bg-gray-700 rounded-md p-4 text-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-500 dark:text-gray-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <div class="font-medium">${file.filename}</div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">${file.type}</div>
                            <a href="${fileUrl}" target="_blank" class="mt-3 inline-block text-primary hover:underline">
                                View or download file
                            </a>
                        </div>
                    `;
                }
            
            // Display metadata
            let metadataHTML = `
                <h4 class="font-medium mb-2">File Metadata</h4>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">
                    <div><span class="font-medium">Filename:</span> ${file.filename}</div>
                    <div><span class="font-medium">Size:</span> ${formatFileSize(file.size)}</div>
                    <div><span class="font-medium">Type:</span> ${file.type}</div>
                    <div><span class="font-medium">Uploaded:</span> ${new Date(file.uploadedAt).toLocaleString()}</div>
                </div>
            `;
            
            if (file.metadata.description) {
                metadataHTML += `
                    <div class="mt-2">
                        <span class="font-medium">Description:</span> 
                        <p class="mt-1">${file.metadata.description}</p>
                    </div>
                `;
            }
            
            if (fileMetadata.tags) {
                // Handle different formats of tags (string or array)
                let tagsList = [];
                if (typeof fileMetadata.tags === 'string') {
                    tagsList = fileMetadata.tags.split(',').map(tag => tag.trim()).filter(Boolean);
                } else if (Array.isArray(fileMetadata.tags)) {
                    tagsList = fileMetadata.tags;
                }
                
                if (tagsList.length > 0) {
                    metadataHTML += `
                        <div class="mt-2">
                            <span class="font-medium">Tags:</span> 
                            <div class="flex flex-wrap gap-1 mt-1">
                                ${tagsList.map(tag => `
                                    <span class="bg-primary bg-opacity-10 text-primary text-xs px-2 py-1 rounded-full">
                                        ${tag}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            }
            
            // Add any other metadata fields from the server
            const excludedMetadataKeys = ['title', 'description', 'tags', 'originalFilename', 'contentType', 'size'];
            const otherMetadata = Object.entries(fileMetadata)
                .filter(([key]) => !excludedMetadataKeys.includes(key))
                .filter(([_, value]) => value !== undefined && value !== null);
            
            if (otherMetadata.length > 0) {
                metadataHTML += `
                    <div class="mt-3 pt-2 border-t dark:border-gray-700">
                        <span class="font-medium">Additional Metadata:</span>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mt-1 text-sm">
                            ${otherMetadata.map(([key, value]) => `
                                <div><span class="font-medium">${key}:</span> ${value}</div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            previewMetadata.innerHTML = metadataHTML;
            
            // Set current file for download
            downloadBtn.dataset.filename = file.filename;
            
            // Show modal
            filePreviewModal.classList.remove('hidden');
            } catch (error) {
                console.error('Error loading preview:', error);
                previewContent.innerHTML = `
                    <div class="text-center text-red-500 py-8">
                        Error loading file: ${error.message}
                    </div>
                `;
            }
        }
        
        // Close file preview modal
        function closePreview() {
            filePreviewModal.classList.add('hidden');
        }
        
        // Download file functionality
        function downloadFile() {
            const filename = downloadBtn.dataset.filename;
            if (!filename) return;
            
            // Create a direct download link to the Cloudflare Worker using the current settings
            const fileUrl = `${apiSettings.apiUrl}/images/${filename}`;
            
            // Open in new tab
            window.open(fileUrl, '_blank');
            
            // Instruct user how to save
            setTimeout(() => {
                alert("To save the file: After the file opens in a new tab, right-click and select 'Save as...' or press Ctrl+S/Cmd+S");
            }, 500);
        }
        
        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // ==================== DIAGNOSTICS FUNCTIONS ====================
        
        // Open diagnostics modal
        function openDiagnostics() {
            diagnosticsModal.classList.remove('hidden');
        }
        
        // Close diagnostics modal
        function closeDiagnostics() {
            diagnosticsModal.classList.add('hidden');
        }
        
        // Run connection diagnostics
        async function runDiagnostics() {
            if (!checkSettings()) {
                closeDiagnostics();
                return;
            }
            
            // Reset and show loading state
            diagnosticsResults.innerHTML = `
                <div class="text-center py-4">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary"></div>
                    <div class="mt-2 text-gray-500 dark:text-gray-400">Running diagnostics...</div>
                </div>
            `;
            
            const results = [];
            
            // Check 1: Network connectivity
            results.push({
                name: 'Network Connectivity',
                status: navigator.onLine ? 'success' : 'error',
                message: navigator.onLine ? 'Your device is connected to the internet.' : 'Your device appears to be offline. Please check your internet connection.'
            });
            
            // Check 2: API URL format
            let validUrl = false;
            try {
                new URL(apiSettings.apiUrl);
                validUrl = true;
                results.push({
                    name: 'API URL Format',
                    status: 'success',
                    message: 'API URL is properly formatted.'
                });
            } catch (e) {
                results.push({
                    name: 'API URL Format',
                    status: 'error',
                    message: `API URL is not valid: ${e.message}`
                });
            }
            
            // Only continue with further tests if the URL is valid
            if (validUrl) {
                // Check 3: Basic API connectivity (OPTIONS request to check CORS)
                try {
                    const optionsResponse = await fetch(apiSettings.apiUrl, {
                        method: 'OPTIONS',
                        headers: {
                            'Authorization': 'Basic ' + btoa(`${apiSettings.username}:${apiSettings.password}`)
                        }
                    }).catch(error => {
                        throw new Error(`CORS preflight failed: ${error.message}`);
                    });
                    
                    results.push({
                        name: 'CORS Configuration',
                        status: 'success',
                        message: 'CORS preflight check passed. Your browser can communicate with the API.'
                    });
                } catch (error) {
                    results.push({
                        name: 'CORS Configuration',
                        status: 'error',
                        message: `CORS preflight check failed: ${error.message}. This usually means the server doesn't allow requests from this origin.`
                    });
                }
                
                // Check 4: Authentication
                try {
                    // Try a simple GET request to check auth
                    const authResponse = await fetch(`${apiSettings.apiUrl}/images/test-auth`, {
                        headers: {
                            'Authorization': 'Basic ' + btoa(`${apiSettings.username}:${apiSettings.password}`)
                        }
                    });
                    
                    if (authResponse.status === 401) {
                        results.push({
                            name: 'Authentication',
                            status: 'error',
                            message: 'Authentication failed. Please check your username and password in settings.'
                        });
                    } else if (authResponse.status === 404) {
                        // 404 is actually good here - it means we authenticated but the test file doesn't exist
                        results.push({
                            name: 'Authentication',
                            status: 'success',
                            message: 'Authentication successful.'
                        });
                    } else {
                        results.push({
                            name: 'Authentication',
                            status: 'warning',
                            message: `Unexpected response (${authResponse.status}) during authentication check.`
                        });
                    }
                } catch (error) {
                    results.push({
                        name: 'Authentication',
                        status: 'error',
                        message: `Authentication check failed: ${error.message}`
                    });
                }
            }
            
            // Check 5: Browser security settings
            const thirdPartyCookiesBlocked = !navigator.cookieEnabled;
            results.push({
                name: 'Browser Security',
                status: thirdPartyCookiesBlocked ? 'warning' : 'success',
                message: thirdPartyCookiesBlocked ? 
                    'Cookies appear to be disabled in your browser, which might affect some functionality.' : 
                    'Browser security settings look good.'
            });
            
            // Create summary of findings
            let diagnosisSummary = '';
            const errorCount = results.filter(r => r.status === 'error').length;
            const warningCount = results.filter(r => r.status === 'warning').length;
            
            if (errorCount > 0) {
                diagnosisSummary = `
                    <div class="bg-red-50 dark:bg-red-900 border-l-4 border-red-500 p-4 mb-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-red-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-red-800 dark:text-red-200">Connectivity Issues Detected</h3>
                                <div class="mt-2 text-sm text-red-700 dark:text-red-300">
                                    <p>Diagnostic found ${errorCount} critical issues that need to be resolved.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (warningCount > 0) {
                diagnosisSummary = `
                    <div class="bg-yellow-50 dark:bg-yellow-900 border-l-4 border-yellow-500 p-4 mb-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-yellow-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-yellow-800 dark:text-yellow-200">Potential Issues Detected</h3>
                                <div class="mt-2 text-sm text-yellow-700 dark:text-yellow-300">
                                    <p>Diagnostic found ${warningCount} potential issues that might affect connectivity.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                diagnosisSummary = `
                    <div class="bg-green-50 dark:bg-green-900 border-l-4 border-green-500 p-4 mb-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-green-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-green-800 dark:text-green-200">All Tests Passed</h3>
                                <div class="mt-2 text-sm text-green-700 dark:text-green-300">
                                    <p>Diagnostic found no connectivity issues. If you're still experiencing problems, try the alternative upload method.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Render detailed results
            let resultsHTML = '';
            results.forEach(result => {
                const statusColor = result.status === 'success' ? 'green' : (result.status === 'warning' ? 'yellow' : 'red');
                const statusIcon = result.status === 'success' ? `
                    <svg class="h-5 w-5 text-green-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                ` : (result.status === 'warning' ? `
                    <svg class="h-5 w-5 text-yellow-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                ` : `
                    <svg class="h-5 w-5 text-red-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                `);
                
                resultsHTML += `
                    <div class="bg-white dark:bg-gray-700 shadow rounded-lg p-4 mb-4">
                        <div class="flex items-start">
                            <div class="flex-shrink-0 mt-0.5">
                                ${statusIcon}
                            </div>
                            <div class="ml-3 w-full">
                                <h3 class="text-sm font-medium">${result.name}</h3>
                                <p class="mt-1 text-sm text-gray-600 dark:text-gray-300">${result.message}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // Render summary and detailed results
            diagnosticsResults.innerHTML = diagnosisSummary + resultsHTML;
            
            // If there are errors, suggest trying the alternative upload
            if (errorCount > 0) {
                diagnosticsResults.innerHTML += `
                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border border-gray-200 dark:border-gray-600">
                        <h3 class="text-lg font-medium mb-2">Next Steps</h3>
                        <p class="mb-3">Since there are connectivity issues, you can try:</p>
                        <ol class="list-decimal list-inside space-y-1 mb-3">
                            <li>Double-check your API URL, username, and password in Settings</li>
                            <li>Make sure your Cloudflare Worker is properly configured and running</li>
                            <li>Try the alternative upload method which uses a simpler approach</li>
                        </ol>
                        <button id="diagAltUploadBtn" class="bg-primary hover:bg-opacity-90 text-white font-medium py-2 px-4 rounded-md transition-colors duration-200">
                            Try Alternative Upload
                        </button>
                    </div>
                `;
                
                // Add event listener to the button in diagnostics results
                document.getElementById('diagAltUploadBtn').addEventListener('click', () => {
                    closeDiagnostics();
                    openAltUpload();
                });
            }
        }
        
        // ==================== ALTERNATIVE UPLOAD FUNCTIONS ====================
        
        // Open alternative upload modal
        function openAltUpload() {
            // Check if settings are configured
            if (!checkSettings()) {
                return;
            }
            
            altUploadModal.classList.remove('hidden');
        }
        
        // Close alternative upload modal
        function closeAltUpload() {
            altUploadModal.classList.add('hidden');
        }
        
        // Update alternative file input display
        function handleAltFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                altFileNameDisplay.textContent = file.name;
                altSelectedFile = file;
            } else {
                altFileNameDisplay.textContent = 'Click or drag file here';
                altSelectedFile = null;
            }
        }
        
        // Handle alternative upload with simpler approach
        async function handleAltUpload(e) {
            e.preventDefault();
            
            if (!altSelectedFile) {
                alert('Please select a file to upload');
                return;
            }
            
            // Update UI
            const submitBtn = altUploadForm.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.textContent;
            submitBtn.textContent = 'Uploading...';
            submitBtn.disabled = true;
            
            altUploadStatus.className = 'text-sm text-gray-600 dark:text-gray-300 mt-2';
            altUploadStatus.textContent = 'Uploading file...';
            
            try {
                // Create FormData for the simplified upload
                const formData = new FormData();
                formData.append('file', altSelectedFile);
                formData.append('title', altSelectedFile.name);
                
                // Still add the SKU if available (from the main form)
                const sku = document.getElementById('sku').value.trim();
                if (sku) {
                    formData.append('sku', sku);
                }
                
                // Add customer name if available (from the main form)
                const customerName = document.getElementById('customerName').value.trim();
                if (customerName) {
                    formData.append('customerName', customerName);
                }
                
                // Try a simplified fetch
                const fetchResponse = await fetch(`${apiSettings.apiUrl}/upload`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Authorization': 'Basic ' + btoa(`${apiSettings.username}:${apiSettings.password}`)
                    }
                });
                
                if (!fetchResponse.ok) {
                    throw new Error(`Error: ${fetchResponse.status} ${fetchResponse.statusText}`);
                }
                
                const responseData = await fetchResponse.json();
                
                // Show success
                altUploadStatus.className = 'text-sm text-green-600 dark:text-green-400 mt-2';
                altUploadStatus.innerHTML = `
                    <div class="flex items-center">
                        <svg class="h-5 w-5 mr-1 text-green-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                        </svg>
                        Upload successful! File ID: ${responseData.filename}
                    </div>
                `;
                
                // Add to our list of files
                const fileObject = {
                    filename: responseData.filename,
                    url: responseData.url,
                    type: altSelectedFile.type,
                    size: altSelectedFile.size,
                    uploadedAt: new Date().toISOString(),
                    metadata: responseData.metadata
                };
                
                uploadedFiles.push(fileObject);
                
                // Reset alt upload form but leave the modal open with success message
                altFileInput.value = '';
                altFileNameDisplay.textContent = 'Click or drag file here';
                altSelectedFile = null;
                
            } catch (error) {
                console.error('Alternative upload error:', error);
                
                // Show error
                altUploadStatus.className = 'text-sm text-red-600 dark:text-red-400 mt-2';
                altUploadStatus.innerHTML = `
                    <div class="flex items-start">
                        <svg class="h-5 w-5 mr-1 text-red-500 flex-shrink-0 mt-0.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                        </svg>
                        <div>
                            Upload failed: ${error.message}
                            <p class="mt-1 text-xs">This suggests there may be fundamental connectivity issues with the worker. Please verify your Cloudflare Worker is properly configured and running.</p>
                        </div>
                    </div>
                `;
            } finally {
                // Restore button
                submitBtn.textContent = originalBtnText;
                submitBtn.disabled = false;
            }
        }
        
        // Initialize the UI
        loadFiles();
        
        // Check the connection when the app loads
        // We do this with a slight delay to ensure the UI is fully loaded first
        setTimeout(checkConnection, 1000);
        
        // Close modals when clicking outside
        filePreviewModal.addEventListener('click', (e) => {
            if (e.target === filePreviewModal) {
                closePreview();
            }
        });
        
        // Add a refresh button
        const filesHeader = document.querySelector('.bg-white.dark\\:bg-gray-800 h2');
        const refreshButton = document.createElement('button');
        refreshButton.className = 'ml-2 text-sm text-primary hover:text-primary-dark';
        refreshButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            Refresh
        `;
        refreshButton.addEventListener('click', loadFiles);
        filesHeader.appendChild(refreshButton);
    </script>
</body>
</html>
